"use strict";import Axis from"../Core/Axis/Axis.js";import BaseSeries from"../Core/Series/Series.js";var seriesTypes=BaseSeries.seriesTypes;import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import Point from"../Core/Series/Point.js";import StackItem from"../Extensions/Stacking.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick;import"../Core/Options.js";import"./ColumnSeries.js";var WaterfallAxis,Series=H.Series;function ownProp(t,e){return Object.hasOwnProperty.call(t,e)}!function(t){var e=function(){function t(t){this.axis=t,this.stacks={changed:!1}}return t.prototype.renderStackTotals=function(){var t=this.axis,e=t.waterfall.stacks,a=t.stacking&&t.stacking.stackTotalGroup,s=new StackItem(t,t.options.stackLabels,!1,0,void 0);this.dummyStackItem=s,objectEach(e,function(t){objectEach(t,function(t){s.total=t.stackTotal,t.label&&(s.label=t.label),StackItem.prototype.render.call(s,a),t.label=s.label,delete s.label})}),s.total=null},t}();function a(){var t=this.waterfall.stacks;t&&(t.changed=!1,delete t.alreadyChanged)}function s(){var t=this.options.stackLabels;t&&t.enabled&&this.waterfall.stacks&&this.waterfall.renderStackTotals()}function i(){for(var t=this.axes,e=this.series,a=e.length;a--;)e[a].options.stacking&&(t.forEach(function(t){t.isXAxis||(t.waterfall.stacks.changed=!0)}),a=0)}function o(){this.waterfall||(this.waterfall=new e(this))}t.Composition=e,t.compose=function(t,e){addEvent(t,"init",o),addEvent(t,"afterBuildStacks",a),addEvent(t,"afterRender",s),addEvent(e,"beforeRedraw",i)}}(WaterfallAxis||(WaterfallAxis={})),BaseSeries.seriesType("waterfall","column",{dataLabels:{inside:!0},lineWidth:1,lineColor:"#333333",dashStyle:"Dot",borderColor:"#333333",states:{hover:{lineWidthPlus:0}}},{pointValKey:"y",showLine:!0,generatePoints:function(){var t,e,a,s;for(seriesTypes.column.prototype.generatePoints.apply(this),a=0,e=this.points.length;a<e;a++)t=this.points[a],s=this.processedYData[a],(t.isIntermediateSum||t.isSum)&&(t.y=correctFloat(s))},translate:function(){var t,e,a,s,i,o,r,n,l,h,c,d,p,u,g,m,f,y=this.options,k=this.yAxis,S=pick(y.minPointLength,5),b=S/2,x=y.threshold,v=y.stacking,P=k.waterfall.stacks[this.stackKey];for(seriesTypes.column.prototype.translate.apply(this),n=l=x,e=0,t=(a=this.points).length;e<t;e++)s=a[e],r=this.processedYData[e],i=s.shapeArgs,h=[0,r],g=s.y,v?(P&&(d=P[e],"overlap"===v?(u=d.stackState[d.stateIndex--],o=g>=0?u:u-g,ownProp(d,"absolutePos")&&delete d.absolutePos,ownProp(d,"absoluteNeg")&&delete d.absoluteNeg):(g>=0?(u=d.threshold+d.posTotal,d.posTotal-=g,o=u):(u=d.threshold+d.negTotal,d.negTotal-=g,o=u-g),d.posTotal||ownProp(d,"absolutePos")&&(d.posTotal=d.absolutePos,delete d.absolutePos),d.negTotal||ownProp(d,"absoluteNeg")&&(d.negTotal=d.absoluteNeg,delete d.absoluteNeg)),s.isSum||(d.connectorThreshold=d.threshold+d.stackTotal),k.reversed?(m=g>=0?o-g:o+g,f=o):(m=o,f=o-g),s.below=m<=pick(x,0),i.y=k.translate(m,0,1,0,1),i.height=Math.abs(i.y-k.translate(f,0,1,0,1))),(p=k.waterfall.dummyStackItem)&&(p.x=e,p.label=P[e].label,p.setOffset(this.pointXOffset||0,this.barW||0,this.stackedYNeg[e],this.stackedYPos[e]))):(o=Math.max(n,n+g)+h[0],i.y=k.translate(o,0,1,0,1),s.isSum?(i.y=k.translate(h[1],0,1,0,1),i.height=Math.min(k.translate(h[0],0,1,0,1),k.len)-i.y):s.isIntermediateSum?(g>=0?(m=h[1]+l,f=l):(m=l,f=h[1]+l),k.reversed&&(m^=f,m^=f^=m),i.y=k.translate(m,0,1,0,1),i.height=Math.abs(i.y-Math.min(k.translate(f,0,1,0,1),k.len)),l+=h[1]):(i.height=r>0?k.translate(n,0,1,0,1)-i.y:k.translate(n,0,1,0,1)-k.translate(n-r,0,1,0,1),n+=r,s.below=n<pick(x,0)),i.height<0&&(i.y+=i.height,i.height*=-1)),s.plotY=i.y=Math.round(i.y)-this.borderWidth%2/2,i.height=Math.max(Math.round(i.height),.001),s.yBottom=i.y+i.height,i.height<=S&&!s.isNull?(i.height=S,i.y-=b,s.plotY=i.y,s.y<0?s.minPointLengthOffset=-b:s.minPointLengthOffset=b):(s.isNull&&(i.width=0),s.minPointLengthOffset=0),c=s.plotY+(s.negative?i.height:0),this.chart.inverted?s.tooltipPos[0]=k.len-c:s.tooltipPos[1]=c},processData:function(t){var e,a,s,i,o,r,n,l=this.options,h=this.yData,c=l.data,d=h.length,p=l.threshold||0;for(s=a=i=o=0,n=0;n<d;n++)r=h[n],e=c&&c[n]?c[n]:{},"sum"===r||e.isSum?h[n]=correctFloat(s):"intermediateSum"===r||e.isIntermediateSum?(h[n]=correctFloat(a),a=0):(s+=r,a+=r),i=Math.min(s,i),o=Math.max(s,o);Series.prototype.processData.call(this,t),l.stacking||(this.dataMin=i+p,this.dataMax=o)},toYData:function(t){return t.isSum?"sum":t.isIntermediateSum?"intermediateSum":t.y},updateParallelArrays:function(t,e){Series.prototype.updateParallelArrays.call(this,t,e),"sum"!==this.yData[0]&&"intermediateSum"!==this.yData[0]||(this.yData[0]=null)},pointAttribs:function(t,e){var a,s=this.options.upColor;return s&&!t.options.color&&(t.color=t.y>0?s:null),delete(a=seriesTypes.column.prototype.pointAttribs.call(this,t,e)).dashstyle,a},getGraphPath:function(){return[["M",0,0]]},getCrispPath:function(){var t,e,a,s,i,o,r,n,l,h=this.data,c=this.yAxis,d=h.length,p=Math.round(this.graph.strokeWidth())%2/2,u=Math.round(this.borderWidth)%2/2,g=this.xAxis.reversed,m=this.yAxis.reversed,f=this.options.stacking,y=[];for(l=1;l<d;l++)n=h[l].shapeArgs,s=h[l-1],r=h[l-1].shapeArgs,e=c.waterfall.stacks[this.stackKey],o=s.y>0?-r.height:0,e&&r&&n&&(a=e[l-1],f?(t=a.connectorThreshold,i=Math.round(c.translate(t,0,1,0,1)+(m?o:0))-p):i=r.y+s.minPointLengthOffset+u-p,y.push(["M",(r.x||0)+(g?0:r.width||0),i],["L",(n.x||0)+(g&&n.width||0),i])),!f&&y.length&&r&&(s.y<0&&!m||s.y>0&&m)&&(y[y.length-2][2]+=r.height,y[y.length-1][2]+=r.height);return y},drawGraph:function(){Series.prototype.drawGraph.call(this),this.graph.attr({d:this.getCrispPath()})},setStackedPoints:function(){var t,e,a,s,i,o,r,n,l,h,c,d,p,u=this.options,g=this.yAxis.waterfall.stacks,m=u.threshold,f=m||0,y=f,k=this.stackKey,S=this.xData,b=S.length;function x(t,a,s,i){if(o)for(;s<o;s++)e.stackState[s]+=i;else e.stackState[0]=t,o=e.stackState.length;e.stackState.push(e.stackState[o-1]+a)}if(this.yAxis.stacking.usePercentage=!1,a=s=i=f,this.visible||!this.chart.options.chart.ignoreHiddenSeries){p=g.changed,(d=g.alreadyChanged)&&d.indexOf(k)<0&&(p=!0),g[k]||(g[k]={}),t=g[k];for(var v=0;v<b;v++)t[c=S[v]]&&!p||(t[c]={negTotal:0,posTotal:0,stackTotal:0,threshold:0,stateIndex:0,stackState:[],label:p&&t[c]?t[c].label:void 0}),e=t[c],(h=this.yData[v])>=0?e.posTotal+=h:e.negTotal+=h,l=u.data[v],r=e.absolutePos=e.posTotal,n=e.absoluteNeg=e.negTotal,e.stackTotal=r+n,o=e.stackState.length,l&&l.isIntermediateSum?(x(i,s,0,i),i=s,s=m,f^=y,f^=y^=f):l&&l.isSum?(x(m,a,o),f=m):(x(f,h,0,a),l&&(a+=h,s+=h)),e.stateIndex++,e.threshold=f,f+=e.stackTotal;g.changed=!1,g.alreadyChanged||(g.alreadyChanged=[]),g.alreadyChanged.push(k)}},getExtremes:function(){var t,e,a,s=this.options.stacking;return s?(t=this.yAxis.waterfall.stacks,e=this.stackedYNeg=[],a=this.stackedYPos=[],objectEach(t[this.stackKey],"overlap"===s?function(t){e.push(arrayMin(t.stackState)),a.push(arrayMax(t.stackState))}:function(t){e.push(t.negTotal+t.threshold),a.push(t.posTotal+t.threshold)}),{dataMin:arrayMin(e),dataMax:arrayMax(a)}):{dataMin:this.dataMin,dataMax:this.dataMax}}},{getClassName:function(){var t=Point.prototype.getClassName.call(this);return this.isSum?t+=" highcharts-sum":this.isIntermediateSum&&(t+=" highcharts-intermediate-sum"),t},isValid:function(){return isNumber(this.y)||this.isSum||Boolean(this.isIntermediateSum)}}),WaterfallAxis.compose(Axis,Chart);export default WaterfallAxis;