import Color from"../Core/Color/Color.js";var color=Color.parse;import H from"../Core/Globals.js";var charts=H.charts,RendererProto=H.Renderer.prototype;import Math3D from"../Extensions/Math3D.js";var perspective=Math3D.perspective;import Series from"../Core/Series/Series.js";var seriesTypes=Series.seriesTypes;import U from"../Core/Utilities.js";var funnel3dMethods,error=U.error,extend=U.extend,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,cuboidPath=RendererProto.cuboidPath;Series.seriesType("funnel3d","column",{center:["50%","50%"],width:"90%",neckWidth:"30%",height:"110%",neckHeight:"25%",reversed:!1,gradientForSides:!0,animation:!1,edgeWidth:0,colorByPoint:!0,showInLegend:!1,dataLabels:{align:"right",crop:!1,inside:!1,overflow:"allow"}},{bindAxes:function(){H.Series.prototype.bindAxes.apply(this,arguments),extend(this.xAxis.options,{gridLineWidth:0,lineWidth:0,title:null,tickPositions:[]}),extend(this.yAxis.options,{gridLineWidth:0,title:null,labels:{enabled:!1}})},translate3dShapes:H.noop,translate:function(){H.Series.prototype.translate.apply(this,arguments);var e,t,r,i,o,n,a,d,h,s=0,l=this.chart,p=this.options,g=p.reversed,c=p.ignoreHiddenPoint,f=l.plotWidth,u=l.plotHeight,y=0,m=p.center,x=relativeLength(m[0],f),w=relativeLength(m[1],u),b=relativeLength(p.width,f),v=relativeLength(p.height,u),L=relativeLength(p.neckWidth,f),C=relativeLength(p.neckHeight,u),U=w-v/2+v-C,k=this.data;this.getWidthAt=t=function(e){return e>U||v===C?L:L+(b-L)*(1-(e-(w-v/2))/(v-C))},this.center=[x,w,v],this.centerX=x,k.forEach(function(e){c&&!1===e.visible||(s+=e.y)}),k.forEach(function(f){a=null,r=s?f.y/s:0,n=(o=w-v/2+y*v)+r*v,e=t(o),d=n-o,h={gradientForSides:pick(f.options.gradientForSides,p.gradientForSides),x:x,y:o,height:d,width:e,z:1,top:{width:e}},e=t(n),h.bottom={fraction:r,width:e},o>=U?h.isCylinder=!0:n>U&&(a=n,e=t(U),n=U,h.bottom.width=e,h.middle={fraction:d?(U-o)/d:0,width:e}),g&&(h.y=o=w+v/2-(y+r)*v,h.middle&&(h.middle.fraction=1-(d?h.middle.fraction:0)),e=h.width,h.width=h.bottom.width,h.bottom.width=e),f.shapeArgs=extend(f.shapeArgs,h),f.percentage=110*r,f.plotX=x,f.plotY=g?w+v/2-(y+r/2)*v:(o+(a||n))/2,i=perspective([{x:x,y:f.plotY,z:g?-(b-t(f.plotY))/2:-t(f.plotY)/2}],l,!0)[0],f.tooltipPos=[i.x,i.y],f.dlBoxRaw={x:x,width:t(f.plotY),y:o,bottom:h.height,fullWidth:b},c&&!1===f.visible||(y+=r)})},alignDataLabel:function(e,t,r){var i=e.dlBoxRaw,o=this.chart.inverted,n=e.plotY>pick(this.translatedThreshold,this.yAxis.len),a=pick(r.inside,!!this.options.stacking),d={x:i.x,y:i.y,height:0};r.align=pick(r.align,!o||a?"center":n?"right":"left"),r.verticalAlign=pick(r.verticalAlign,o||a?"middle":n?"top":"bottom"),"top"!==r.verticalAlign&&(d.y+=i.bottom/("bottom"===r.verticalAlign?1:2)),d.width=this.getWidthAt(d.y),this.options.reversed&&(d.width=i.fullWidth-d.width),a?d.x-=d.width/2:"left"===r.align?(r.align="right",d.x-=1.5*d.width):"right"===r.align?(r.align="left",d.x+=d.width/2):d.x-=d.width/2,e.dlBox=d,seriesTypes.column.prototype.alignDataLabel.apply(this,arguments)}},{shapeType:"funnel3d",hasNewShapeType:H.seriesTypes.column.prototype.pointClass.prototype.hasNewShapeType}),funnel3dMethods=merge(RendererProto.elements3d.cuboid,{parts:["top","bottom","frontUpper","backUpper","frontLower","backLower","rightUpper","rightLower"],mainParts:["top","bottom"],sideGroups:["upperGroup","lowerGroup"],sideParts:{upperGroup:["frontUpper","backUpper","rightUpper"],lowerGroup:["frontLower","backLower","rightLower"]},pathType:"funnel3d",opacitySetter:function(e){var t=this,r=t.parts,i=H.charts[t.renderer.chartIndex],o="group-opacity-"+e+"-"+i.index;return t.parts=t.mainParts,t.singleSetterForParts("opacity",e),t.parts=r,i.renderer.filterId||(i.renderer.definition({tagName:"filter",id:o,children:[{tagName:"feComponentTransfer",children:[{tagName:"feFuncA",type:"table",tableValues:"0 "+e}]}]}),t.sideGroups.forEach(function(e){t[e].attr({filter:"url(#"+o+")"})}),t.renderer.styledMode&&(i.renderer.definition({tagName:"style",textContent:".highcharts-"+o+" {filter:url(#"+o+")}"}),t.sideGroups.forEach(function(e){e.addClass("highcharts-"+o)}))),t},fillSetter:function(e){var t=this,r=color(e),i=r.rgba[3],o={top:color(e).brighten(.1).get(),bottom:color(e).brighten(-.2).get()};return i<1?(r.rgba[3]=1,r=r.get("rgb"),t.attr({opacity:i})):r=e,r.linearGradient||r.radialGradient||!t.gradientForSides||(r={linearGradient:{x1:0,x2:1,y1:1,y2:1},stops:[[0,color(e).brighten(-.2).get()],[.5,e],[1,color(e).brighten(-.2).get()]]}),r.linearGradient?t.sideGroups.forEach(function(e){var i=t[e].gradientBox,n=r.linearGradient,a=merge(r,{linearGradient:{x1:i.x+n.x1*i.width,y1:i.y+n.y1*i.height,x2:i.x+n.x2*i.width,y2:i.y+n.y2*i.height}});t.sideParts[e].forEach(function(e){o[e]=a})}):(merge(!0,o,{frontUpper:r,backUpper:r,rightUpper:r,frontLower:r,backLower:r,rightLower:r}),r.radialGradient&&t.sideGroups.forEach(function(e){var r=t[e].gradientBox,i=r.x+r.width/2,o=r.y+r.height/2,n=Math.min(r.width,r.height);t.sideParts[e].forEach(function(e){t[e].setRadialReference([i,o,n])})})),t.singleSetterForParts("fill",null,o),t.color=t.fill=e,r.linearGradient&&[t.frontLower,t.frontUpper].forEach(function(e){var r=e.element,i=r&&t.renderer.gradients[r.gradient];i&&"userSpaceOnUse"!==i.attr("gradientUnits")&&i.attr({gradientUnits:"userSpaceOnUse"})}),t},adjustForGradient:function(){var e,t=this;t.sideGroups.forEach(function(r){var i={x:Number.MAX_VALUE,y:Number.MAX_VALUE},o={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE};t.sideParts[r].forEach(function(r){var n=t[r];e=n.getBBox(!0),i={x:Math.min(i.x,e.x),y:Math.min(i.y,e.y)},o={x:Math.max(o.x,e.x+e.width),y:Math.max(o.y,e.y+e.height)}}),t[r].gradientBox={x:i.x,width:o.x-i.x,y:i.y,height:o.y-i.y}})},zIndexSetter:function(){return this.finishedOnAdd&&this.adjustForGradient(),this.renderer.Element.prototype.zIndexSetter.apply(this,arguments)},onAdd:function(){this.adjustForGradient(),this.finishedOnAdd=!0}}),RendererProto.elements3d.funnel3d=funnel3dMethods,RendererProto.funnel3d=function(e){var t=this.element3d("funnel3d",e),r=this.styledMode,i={"stroke-width":1,stroke:"none"};return t.upperGroup=this.g("funnel3d-upper-group").attr({zIndex:t.frontUpper.zIndex}).add(t),[t.frontUpper,t.backUpper,t.rightUpper].forEach(function(e){r||e.attr(i),e.add(t.upperGroup)}),t.lowerGroup=this.g("funnel3d-lower-group").attr({zIndex:t.frontLower.zIndex}).add(t),[t.frontLower,t.backLower,t.rightLower].forEach(function(e){r||e.attr(i),e.add(t.lowerGroup)}),t.gradientForSides=e.gradientForSides,t},RendererProto.funnel3dPath=function(e){this.getCylinderEnd||error("A required Highcharts module is missing: cylinder.js",!0,charts[this.chartIndex]);var t,r,i=charts[this.chartIndex],o=e.alphaCorrection=90-Math.abs(i.options.chart.options3d.alpha%180-90),n=cuboidPath.call(this,merge(e,{depth:e.width,width:(e.width+e.bottom.width)/2})),a=n.isTop,d=!n.isFront,h=!!e.middle,s=this.getCylinderEnd(i,merge(e,{x:e.x-e.width/2,z:e.z-e.width/2,alphaCorrection:o})),l=e.bottom.width,p=merge(e,{width:l,x:e.x-l/2,z:e.z-l/2,alphaCorrection:o}),g=this.getCylinderEnd(i,p,!0),c=l,f=p,u=g,y=g;return h&&(c=e.middle.width,f=merge(e,{y:e.y+e.middle.fraction*e.height,width:c,x:e.x-c/2,z:e.z-c/2}),u=this.getCylinderEnd(i,f,!1),y=this.getCylinderEnd(i,f,!1)),(t={top:s,bottom:g,frontUpper:this.getCylinderFront(s,u),zIndexes:{group:n.zIndexes.group,top:0!==a?0:3,bottom:1!==a?0:3,frontUpper:d?2:1,backUpper:d?1:2,rightUpper:d?2:1}}).backUpper=this.getCylinderBack(s,u),r=Math.min(c,e.width)/Math.max(c,e.width)!=1,t.rightUpper=this.getCylinderFront(this.getCylinderEnd(i,merge(e,{x:e.x-e.width/2,z:e.z-e.width/2,alphaCorrection:r?-o:0}),!1),this.getCylinderEnd(i,merge(f,{alphaCorrection:r?-o:0}),!h)),h&&(r=Math.min(c,l)/Math.max(c,l)!=1,merge(!0,t,{frontLower:this.getCylinderFront(y,g),backLower:this.getCylinderBack(y,g),rightLower:this.getCylinderFront(this.getCylinderEnd(i,merge(p,{alphaCorrection:r?-o:0}),!0),this.getCylinderEnd(i,merge(f,{alphaCorrection:r?-o:0}),!1)),zIndexes:{frontLower:d?2:1,backLower:d?1:2,rightLower:d?1:2}})),t};
