import BaseSeries from"../Core/Series/Series.js";import ColorMapMixin from"../Mixins/ColorMapSeries.js";var colorMapPointMixin=ColorMapMixin.colorMapPointMixin,colorMapSeriesMixin=ColorMapMixin.colorMapSeriesMixin;import H from"../Core/Globals.js";var noop=H.noop;import LegendSymbolMixin from"../Mixins/LegendSymbol.js";import mapModule from"../Maps/Map.js";var maps=mapModule.maps,splitPath=mapModule.splitPath;import Point from"../Core/Series/Point.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";var extend=U.extend,fireEvent=U.fireEvent,getNestedProperty=U.getNestedProperty,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,splat=U.splat;import"../Core/Options.js";import"../Series/LineSeries.js";import"./ScatterSeries.js";var Series=H.Series,seriesTypes=BaseSeries.seriesTypes;BaseSeries.seriesType("map","scatter",{animation:!1,dataLabels:{crop:!1,formatter:function(){return this.point.value},inside:!0,overflow:!1,padding:0,verticalAlign:"middle"},marker:null,nullColor:"#f7f7f7",stickyTracking:!1,tooltip:{followPointer:!0,pointFormat:"{point.name}: {point.value}<br/>"},turboThreshold:0,allAreas:!0,borderColor:"#cccccc",borderWidth:1,joinBy:"hc-key",states:{hover:{halo:null,brightness:.2},normal:{animation:!0},select:{color:"#cccccc"},inactive:{opacity:1}}},merge(colorMapSeriesMixin,{type:"map",getExtremesFromAll:!0,useMapGeometry:!0,forceDL:!0,searchPoint:noop,directTouch:!0,preserveAspectRatio:!0,pointArrayMap:["value"],setOptions:function(t){var i=Series.prototype.setOptions.call(this,t),e=i.joinBy;return null===e&&(e="_i"),(e=this.joinBy=splat(e))[1]||(e[1]=e[0]),i},getBox:function(t){var i,e=Number.MAX_VALUE,a=-e,r=e,s=-e,o=e,n=e,p=this.xAxis,l=this.yAxis;(t||[]).forEach(function(t){if(t.path){"string"==typeof t.path?t.path=splitPath(t.path):"M"===t.path[0]&&(t.path=SVGRenderer.prototype.pathToSegments(t.path));var p=t.path||[],l=-e,h=e,m=-e,c=e,d=t.properties;t._foundBox||(p.forEach(function(t){var i=t[t.length-2],e=t[t.length-1];"number"==typeof i&&"number"==typeof e&&(h=Math.min(h,i),l=Math.max(l,i),c=Math.min(c,e),m=Math.max(m,e))}),t._midX=h+(l-h)*pick(t.middleX,d&&d["hc-middle-x"],.5),t._midY=c+(m-c)*pick(t.middleY,d&&d["hc-middle-y"],.5),t._maxX=l,t._minX=h,t._maxY=m,t._minY=c,t.labelrank=pick(t.labelrank,(l-h)*(m-c)),t._foundBox=!0),a=Math.max(a,t._maxX),r=Math.min(r,t._minX),s=Math.max(s,t._maxY),o=Math.min(o,t._minY),n=Math.min(t._maxX-t._minX,t._maxY-t._minY,n),i=!0}}),i&&(this.minY=Math.min(o,pick(this.minY,e)),this.maxY=Math.max(s,pick(this.maxY,-e)),this.minX=Math.min(r,pick(this.minX,e)),this.maxX=Math.max(a,pick(this.maxX,-e)),p&&void 0===p.options.minRange&&(p.minRange=Math.min(5*n,(this.maxX-this.minX)/5,p.minRange||e)),l&&void 0===l.options.minRange&&(l.minRange=Math.min(5*n,(this.maxY-this.minY)/5,l.minRange||e)))},hasData:function(){return!!this.processedXData.length},getExtremes:function(){var t=Series.prototype.getExtremes.call(this,this.valueData),i=t.dataMin,e=t.dataMax;return this.chart.hasRendered&&this.isDirtyData&&this.getBox(this.options.data),isNumber(i)&&(this.valueMin=i),isNumber(e)&&(this.valueMax=e),{dataMin:this.minY,dataMax:this.maxY}},translatePath:function(t){var i=this.xAxis,e=this.yAxis,a=i.min,r=i.transA,s=i.minPixelPadding,o=e.min,n=e.transA,p=e.minPixelPadding,l=[];return t&&t.forEach(function(t){"M"===t[0]?l.push(["M",(t[1]-(a||0))*r+s,(t[2]-(o||0))*n+p]):"L"===t[0]?l.push(["L",(t[1]-(a||0))*r+s,(t[2]-(o||0))*n+p]):"C"===t[0]?l.push(["C",(t[1]-(a||0))*r+s,(t[2]-(o||0))*n+p,(t[3]-(a||0))*r+s,(t[4]-(o||0))*n+p,(t[5]-(a||0))*r+s,(t[6]-(o||0))*n+p]):"Q"===t[0]?l.push(["Q",(t[1]-(a||0))*r+s,(t[2]-(o||0))*n+p,(t[3]-(a||0))*r+s,(t[4]-(o||0))*n+p]):"Z"===t[0]&&l.push(["Z"])}),l},setData:function(t,i,e,a){var r,s,o,n=this.options,p=this.chart.options.chart,l=p&&p.map,h=n.mapData,m=this.joinBy,c=n.keys||this.pointArrayMap,d=[],u={},f=this.chart.mapTransforms;if(!h&&l&&(h="string"==typeof l?maps[l]:l),t&&t.forEach(function(i,e){var a=0;if(isNumber(i))t[e]={value:i};else if(isArray(i)){t[e]={},!n.keys&&i.length>c.length&&"string"==typeof i[0]&&(t[e]["hc-key"]=i[0],++a);for(var r=0;r<c.length;++r,++a)c[r]&&void 0!==i[a]&&(c[r].indexOf(".")>0?Point.prototype.setNestedProperty(t[e],i[a],c[r]):t[e][c[r]]=i[a])}m&&"_i"===m[0]&&(t[e]._i=e)}),this.getBox(t),this.chart.mapTransforms=f=p&&p.mapTransforms||h&&h["hc-transform"]||f,f&&objectEach(f,function(t){t.rotation&&(t.cosAngle=Math.cos(t.rotation),t.sinAngle=Math.sin(t.rotation))}),h){for("FeatureCollection"===h.type&&(this.mapTitle=h.title,h=H.geojson(h,this.type,this)),this.mapData=h,this.mapMap={},o=0;o<h.length;o++)s=(r=h[o]).properties,r._i=o,m[0]&&s&&s[m[0]]&&(r[m[0]]=s[m[0]]),u[r[m[0]]]=r;if(this.mapMap=u,t&&m[1]){var x=m[1];t.forEach(function(t){var i=getNestedProperty(x,t);u[i]&&d.push(u[i])})}if(n.allAreas){if(this.getBox(h),t=t||[],m[1]){var g=m[1];t.forEach(function(t){d.push(getNestedProperty(g,t))})}d="|"+d.map(function(t){return t&&t[m[0]]}).join("|")+"|",h.forEach(function(i){m[0]&&-1!==d.indexOf("|"+i[m[0]]+"|")||(t.push(merge(i,{value:null})),a=!1)})}else this.getBox(d)}Series.prototype.setData.call(this,t,i,e,a)},drawGraph:noop,drawDataLabels:noop,doFullTranslate:function(){return this.isDirtyData||this.chart.isResizing||this.chart.renderer.isVML||!this.baseTrans},translate:function(){var t=this,i=t.xAxis,e=t.yAxis,a=t.doFullTranslate();t.generatePoints(),t.data.forEach(function(r){isNumber(r._midX)&&isNumber(r._midY)&&(r.plotX=i.toPixels(r._midX,!0),r.plotY=e.toPixels(r._midY,!0)),a&&(r.shapeType="path",r.shapeArgs={d:t.translatePath(r.path)})}),fireEvent(t,"afterTranslate")},pointAttribs:function(t,i){var e=t.series.chart.styledMode?this.colorAttribs(t):seriesTypes.column.prototype.pointAttribs.call(this,t,i);return e["stroke-width"]=pick(t.options[this.pointAttrToOptions&&this.pointAttrToOptions["stroke-width"]||"borderWidth"],"inherit"),e},drawPoints:function(){var t,i,e,a,r,s,o,n,p,l=this,h=l.xAxis,m=l.yAxis,c=l.group,d=l.chart,u=d.renderer,f=this.baseTrans;l.transformGroup||(l.transformGroup=u.g().attr({scaleX:1,scaleY:1}).add(c),l.transformGroup.survive=!0),l.doFullTranslate()?(d.hasRendered&&!d.styledMode&&l.points.forEach(function(t){t.shapeArgs&&(t.shapeArgs.fill=l.pointAttribs(t,t.state).fill)}),l.group=l.transformGroup,seriesTypes.column.prototype.drawPoints.apply(l),l.group=c,l.points.forEach(function(t){if(t.graphic){var i="";t.name&&(i+="highcharts-name-"+t.name.replace(/ /g,"-").toLowerCase()),t.properties&&t.properties["hc-key"]&&(i+=" highcharts-key-"+t.properties["hc-key"].toLowerCase()),i&&t.graphic.addClass(i),d.styledMode&&t.graphic.css(l.pointAttribs(t,t.selected?"select":void 0))}}),this.baseTrans={originX:h.min-h.minPixelPadding/h.transA,originY:m.min-m.minPixelPadding/m.transA+(m.reversed?0:m.len/m.transA),transAX:h.transA,transAY:m.transA},this.transformGroup.animate({translateX:0,translateY:0,scaleX:1,scaleY:1})):(t=h.transA/f.transAX,i=m.transA/f.transAY,e=h.toPixels(f.originX,!0),a=m.toPixels(f.originY,!0),t>.99&&t<1.01&&i>.99&&i<1.01&&(t=1,i=1,e=Math.round(e),a=Math.round(a)),r=this.transformGroup,d.renderer.globalAnimation?(s=r.attr("translateX"),o=r.attr("translateY"),n=r.attr("scaleX"),p=r.attr("scaleY"),r.attr({animator:0}).animate({animator:1},{step:function(l,h){r.attr({translateX:s+(e-s)*h.pos,translateY:o+(a-o)*h.pos,scaleX:n+(t-n)*h.pos,scaleY:p+(i-p)*h.pos})}})):r.attr({translateX:e,translateY:a,scaleX:t,scaleY:i})),d.styledMode||c.element.setAttribute("stroke-width",pick(l.options[l.pointAttrToOptions&&l.pointAttrToOptions["stroke-width"]||"borderWidth"],1)/(t||1)),this.drawMapDataLabels()},drawMapDataLabels:function(){Series.prototype.drawDataLabels.call(this),this.dataLabelsGroup&&this.dataLabelsGroup.clip(this.chart.clipRect)},render:function(){var t=this,i=Series.prototype.render;t.chart.renderer.isVML&&t.data.length>3e3?setTimeout(function(){i.call(t)}):i.call(t)},animate:function(t){var i=this.chart,e=this.options.animation,a=this.group,r=this.xAxis,s=this.yAxis,o=r.pos,n=s.pos;i.renderer.isSVG&&(!0===e&&(e={duration:1e3}),t?a.attr({translateX:o+r.len/2,translateY:n+s.len/2,scaleX:.001,scaleY:.001}):a.animate({translateX:o,translateY:n,scaleX:1,scaleY:1},e))},animateDrilldown:function(t){var i,e=this.chart.plotBox,a=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],r=a.bBox,s=this.chart.options.drilldown.animation;t||(i=Math.min(r.width/e.width,r.height/e.height),a.shapeArgs={scaleX:i,scaleY:i,translateX:r.x,translateY:r.y},this.points.forEach(function(t){t.graphic&&t.graphic.attr(a.shapeArgs).animate({scaleX:1,scaleY:1,translateX:0,translateY:0},s)}))},drawLegendSymbol:LegendSymbolMixin.drawRectangle,animateDrillupFrom:function(t){seriesTypes.column.prototype.animateDrillupFrom.call(this,t)},animateDrillupTo:function(t){seriesTypes.column.prototype.animateDrillupTo.call(this,t)}}),extend({applyOptions:function(t,i){var e,a=this.series,r=Point.prototype.applyOptions.call(this,t,i),s=a.joinBy;if(a.mapData&&a.mapMap){var o=s[1],n=Point.prototype.getNestedProperty.call(r,o);(e=void 0!==n&&a.mapMap[n])?(a.xyFromShape&&(r.x=e._midX,r.y=e._midY),extend(r,e)):r.value=r.value||null}return r},onMouseOver:function(t){U.clearTimeout(this.colorInterval),null!==this.value||this.series.options.nullInteraction?Point.prototype.onMouseOver.call(this,t):this.series.onMouseOut(t)},zoomTo:function(){var t=this.series;t.xAxis.setExtremes(this._minX,this._maxX,!1),t.yAxis.setExtremes(this._minY,this._maxY,!1),t.chart.redraw()}},colorMapPointMixin));