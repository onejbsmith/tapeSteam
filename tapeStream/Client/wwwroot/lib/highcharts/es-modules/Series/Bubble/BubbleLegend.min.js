"use strict";import Chart from"../../Core/Chart/Chart.js";import Color from"../../Core/Color/Color.js";var color=Color.parse;import H from"../../Core/Globals.js";import Legend from"../../Core/Legend.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,setOptions=U.setOptions,stableSort=U.stableSort,wrap=U.wrap;import"./BubbleSeries.js";var Series=H.Series,noop=H.noop;setOptions({legend:{bubbleLegend:{borderColor:void 0,borderWidth:2,className:void 0,color:void 0,connectorClassName:void 0,connectorColor:void 0,connectorDistance:60,connectorWidth:1,enabled:!1,labels:{className:void 0,allowOverlap:!1,format:"",formatter:void 0,align:"right",style:{fontSize:10,color:void 0},x:0,y:0},maxSize:60,minSize:10,legendIndex:0,ranges:{value:void 0,borderColor:void 0,color:void 0,connectorColor:void 0},sizeBy:"area",sizeByAbsoluteValue:!1,zIndex:1,zThreshold:0}}});var BubbleLegend=function(){function e(e,t){this.chart=void 0,this.fontMetrics=void 0,this.legend=void 0,this.legendGroup=void 0,this.legendItem=void 0,this.legendItemHeight=void 0,this.legendItemWidth=void 0,this.legendSymbol=void 0,this.maxLabel=void 0,this.movementX=void 0,this.ranges=void 0,this.visible=void 0,this.symbols=void 0,this.options=void 0,this.setState=noop,this.init(e,t)}return e.prototype.init=function(e,t){this.options=e,this.visible=!0,this.chart=t.chart,this.legend=t},e.prototype.addToLegend=function(e){e.splice(this.options.legendIndex,0,this)},e.prototype.drawLegendSymbol=function(e){var t,i,s,o,n=this.chart,r=this.options,l=pick(e.options.itemDistance,20),a=r.ranges,h=r.connectorDistance;this.fontMetrics=n.renderer.fontMetrics(r.labels.style.fontSize.toString()+"px"),a&&a.length&&isNumber(a[0].value)?(stableSort(a,function(e,t){return t.value-e.value}),this.ranges=a,this.setOptions(),this.render(),o=this.getMaxLabelSize(),t=2*(s=this.ranges[0].radius),i=(i=h-s+o.width)>0?i:0,this.maxLabel=o,this.movementX="left"===r.labels.align?i:0,this.legendItemWidth=t+i+l,this.legendItemHeight=t+this.fontMetrics.h/2):e.options.bubbleLegend.autoRanges=!0},e.prototype.setOptions=function(){var e=this.ranges,t=this.options,i=this.chart.series[t.seriesIndex],s=this.legend.baseline,o={"z-index":t.zIndex,"stroke-width":t.borderWidth},n={"z-index":t.zIndex,"stroke-width":t.connectorWidth},r=this.getLabelStyles(),l=i.options.marker.fillOpacity,a=this.chart.styledMode;e.forEach(function(h,d){a||(o.stroke=pick(h.borderColor,t.borderColor,i.color),o.fill=pick(h.color,t.color,1!==l?color(i.color).setOpacity(l).get("rgba"):i.color),n.stroke=pick(h.connectorColor,t.connectorColor,i.color)),e[d].radius=this.getRangeRadius(h.value),e[d]=merge(e[d],{center:e[0].radius-e[d].radius+s}),a||merge(!0,e[d],{bubbleStyle:merge(!1,o),connectorStyle:merge(!1,n),labelStyle:r})},this)},e.prototype.getLabelStyles=function(){var e=this.options,t={},i="left"===e.labels.align,s=this.legend.options.rtl;return objectEach(e.labels.style,function(e,i){"color"!==i&&"fontSize"!==i&&"z-index"!==i&&(t[i]=e)}),merge(!1,t,{"font-size":e.labels.style.fontSize,fill:pick(e.labels.style.color,"#000000"),"z-index":e.zIndex,align:s||i?"right":"left"})},e.prototype.getRangeRadius=function(e){var t=this.options,i=this.options.seriesIndex,s=this.chart.series[i],o=t.ranges[0].value,n=t.ranges[t.ranges.length-1].value,r=t.minSize,l=t.maxSize;return s.getRadius.call(this,n,o,r,l,e)},e.prototype.render=function(){var e=this.chart.renderer,t=this.options.zThreshold;this.symbols||(this.symbols={connectors:[],bubbleItems:[],labels:[]}),this.legendSymbol=e.g("bubble-legend"),this.legendItem=e.g("bubble-legend-item"),this.legendSymbol.translateX=0,this.legendSymbol.translateY=0,this.ranges.forEach(function(e){e.value>=t&&this.renderRange(e)},this),this.legendSymbol.add(this.legendItem),this.legendItem.add(this.legendGroup),this.hideOverlappingLabels()},e.prototype.renderRange=function(e){var t,i,s,o=this.ranges[0],n=this.legend,r=this.options,l=r.labels,a=this.chart.renderer,h=this.symbols,d=h.labels,b=e.center,g=Math.abs(e.radius),c=r.connectorDistance||0,p=l.align,u=n.options.rtl,m=l.style.fontSize,v=u||"left"===p?-c:c,f=r.borderWidth,y=r.connectorWidth,S=o.radius||0,x=b-g-f/2+y/2,L=m/2-(this.fontMetrics.h-m)/2,z=(x%1?1:.5)-(y%2?0:.5),I=a.styledMode;"center"===p&&(v=0,r.connectorDistance=0,e.labelStyle.align="center"),i=x+r.labels.y,s=S+v+r.labels.x,h.bubbleItems.push(a.circle(S,b+z,g).attr(I?{}:e.bubbleStyle).addClass((I?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-symbol "+(r.className||"")).add(this.legendSymbol)),h.connectors.push(a.path(a.crispLine([["M",S,x],["L",S+v,x]],r.connectorWidth)).attr(I?{}:e.connectorStyle).addClass((I?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-connectors "+(r.connectorClassName||"")).add(this.legendSymbol)),t=a.text(this.formatLabel(e),s,i+L).attr(I?{}:e.labelStyle).addClass("highcharts-bubble-legend-labels "+(r.labels.className||"")).add(this.legendSymbol),d.push(t),t.placed=!0,t.alignAttr={x:s,y:i+L}},e.prototype.getMaxLabelSize=function(){var e,t;return this.symbols.labels.forEach(function(i){t=i.getBBox(!0),e=e?t.width>e.width?t:e:t}),e||{}},e.prototype.formatLabel=function(e){var t=this.options,i=t.labels.formatter,s=t.labels.format,o=this.chart.numberFormatter;return s?U.format(s,e):i?i.call(e):o(e.value,1)},e.prototype.hideOverlappingLabels=function(){var e=this.chart,t=this.options.labels.allowOverlap,i=this.symbols;!t&&i&&(e.hideOverlappingLabels(i.labels),i.labels.forEach(function(e,t){e.newOpacity?e.newOpacity!==e.oldOpacity&&i.connectors[t].show():i.connectors[t].hide()}))},e.prototype.getRanges=function(){var e,t,i=this.legend.bubbleLegend,s=i.chart.series,o=i.options.ranges,n=Number.MAX_VALUE,r=-Number.MAX_VALUE;return s.forEach(function(e){e.isBubble&&!e.ignoreSeries&&(t=e.zData.filter(isNumber)).length&&(n=pick(e.options.zMin,Math.min(n,Math.max(arrayMin(t),!1===e.options.displayNegative?e.options.zThreshold:-Number.MAX_VALUE))),r=pick(e.options.zMax,Math.max(r,arrayMax(t))))}),e=n===r?[{value:r}]:[{value:n},{value:(n+r)/2},{value:r,autoRanges:!0}],o.length&&o[0].radius&&e.reverse(),e.forEach(function(t,i){o&&o[i]&&(e[i]=merge(!1,o[i],t))}),e},e.prototype.predictBubbleSizes=function(){var e,t=this.chart,i=this.fontMetrics,s=t.legend.options,o=s.floating,n="horizontal"===s.layout,r=n?t.legend.lastLineHeight:0,l=t.plotSizeX,a=t.plotSizeY,h=t.series[this.options.seriesIndex],d=Math.ceil(h.minPxSize),b=Math.ceil(h.maxPxSize),g=h.options.maxSize,c=Math.min(a,l);return o||!/%$/.test(g)?e=b:(g=parseFloat(g),e=(c+r-i.h/2)*g/100/(g/100+1),(n&&a-e>=l||!n&&l-e>=a)&&(e=b)),[d,Math.ceil(e)]},e.prototype.updateRanges=function(e,t){var i=this.legend.options.bubbleLegend;i.minSize=e,i.maxSize=t,i.ranges=this.getRanges()},e.prototype.correctSizes=function(){var e=this.legend,t=this.chart.series[this.options.seriesIndex],i=t.maxPxSize,s=this.options.maxSize;Math.abs(Math.ceil(i)-s)>1&&(this.updateRanges(this.options.minSize,t.maxPxSize),e.render())},e}();addEvent(Legend,"afterGetAllItems",function(e){var t=this.bubbleLegend,i=this.options,s=i.bubbleLegend,o=this.chart.getVisibleBubbleSeriesIndex();t&&t.ranges&&t.ranges.length&&(s.ranges.length&&(s.autoRanges=!!s.ranges[0].autoRanges),this.destroyItem(t)),o>=0&&i.enabled&&s.enabled&&(s.seriesIndex=o,this.bubbleLegend=new H.BubbleLegend(s,this),this.bubbleLegend.addToLegend(e.allItems))}),Chart.prototype.getVisibleBubbleSeriesIndex=function(){for(var e=this.series,t=0;t<e.length;){if(e[t]&&e[t].isBubble&&e[t].visible&&e[t].zData.length)return t;t++}return-1},Legend.prototype.getLinesHeights=function(){var e,t=this.allItems,i=[],s=t.length,o=0,n=0;for(o=0;o<s;o++)if(t[o].legendItemHeight&&(t[o].itemHeight=t[o].legendItemHeight),t[o]===t[s-1]||t[o+1]&&t[o]._legendItemPos[1]!==t[o+1]._legendItemPos[1]){for(i.push({height:0}),e=i[i.length-1];n<=o;n++)t[n].itemHeight>e.height&&(e.height=t[n].itemHeight);e.step=o}return i},Legend.prototype.retranslateItems=function(e){var t,i,s,o=this.allItems,n=this.options.rtl,r=0;o.forEach(function(o,l){t=o.legendGroup.translateX,i=o._legendItemPos[1],((s=o.movementX)||n&&o.ranges)&&(s=n?t-o.options.maxSize/2:t+s,o.legendGroup.attr({translateX:s})),l>e[r].step&&r++,o.legendGroup.attr({translateY:Math.round(i+e[r].height/2)}),o._legendItemPos[1]=i+e[r].height/2})},addEvent(Series,"legendItemClick",function(){var e,t=this.chart,i=this.visible,s=this.chart.legend;s&&s.bubbleLegend&&(this.visible=!i,this.ignoreSeries=i,e=t.getVisibleBubbleSeriesIndex()>=0,s.bubbleLegend.visible!==e&&(s.update({bubbleLegend:{enabled:e}}),s.bubbleLegend.visible=e),this.visible=i)}),wrap(Chart.prototype,"drawChartBox",function(e,t,i){var s,o,n=this.legend,r=this.getVisibleBubbleSeriesIndex()>=0;n&&n.options.enabled&&n.bubbleLegend&&n.options.bubbleLegend.autoRanges&&r?(s=n.bubbleLegend.options,o=n.bubbleLegend.predictBubbleSizes(),n.bubbleLegend.updateRanges(o[0],o[1]),s.placed||(n.group.placed=!1,n.allItems.forEach(function(e){e.legendGroup.translateY=null})),n.render(),this.getMargins(),this.axes.forEach(function(e){e.visible&&e.render(),s.placed||(e.setScale(),e.updateNames(),objectEach(e.ticks,function(e){e.isNew=!0,e.isNewLabel=!0}))}),s.placed=!0,this.getMargins(),e.call(this,t,i),n.bubbleLegend.correctSizes(),n.retranslateItems(n.getLinesHeights())):(e.call(this,t,i),n&&n.options.enabled&&n.bubbleLegend&&(n.render(),n.retranslateItems(n.getLinesHeights())))}),H.BubbleLegend=BubbleLegend;export default H.BubbleLegend;