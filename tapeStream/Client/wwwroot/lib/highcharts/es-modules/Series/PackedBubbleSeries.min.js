import BaseSeries from"../Core/Series/Series.js";import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";var color=Color.parse;import H from"../Core/Globals.js";import Point from"../Core/Series/Point.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,clamp=U.clamp,defined=U.defined,extend=U.extend,extendClass=U.extendClass,fireEvent=U.fireEvent,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,pick=U.pick;import"./Bubble/BubbleSeries.js";import"../Series/Networkgraph/DraggableNodes.js";import"../Series/Networkgraph/Layouts.js";var Series=H.Series,Reingold=H.layouts["reingold-fruchterman"],dragNodesMixin=H.dragNodesMixin;Chart.prototype.getSelectedParentNodes=function(){var t=this.series,e=[];return t.forEach(function(t){t.parentNode&&t.parentNode.selected&&e.push(t.parentNode)}),e},H.networkgraphIntegrations.packedbubble={repulsiveForceFunction:function(t,e,i,o){return Math.min(t,(i.marker.radius+o.marker.radius)/2)},barycenter:function(){var t,e,i=this,o=i.options.gravitationalConstant,a=i.box,r=i.nodes;r.forEach(function(s){i.options.splitSeries&&!s.isParentNode?(t=s.series.parentNode.plotX,e=s.series.parentNode.plotY):(t=a.width/2,e=a.height/2),s.fixedPosition||(s.plotX-=(s.plotX-t)*o/(s.mass*Math.sqrt(r.length)),s.plotY-=(s.plotY-e)*o/(s.mass*Math.sqrt(r.length)))})},repulsive:function(t,e,i,o){var a=e*this.diffTemperature/t.mass/t.degree,r=i.x*a,s=i.y*a;t.fixedPosition||(t.plotX+=r,t.plotY+=s),o.fixedPosition||(o.plotX-=r,o.plotY-=s)},integrate:H.networkgraphIntegrations.verlet.integrate,getK:H.noop},H.layouts.packedbubble=extendClass(Reingold,{beforeStep:function(){this.options.marker&&this.series.forEach(function(t){t&&t.calculateParentRadius()})},setCircularPositions:function(){var t,e,i=this,o=i.box,a=i.nodes,r=a.length+1,s=2*Math.PI/r,n=i.options.initialPositionRadius;a.forEach(function(a,r){i.options.splitSeries&&!a.isParentNode?(t=a.series.parentNode.plotX,e=a.series.parentNode.plotY):(t=o.width/2,e=o.height/2),a.plotX=a.prevX=pick(a.plotX,t+n*Math.cos(a.index||r*s)),a.plotY=a.prevY=pick(a.plotY,e+n*Math.sin(a.index||r*s)),a.dispX=0,a.dispY=0})},repulsiveForces:function(){var t,e,i,o=this,a=o.options.bubblePadding;o.nodes.forEach(function(r){r.degree=r.mass,r.neighbours=0,o.nodes.forEach(function(s){t=0,r===s||r.fixedPosition||!o.options.seriesInteraction&&r.series!==s.series||(i=o.getDistXY(r,s),(e=o.vectorLength(i)-(r.marker.radius+s.marker.radius+a))<0&&(r.degree+=.01,r.neighbours++,t=o.repulsiveForce(-e/Math.sqrt(r.neighbours),o.k,r,s)),o.force("repulsive",r,t*s.mass,i,s,e))})})},applyLimitBox:function(t){var e,i;this.options.splitSeries&&!t.isParentNode&&this.options.parentNodeLimit&&(e=this.getDistXY(t,t.series.parentNode),(i=t.series.parentNodeRadius-t.marker.radius-this.vectorLength(e))<0&&i>-2*t.marker.radius&&(t.plotX-=.01*e.x,t.plotY-=.01*e.y)),Reingold.prototype.applyLimitBox.apply(this,arguments)}}),BaseSeries.seriesType("packedbubble","bubble",{minSize:"10%",maxSize:"50%",sizeBy:"area",zoneAxis:"y",crisp:!1,tooltip:{pointFormat:"Value: {point.value}"},draggable:!0,useSimulation:!0,parentNode:{allowPointSelect:!1},dataLabels:{formatter:function(){return this.point.value},parentNodeFormatter:function(){return this.name},parentNodeTextPath:{enabled:!0},padding:0,style:{transition:"opacity 2000ms"}},layoutAlgorithm:{initialPositions:"circle",initialPositionRadius:20,bubblePadding:5,parentNodeLimit:!1,seriesInteraction:!0,dragBetweenSeries:!1,parentNodeOptions:{maxIterations:400,gravitationalConstant:.03,maxSpeed:50,initialPositionRadius:100,seriesInteraction:!0,marker:{fillColor:null,fillOpacity:1,lineWidth:1,lineColor:null,symbol:"circle"}},enableSimulation:!0,type:"packedbubble",integration:"packedbubble",maxIterations:1e3,splitSeries:!1,maxSpeed:5,gravitationalConstant:.01,friction:-.981}},{hasDraggableNodes:!0,forces:["barycenter","repulsive"],pointArrayMap:["value"],trackerGroups:["group","dataLabelsGroup","parentNodesGroup"],pointValKey:"value",isCartesian:!1,requireSorting:!1,directTouch:!0,axisTypes:[],noSharedTooltip:!0,searchPoint:H.noop,accumulateAllPoints:function(t){var e,i,o=t.chart,a=[];for(e=0;e<o.series.length;e++)if((t=o.series[e]).is("packedbubble")&&t.visible||!o.options.chart.ignoreHiddenSeries)for(i=0;i<t.yData.length;i++)a.push([null,null,t.yData[i],t.index,i,{id:i,marker:{radius:0}}]);return a},init:function(){return Series.prototype.init.apply(this,arguments),addEvent(this,"updatedData",function(){this.chart.series.forEach(function(t){t.type===this.type&&(t.isDirty=!0)},this)}),this},render:function(){var t=[];Series.prototype.render.apply(this,arguments),this.options.dataLabels.allowOverlap||(this.data.forEach(function(e){isArray(e.dataLabels)&&e.dataLabels.forEach(function(e){t.push(e)})}),this.options.useSimulation&&this.chart.hideOverlappingLabels(t))},setVisible:function(){var t=this;Series.prototype.setVisible.apply(t,arguments),t.parentNodeLayout&&t.graph?t.visible?(t.graph.show(),t.parentNode.dataLabel&&t.parentNode.dataLabel.show()):(t.graph.hide(),t.parentNodeLayout.removeElementFromCollection(t.parentNode,t.parentNodeLayout.nodes),t.parentNode.dataLabel&&t.parentNode.dataLabel.hide()):t.layout&&(t.visible?t.layout.addElementsToCollection(t.points,t.layout.nodes):t.points.forEach(function(e){t.layout.removeElementFromCollection(e,t.layout.nodes)}))},drawDataLabels:function(){var t=this.options.dataLabels.textPath,e=this.points;Series.prototype.drawDataLabels.apply(this,arguments),this.parentNode&&(this.parentNode.formatPrefix="parentNode",this.points=[this.parentNode],this.options.dataLabels.textPath=this.options.dataLabels.parentNodeTextPath,Series.prototype.drawDataLabels.apply(this,arguments),this.points=e,this.options.dataLabels.textPath=t)},seriesBox:function(){var t,e=this.chart,i=this.data,o=Math.max,a=Math.min,r=[e.plotLeft,e.plotLeft+e.plotWidth,e.plotTop,e.plotTop+e.plotHeight];return i.forEach(function(e){defined(e.plotX)&&defined(e.plotY)&&e.marker.radius&&(t=e.marker.radius,r[0]=a(r[0],e.plotX-t),r[1]=o(r[1],e.plotX+t),r[2]=a(r[2],e.plotY-t),r[3]=o(r[3],e.plotY+t))}),isNumber(r.width/r.height)?r:null},calculateParentRadius:function(){var t;t=this.seriesBox(),this.parentNodeRadius=clamp(Math.sqrt(2*this.parentNodeMass/Math.PI)+20,20,t?Math.max(Math.sqrt(Math.pow(t.width,2)+Math.pow(t.height,2))/2+20,20):Math.sqrt(2*this.parentNodeMass/Math.PI)+20),this.parentNode&&(this.parentNode.marker.radius=this.parentNode.radius=this.parentNodeRadius)},drawGraph:function(){if(this.layout&&this.layout.options.splitSeries){var t,e=this.chart,i=this.layout.options.parentNodeOptions.marker,o={fill:i.fillColor||color(this.color).brighten(.4).get(),opacity:i.fillOpacity,stroke:i.lineColor||this.color,"stroke-width":i.lineWidth},a=this.visible?"inherit":"hidden";this.parentNodesGroup||(this.parentNodesGroup=this.plotGroup("parentNodesGroup","parentNode",a,.1,e.seriesGroup),this.group.attr({zIndex:2})),this.calculateParentRadius(),t=merge({x:this.parentNode.plotX-this.parentNodeRadius,y:this.parentNode.plotY-this.parentNodeRadius,width:2*this.parentNodeRadius,height:2*this.parentNodeRadius},o),this.parentNode.graphic||(this.graph=this.parentNode.graphic=e.renderer.symbol(o.symbol).add(this.parentNodesGroup)),this.parentNode.graphic.attr(t)}},createParentNodes:function(){var t,e=this,i=e.chart,o=e.parentNodeLayout,a=e.parentNode,r=e.pointClass;e.parentNodeMass=0,e.points.forEach(function(t){e.parentNodeMass+=Math.PI*Math.pow(t.marker.radius,2)}),e.calculateParentRadius(),o.nodes.forEach(function(i){i.seriesIndex===e.index&&(t=!0)}),o.setArea(0,0,i.plotWidth,i.plotHeight),t||(a||(a=(new r).init(this,{mass:e.parentNodeRadius/2,marker:{radius:e.parentNodeRadius},dataLabels:{inside:!1},dataLabelOnNull:!0,degree:e.parentNodeRadius,isParentNode:!0,seriesIndex:e.index})),e.parentNode&&(a.plotX=e.parentNode.plotX,a.plotY=e.parentNode.plotY),e.parentNode=a,o.addElementsToCollection([e],o.series),o.addElementsToCollection([a],o.nodes))},drawTracker:function(){this.chart.pointer;var t,e=this.parentNode;H.TrackerMixin.drawTrackerPoint.call(this),e&&(t=isArray(e.dataLabels)?e.dataLabels:e.dataLabel?[e.dataLabel]:[],e.graphic&&(e.graphic.element.point=e),t.forEach(function(t){t.div?t.div.point=e:t.element.point=e}))},addSeriesLayout:function(){var t,e=this.options.layoutAlgorithm,i=this.chart.graphLayoutsStorage,o=this.chart.graphLayoutsLookup,a=merge(e,e.parentNodeOptions,{enableSimulation:this.layout.options.enableSimulation});(t=i[e.type+"-series"])||(i[e.type+"-series"]=t=new H.layouts[e.type],t.init(a),o.splice(t.index,0,t)),this.parentNodeLayout=t,this.createParentNodes()},addLayout:function(){var t,e=this.options.layoutAlgorithm,i=this.chart.graphLayoutsStorage,o=this.chart.graphLayoutsLookup,a=this.chart.options.chart;i||(this.chart.graphLayoutsStorage=i={},this.chart.graphLayoutsLookup=o=[]),(t=i[e.type])||(e.enableSimulation=defined(a.forExport)?!a.forExport:e.enableSimulation,i[e.type]=t=new H.layouts[e.type],t.init(e),o.splice(t.index,0,t)),this.layout=t,this.points.forEach(function(t){t.mass=2,t.degree=1,t.collisionNmb=1}),t.setArea(0,0,this.chart.plotWidth,this.chart.plotHeight),t.addElementsToCollection([this],t.series),t.addElementsToCollection(this.points,t.nodes)},deferLayout:function(){var t=this.options.layoutAlgorithm;this.visible&&(this.addLayout(),t.splitSeries&&this.addSeriesLayout())},translate:function(){var t,e,i,o,a=this.chart,r=this.data,s=this.index,n=this.options.useSimulation;for(this.processedXData=this.xData,this.generatePoints(),defined(a.allDataPoints)||(a.allDataPoints=this.accumulateAllPoints(this),this.getPointRadius()),n?i=a.allDataPoints:(i=this.placeBubbles(a.allDataPoints),this.options.draggable=!1),o=0;o<i.length;o++)i[o][3]===s&&(t=r[i[o][4]],e=i[o][2],n||(t.plotX=i[o][0]-a.plotLeft+a.diffX,t.plotY=i[o][1]-a.plotTop+a.diffY),t.marker=extend(t.marker,{radius:e,width:2*e,height:2*e}),t.radius=e);n&&this.deferLayout(),fireEvent(this,"afterTranslate")},checkOverlap:function(t,e){var i=t[0]-e[0],o=t[1]-e[1],a=t[2]+e[2];return Math.sqrt(i*i+o*o)-Math.abs(a)<-.001},positionBubble:function(t,e,i){var o=Math.sqrt,a=Math.asin,r=Math.acos,s=Math.pow,n=Math.abs,p=o(s(t[0]-e[0],2)+s(t[1]-e[1],2)),l=r((s(p,2)+s(i[2]+e[2],2)-s(i[2]+t[2],2))/(2*(i[2]+e[2])*p)),h=a(n(t[0]-e[0])/p),d=(t[1]-e[1]<0?0:Math.PI)+l+h*((t[0]-e[0])*(t[1]-e[1])<0?1:-1),u=Math.cos(d),c=Math.sin(d);return[e[0]+(e[2]+i[2])*c,e[1]-(e[2]+i[2])*u,i[2],i[3],i[4]]},placeBubbles:function(t){var e,i,o,a=this.checkOverlap,r=this.positionBubble,s=[],n=1,p=0,l=0,h=[];if((i=t.sort(function(t,e){return e[2]-t[2]})).length){if(s.push([[0,0,i[0][2],i[0][3],i[0][4]]]),i.length>1)for(s.push([[0,0-i[1][2]-i[0][2],i[1][2],i[1][3],i[1][4]]]),o=2;o<i.length;o++)i[o][2]=i[o][2]||1,a(e=r(s[n][p],s[n-1][l],i[o]),s[n][0])?(s.push([]),l=0,s[n+1].push(r(s[n][p],s[n][0],i[o])),n++,p=0):n>1&&s[n-1][l+1]&&a(e,s[n-1][l+1])?(l++,s[n].push(r(s[n][p],s[n-1][l],i[o])),p++):(p++,s[n].push(e));this.chart.stages=s,this.chart.rawPositions=[].concat.apply([],s),this.resizeRadius(),h=this.chart.rawPositions}return h},resizeRadius:function(){var t,e,i,o,a,r,s,n,p,l=this.chart,h=l.rawPositions,d=Math.min,u=Math.max,c=l.plotLeft,f=l.plotTop,m=l.plotHeight,g=l.plotWidth;for(t=i=Number.POSITIVE_INFINITY,e=o=Number.NEGATIVE_INFINITY,p=0;p<h.length;p++)a=h[p][2],t=d(t,h[p][0]-a),e=u(e,h[p][0]+a),i=d(i,h[p][1]-a),o=u(o,h[p][1]+a);if(s=[(g-c)/(r=[e-t,o-i])[0],(m-f)/r[1]],n=d.apply([],s),Math.abs(n-1)>1e-10){for(p=0;p<h.length;p++)h[p][2]*=n;this.placeBubbles(h)}else l.diffY=m/2+f-i-(o-i)/2,l.diffX=g/2+c-t-(e-t)/2},calculateZExtremes:function(){var t=this.chart,e=this.options.zMin,i=this.options.zMax,o=1/0,a=-1/0;return e&&i?[e,i]:(t.series.forEach(function(t){t.yData.forEach(function(t){defined(t)&&(t>a&&(a=t),t<o&&(o=t))})}),[e=pick(e,o),i=pick(i,a)])},getPointRadius:function(){var t,e,i,o,a,r=this,s=r.chart,n=s.plotWidth,p=s.plotHeight,l=r.options,h=l.useSimulation,d=Math.min(n,p),u={},c=[],f=s.allDataPoints;["minSize","maxSize"].forEach(function(t){var e=parseInt(l[t],10),i=/%$/.test(l[t]);u[t]=i?d*e/100:e*Math.sqrt(f.length)}),s.minRadius=t=u.minSize/Math.sqrt(f.length),s.maxRadius=e=u.maxSize/Math.sqrt(f.length),a=h?r.calculateZExtremes():[t,e],(f||[]).forEach(function(s,n){i=h?clamp(s[2],a[0],a[1]):s[2],0===(o=r.getRadius(a[0],a[1],t,e,i))&&(o=null),f[n][2]=o,c.push(o)}),r.radii=c},redrawHalo:dragNodesMixin.redrawHalo,onMouseDown:dragNodesMixin.onMouseDown,onMouseMove:dragNodesMixin.onMouseMove,onMouseUp:function(t){if(t.fixedPosition&&!t.removed){var e,i=this.layout,o=this.parentNodeLayout;o&&i.options.dragBetweenSeries&&o.nodes.forEach(function(o){t&&t.marker&&o!==t.series.parentNode&&(e=i.getDistXY(t,o),i.vectorLength(e)-o.marker.radius-t.marker.radius<0&&(o.series.addPoint(merge(t.options,{plotX:t.plotX,plotY:t.plotY}),!1),i.removeElementFromCollection(t,i.nodes),t.remove()))}),dragNodesMixin.onMouseUp.apply(this,arguments)}},destroy:function(){this.chart.graphLayoutsLookup&&this.chart.graphLayoutsLookup.forEach(function(t){t.removeElementFromCollection(this,t.series)},this),this.parentNode&&(this.parentNodeLayout.removeElementFromCollection(this.parentNode,this.parentNodeLayout.nodes),this.parentNode.dataLabel&&(this.parentNode.dataLabel=this.parentNode.dataLabel.destroy())),H.Series.prototype.destroy.apply(this,arguments)},alignDataLabel:H.Series.prototype.alignDataLabel},{destroy:function(){return this.series.layout&&this.series.layout.removeElementFromCollection(this,this.series.layout.nodes),Point.prototype.destroy.apply(this,arguments)},firePointEvent:function(t,e,i){var o=this.series.options;if(this.isParentNode&&o.parentNode){var a=o.allowPointSelect;o.allowPointSelect=o.parentNode.allowPointSelect,Point.prototype.firePointEvent.apply(this,arguments),o.allowPointSelect=a}else Point.prototype.firePointEvent.apply(this,arguments)},select:function(t,e){var i=this.series.chart;this.isParentNode?(i.getSelectedPoints=i.getSelectedParentNodes,Point.prototype.select.apply(this,arguments),i.getSelectedPoints=Chart.prototype.getSelectedPoints):Point.prototype.select.apply(this,arguments)}}),addEvent(Chart,"beforeRedraw",function(){this.allDataPoints&&delete this.allDataPoints});