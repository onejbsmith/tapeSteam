import BaseSeries from"../Core/Series/Series.js";var seriesTypes=BaseSeries.seriesTypes;import CenteredSeriesMixin from"../Mixins/CenteredSeries.js";var getCenter=CenteredSeriesMixin.getCenter,getStartAndEndRadians=CenteredSeriesMixin.getStartAndEndRadians;import DrawPointMixin from"../Mixins/DrawPoint.js";var drawPoint=DrawPointMixin.drawPoint;import H from"../Core/Globals.js";var noop=H.noop;import TreeSeriesMixin from"../Mixins/TreeSeries.js";var getColor=TreeSeriesMixin.getColor,getLevelOptions=TreeSeriesMixin.getLevelOptions,setTreeValues=TreeSeriesMixin.setTreeValues,updateRootId=TreeSeriesMixin.updateRootId;import U from"../Core/Utilities.js";var correctFloat=U.correctFloat,error=U.error,extend=U.extend,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString,merge=U.merge,splat=U.splat;import"../Series/LineSeries.js";import"./TreemapSeries.js";var Series=H.Series,isBoolean=function(e){return"boolean"==typeof e},rad2deg=180/Math.PI,range=function(e,t){var r,a=[];if(isNumber(e)&&isNumber(t)&&e<=t)for(r=e;r<=t;r++)a.push(r);return a},calculateLevelSizes=function(e,t){var r,a,i,n,o,s,l,d=isObject(t)?t:{},p=0;return isObject(e)&&(r=merge({},e),s=isNumber(d.from)?d.from:0,l=isNumber(d.to)?d.to:0,i=range(s,l),n=Object.keys(r).filter(function(e){return-1===i.indexOf(+e)}),a=o=isNumber(d.diffRadius)?d.diffRadius:0,i.forEach(function(e){var t=r[e],i=t.levelSize.unit,n=t.levelSize.value;"weight"===i?p+=n:"percentage"===i?(t.levelSize={unit:"pixels",value:n/100*a},o-=t.levelSize.value):"pixels"===i&&(o-=n)}),i.forEach(function(e){var t,a=r[e];"weight"===a.levelSize.unit&&(t=a.levelSize.value,r[e].levelSize={unit:"pixels",value:t/p*o})}),n.forEach(function(e){r[e].levelSize={value:0,unit:"pixels"}})),r},getEndPoint=function(e,t,r,a){return{x:e+Math.cos(r)*a,y:t+Math.sin(r)*a}},layoutAlgorithm=function(e,t,r){var a=e.start,i=e.end-a,n=e.val,o=e.x,s=e.y,l=r&&isObject(r.levelSize)&&isNumber(r.levelSize.value)?r.levelSize.value:0,d=e.r,p=d+l,c=r&&isNumber(r.slicedOffset)?r.slicedOffset:0;return(t||[]).reduce(function(e,t){var r=1/n*t.val*i,u=getEndPoint(o,s,a+r/2,c),h={x:t.sliced?u.x:o,y:t.sliced?u.y:s,innerR:d,r:p,radius:l,start:a,end:a+r};return e.push(h),a=h.end,e},[])},getDlOptions=function(e){var t,r,a=e.point,i=isObject(e.shapeArgs)?e.shapeArgs:{},n=isObject(e.optionsPoint)?e.optionsPoint.dataLabels:{},o=splat(isObject(e.level)?e.level.dataLabels:{})[0],s=merge({style:{}},o,n),l=s.rotationMode;return isNumber(s.rotation)||("auto"!==l&&"circular"!==l||(a.innerArcLength<1&&a.outerArcLength>i.radius?(t=0,a.dataLabelPath&&"circular"===l&&(s.textPath={enabled:!0})):a.innerArcLength>1&&a.outerArcLength>1.5*i.radius?"circular"===l?s.textPath={enabled:!0,attributes:{dy:5}}:l="parallel":(a.dataLabel&&a.dataLabel.textPathWrapper&&"circular"===l&&(s.textPath={enabled:!1}),l="perpendicular")),"auto"!==l&&"circular"!==l&&(t=i.end-(i.end-i.start)/2),s.style.width="parallel"===l?Math.min(2.5*i.radius,(a.outerArcLength+a.innerArcLength)/2):i.radius,"perpendicular"===l&&a.series.chart.renderer.fontMetrics(s.style.fontSize).h>a.outerArcLength&&(s.style.width=1),s.style.width=Math.max(s.style.width-2*(s.padding||0),1),r=t*rad2deg%180,"parallel"===l&&(r-=90),r>90?r-=180:r<-90&&(r+=180),s.rotation=r),s.textPath&&(0===a.shapeExisting.innerR&&s.textPath.enabled?(s.rotation=0,s.textPath.enabled=!1,s.style.width=Math.max(2*a.shapeExisting.r-2*(s.padding||0),1)):a.dlOptions&&a.dlOptions.textPath&&!a.dlOptions.textPath.enabled&&"circular"===l&&(s.textPath.enabled=!0),s.textPath.enabled&&(s.rotation=0,s.style.width=Math.max((a.outerArcLength+a.innerArcLength)/2-2*(s.padding||0),1))),0===s.rotation&&(s.rotation=.001),s},getAnimation=function(e,t){var r=t.point,a=t.radians,i=t.innerR,n=t.idRoot,o=t.idPreviousRoot,s=t.shapeExisting,l=t.shapeRoot,d=t.shapePreviousRoot,p=t.visible,c={},u={end:e.end,start:e.start,innerR:e.innerR,r:e.r,x:e.x,y:e.y};return p?!r.graphic&&d&&((c=n===r.id?{start:a.start,end:a.end}:d.end<=e.start?{start:a.end,end:a.end}:{start:a.start,end:a.start}).innerR=c.r=i):r.graphic&&(o===r.id?u={innerR:i,r:i}:l&&(u=l.end<=s.start?{innerR:i,r:i,start:a.end,end:a.end}:{innerR:i,r:i,start:a.start,end:a.start})),{from:c,to:u}},getDrillId=function(e,t,r){var a;return e.node.isLeaf||(a=t===e.id?r[t].parent:e.id),a},getLevelFromAndTo=function(e){var t=e.level;return{from:t>0?t:1,to:t+e.height}},cbSetTreeValuesBefore=function(e,t){var r=t.mapIdToNode[e.parent],a=t.series,i=a.chart,n=a.points[e.i],o=a.options.colors||i&&i.options.colors,s=getColor(e,{colors:o,colorIndex:a.colorIndex,index:t.index,mapOptionsToLevel:t.mapOptionsToLevel,parentColor:r&&r.color,parentColorIndex:r&&r.colorIndex,series:t.series,siblings:t.siblings});return e.color=s.color,e.colorIndex=s.colorIndex,n&&(n.color=e.color,n.colorIndex=e.colorIndex,e.sliced=e.id!==t.idRoot&&n.sliced),e},sunburstOptions={center:["50%","50%"],colorByPoint:!1,opacity:1,dataLabels:{allowOverlap:!0,defer:!0,rotationMode:"auto",style:{textOverflow:"ellipsis"}},rootId:void 0,levelIsConstant:!0,levelSize:{value:1,unit:"weight"},slicedOffset:10},sunburstSeries={drawDataLabels:noop,drawPoints:function(){var e,t=this,r=t.mapOptionsToLevel,a=t.shapeRoot,i=t.group,n=t.hasRendered,o=t.rootNode,s=t.idPreviousRoot,l=t.nodeMap,d=l[s],p=d&&d.shapeArgs,c=t.points,u=t.startAndEndRadians,h=t.chart,v=h&&h.options&&h.options.chart||{},g=!isBoolean(v.animation)||v.animation,f=t.center,b={x:f[0],y:f[1]},m=f[3]/2,x=t.chart.renderer,L=!1,S=!1,P=!!(g&&n&&o!==s&&t.dataLabelsGroup);P&&(t.dataLabelsGroup.attr({opacity:0}),e=function(){var e=t;L=!0,e.dataLabelsGroup&&e.dataLabelsGroup.animate({opacity:1,visibility:"visible"})}),c.forEach(function(d){var c,v,f=d.node,L=r[f.level],P=d.shapeExisting||{},y=f.shapeArgs||{},A=!(!f.visible||!f.shapeArgs);c=n&&g?getAnimation(y,{center:b,point:d,radians:u,innerR:m,idRoot:o,idPreviousRoot:s,shapeExisting:P,shapeRoot:a,shapePreviousRoot:p,visible:A}):{to:y,from:{}},extend(d,{shapeExisting:y,tooltipPos:[y.plotX,y.plotY],drillId:getDrillId(d,o,l),name:""+(d.name||d.id||d.index),plotX:y.plotX,plotY:y.plotY,value:f.val,isNull:!A}),d.dlOptions=getDlOptions({point:d,level:L,optionsPoint:d.options,shapeArgs:y}),!S&&A&&(S=!0,v=e),d.draw({animatableAttribs:c.to,attribs:extend(c.from,!h.styledMode&&t.pointAttribs(d,d.selected&&"select")),onComplete:v,group:i,renderer:x,shapeType:"arc",shapeArgs:y})}),P&&S?(t.hasRendered=!1,t.options.dataLabels.defer=!0,Series.prototype.drawDataLabels.call(t),t.hasRendered=!0,L&&e()):Series.prototype.drawDataLabels.call(t)},pointAttribs:seriesTypes.column.prototype.pointAttribs,layoutAlgorithm:layoutAlgorithm,setShapeArgs:function(e,t,r){var a,i=e.level+1,n=r[i],o=e.children.filter(function(e){return e.visible});a=this.layoutAlgorithm(t,o,n),o.forEach(function(e,t){var i=a[t],n=i.start+(i.end-i.start)/2,o=i.innerR+(i.r-i.innerR)/2,s=i.end-i.start,l=0===i.innerR&&s>6.28?{x:i.x,y:i.y}:getEndPoint(i.x,i.y,n,o),d=e.val?e.childrenTotal>e.val?e.childrenTotal:e.val:e.childrenTotal;this.points[e.i]&&(this.points[e.i].innerArcLength=s*i.innerR,this.points[e.i].outerArcLength=s*i.r),e.shapeArgs=merge(i,{plotX:l.x,plotY:l.y+4*Math.abs(Math.cos(n))}),e.values=merge(i,{val:d}),e.children.length&&this.setShapeArgs(e,e.values,r)},this)},translate:function(){var e,t,r,a,i=this,n=i.options,o=i.center=getCenter.call(i),s=i.startAndEndRadians=getStartAndEndRadians(n.startAngle,n.endAngle),l=o[3]/2,d=o[2]/2-l,p=updateRootId(i),c=i.nodeMap,u=c&&c[p],h={};i.shapeRoot=u&&u.shapeArgs,Series.prototype.translate.call(i),r=i.tree=i.getTree(),i.renderTraverseUpButton(p),u=(c=i.nodeMap)[p],t=c[isString(u.parent)?u.parent:""];var v=getLevelFromAndTo(u),g=v.from,f=v.to;e=getLevelOptions({from:g,levels:i.options.levels,to:f,defaults:{colorByPoint:n.colorByPoint,dataLabels:n.dataLabels,levelIsConstant:n.levelIsConstant,levelSize:n.levelSize,slicedOffset:n.slicedOffset}}),e=calculateLevelSizes(e,{diffRadius:d,from:g,to:f}),setTreeValues(r,{before:cbSetTreeValuesBefore,idRoot:p,levelIsConstant:n.levelIsConstant,mapOptionsToLevel:e,mapIdToNode:c,points:i.points,series:i}),a=c[""].shapeArgs={end:s.end,r:l,start:s.start,val:u.val,x:o[0],y:o[1]},this.setShapeArgs(t,a,e),i.mapOptionsToLevel=e,i.data.forEach(function(e){h[e.id]&&error(31,!1,i.chart),h[e.id]=!0}),h={}},alignDataLabel:function(e,t,r){if(!r.textPath||!r.textPath.enabled)return seriesTypes.treemap.prototype.alignDataLabel.apply(this,arguments)},animate:function(e){var t,r=this.chart,a=[r.plotWidth/2,r.plotHeight/2],i=r.plotLeft,n=r.plotTop,o=this.group;e?(t={translateX:a[0]+i,translateY:a[1]+n,scaleX:.001,scaleY:.001,rotation:10,opacity:.01},o.attr(t)):(t={translateX:i,translateY:n,scaleX:1,scaleY:1,rotation:0,opacity:1},o.animate(t,this.options.animation))},utils:{calculateLevelSizes:calculateLevelSizes,getLevelFromAndTo:getLevelFromAndTo,range:range}},sunburstPoint={draw:drawPoint,shouldDraw:function(){return!this.isNull},isValid:function(){return!0},getDataLabelPath:function(e){var t,r=this.series.chart.renderer,a=this.shapeExisting,i=a.start,n=a.end,o=i+(n-i)/2,s=o<0&&o>-Math.PI||o>Math.PI,l=a.r+(e.options.distance||0);return i===-Math.PI/2&&correctFloat(n)===correctFloat(1.5*Math.PI)&&(i=-Math.PI+Math.PI/360,n=-Math.PI/360,s=!0),n-i>Math.PI&&(s=!1,t=!0),this.dataLabelPath&&(this.dataLabelPath=this.dataLabelPath.destroy()),this.dataLabelPath=r.arc({open:!0,longArc:t?1:0}).add(e),this.dataLabelPath.attr({start:s?i:n,end:s?n:i,clockwise:+s,x:a.x,y:a.y,r:(l+a.innerR)/2}),this.dataLabelPath}};BaseSeries.seriesType("sunburst","treemap",sunburstOptions,sunburstSeries,sunburstPoint);