import Series from"../Core/Series/Series.js";import CartesianSeries from"../Core/Series/CartesianSeries.js";import Color from"../Core/Color/Color.js";import ColumnSeries from"./ColumnSeries.js";import H from"../Core/Globals.js";import NodesMixin from"../Mixins/Nodes.js";import Point from"../Core/Series/Point.js";import TreeSeriesMixin from"../Mixins/TreeSeries.js";var getLevelOptions=TreeSeriesMixin.getLevelOptions;import U from"../Core/Utilities.js";var defined=U.defined,find=U.find,isObject=U.isObject,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,stableSort=U.stableSort,getDLOptions=function(t){var o=isObject(t.optionsPoint)?t.optionsPoint.dataLabels:{},e=isObject(t.level)?t.level.dataLabels:{};return merge({style:{}},e,o)};Series.seriesType("sankey","column",{borderWidth:0,colorByPoint:!0,curveFactor:.33,dataLabels:{enabled:!0,backgroundColor:"none",crop:!1,nodeFormat:void 0,nodeFormatter:function(){return this.point.name},format:void 0,formatter:function(){},inside:!0},inactiveOtherPoints:!0,linkOpacity:.5,minLinkWidth:0,nodeWidth:20,nodePadding:10,showInLegend:!1,states:{hover:{linkOpacity:1},inactive:{linkOpacity:.1,opacity:.1,animation:{duration:50}}},tooltip:{followPointer:!0,headerFormat:'<span style="font-size: 10px">{series.name}</span><br/>',pointFormat:"{point.fromNode.name} â†’ {point.toNode.name}: <b>{point.weight}</b><br/>",nodeFormat:"{point.name}: <b>{point.sum}</b><br/>"}},{isCartesian:!1,invertable:!0,forceDL:!0,orderNodes:!0,pointArrayMap:["from","to"],createNode:NodesMixin.createNode,searchPoint:H.noop,setData:NodesMixin.setData,destroy:NodesMixin.destroy,getNodePadding:function(){var t=this.options.nodePadding||0;if(this.nodeColumns){var o=this.nodeColumns.reduce(function(t,o){return Math.max(t,o.length)},0);o*t>this.chart.plotSizeY&&(t=this.chart.plotSizeY/o)}return t},createNodeColumn:function(){var t=this,o=this.chart,e=[];return e.sum=function(){return this.reduce(function(t,o){return t+o.getSum()},0)},e.offset=function(o,i){for(var n,r=0,s=t.nodePadding,a=0;a<e.length;a++){var l=e[a].getSum(),h=Math.max(l*i,t.options.minLinkWidth);if(n=l?h+s:0,e[a]===o)return{relativeTop:r+relativeLength(o.options.offset||0,n)};r+=n}},e.top=function(e){var i=t.nodePadding,n=this.reduce(function(o,n){return o>0&&(o+=i),o+=Math.max(n.getSum()*e,t.options.minLinkWidth)},0);return(o.plotSizeY-n)/2},e},createNodeColumns:function(){var t=[];this.nodes.forEach(function(o){var e,i,n,r=-1;if(!defined(o.options.column))if(0===o.linksTo.length)o.column=0;else{for(i=0;i<o.linksTo.length;i++)(n=o.linksTo[0]).fromNode.column>r&&(r=(e=n.fromNode).column);o.column=r+1,e&&"hanging"===e.options.layout&&(o.hangsFrom=e,i=-1,find(e.linksFrom,function(t,e){var n=t.toNode===o;return n&&(i=e),n}),o.column+=i)}t[o.column]||(t[o.column]=this.createNodeColumn()),t[o.column].push(o)},this);for(var o=0;o<t.length;o++)void 0===t[o]&&(t[o]=this.createNodeColumn());return t},hasData:function(){return!!this.processedXData.length},pointAttribs:function(t,o){var e=this,i=t.isNode?t.level:t.fromNode.level,n=e.mapOptionsToLevel[i||0]||{},r=t.options,s=n.states&&n.states[o]||{},a=["colorByPoint","borderColor","borderWidth","linkOpacity"].reduce(function(t,o){return t[o]=pick(s[o],r[o],n[o],e.options[o]),t},{}),l=pick(s.color,r.color,a.colorByPoint?t.color:n.color);return t.isNode?{fill:l,stroke:a.borderColor,"stroke-width":a.borderWidth}:{fill:Color.parse(l).setOpacity(a.linkOpacity).get()}},generatePoints:function(){NodesMixin.generatePoints.apply(this,arguments),this.orderNodes&&(this.nodes.filter(function(t){return 0===t.linksTo.length}).forEach(function(t){!function t(o,e){void 0===o.level&&(o.level=e,o.linksFrom.forEach(function(o){o.toNode&&t(o.toNode,e+1)}))}(t,0)}),stableSort(this.nodes,function(t,o){return t.level-o.level}))},translateNode:function(t,o){var e=this.translationFactor,i=this.chart,n=this.options,r=t.getSum(),s=Math.max(Math.round(r*e),this.options.minLinkWidth),a=Math.round(n.borderWidth)%2/2,l=o.offset(t,e),h=Math.floor(pick(l.absoluteTop,o.top(e)+l.relativeTop))+a,d=Math.floor(this.colDistance*t.column+n.borderWidth/2)+a,p=i.inverted?i.plotSizeX-d:d,c=Math.round(this.nodeWidth);t.sum=r,r?(t.shapeType="rect",t.nodeX=p,t.nodeY=h,i.inverted?t.shapeArgs={x:p-c,y:i.plotSizeY-h-s,width:t.options.height||n.height||c,height:t.options.width||n.width||s}:t.shapeArgs={x:p,y:h,width:t.options.width||n.width||c,height:t.options.height||n.height||s},t.shapeArgs.display=t.hasShape()?"":"none",t.dlOptions=getDLOptions({level:this.mapOptionsToLevel[t.level],optionsPoint:t.options}),t.plotY=1,t.tooltipPos=i.inverted?[i.plotSizeY-t.shapeArgs.y-t.shapeArgs.height/2,i.plotSizeX-t.shapeArgs.x-t.shapeArgs.width/2]:[t.shapeArgs.x+t.shapeArgs.width/2,t.shapeArgs.y+t.shapeArgs.height/2]):t.dlOptions={enabled:!1}},translateLink:function(t){var o=function(o,e){var i,n=o.offset(t,e)*r;return Math.min(o.nodeY+n,o.nodeY+(null===(i=o.shapeArgs)||void 0===i?void 0:i.height)-s)},e=t.fromNode,i=t.toNode,n=this.chart,r=this.translationFactor,s=Math.max(t.weight*r,this.options.minLinkWidth),a=this.options,l=(n.inverted?-this.colDistance:this.colDistance)*a.curveFactor,h=o(e,"linksFrom"),d=o(i,"linksTo"),p=e.nodeX,c=this.nodeWidth,u=i.column*this.colDistance,m=t.outgoing,f=u>p+c;if(n.inverted&&(h=n.plotSizeY-h,d=(n.plotSizeY||0)-d,u=n.plotSizeX-u,c=-c,s=-s,f=p>u),t.shapeType="path",t.linkBase=[h,h+s,d,d+s],f&&"number"==typeof d)t.shapeArgs={d:[["M",p+c,h],["C",p+c+l,h,u-l,d,u,d],["L",u+(m?c:0),d+s/2],["L",u,d+s],["C",u-l,d+s,p+c+l,h+s,p+c,h+s],["Z"]]};else if("number"==typeof d){var g=n.plotHeight-h-s,v=u-20-s,C=u-20,b=u,y=p+c,S=y+20,k=S+s,N=h,L=h+s,x=L+20,P=x+g,M=P+20,O=M+s,W=d,w=W+s,T=w+20,z=L-.7*s,A=M+.7*s,F=w-.7*s,D=b-.7*s,Y=y+.7*s;t.shapeArgs={d:[["M",y,N],["C",Y,N,k,z,k,x],["L",k,P],["C",k,A,Y,O,y,O],["L",b,O],["C",D,O,v,A,v,P],["L",v,T],["C",v,F,D,W,b,W],["L",b,w],["C",C,w,C,w,C,T],["L",C,P],["C",C,M,C,M,b,M],["L",y,M],["C",S,M,S,M,S,P],["L",S,x],["C",S,L,S,L,y,L],["Z"]]}}t.dlBox={x:p+(u-p+c)/2,y:h+(d-h)/2,height:s,width:0},t.tooltipPos=n.inverted?[n.plotSizeY-t.dlBox.y-s/2,n.plotSizeX-t.dlBox.x]:[t.dlBox.x,t.dlBox.y+s/2],t.y=t.plotY=1,t.color||(t.color=e.color)},translate:function(){var t=this;this.processedXData||this.processData(),this.generatePoints(),this.nodeColumns=this.createNodeColumns(),this.nodeWidth=relativeLength(this.options.nodeWidth,this.chart.plotSizeX);var o=this,e=this.chart,i=this.options,n=this.nodeWidth,r=this.nodeColumns;this.nodePadding=this.getNodePadding(),this.translationFactor=r.reduce(function(n,r){return Math.min(n,function(n){for(var r,s,a=n.slice(),l=t.options.minLinkWidth||0,h=0,d=e.plotSizeY-i.borderWidth-(n.length-1)*o.nodePadding;n.length;){for(h=d/n.sum(),r=!1,s=n.length;s--;)n[s].getSum()*h<l&&(n.splice(s,1),d-=l,r=!0);if(!r)break}return n.length=0,a.forEach(function(t){return n.push(t)}),h}(r))},1/0),this.colDistance=(e.plotSizeX-n-i.borderWidth)/Math.max(1,r.length-1),o.mapOptionsToLevel=getLevelOptions({from:1,levels:i.levels,to:r.length-1,defaults:{borderColor:i.borderColor,borderRadius:i.borderRadius,borderWidth:i.borderWidth,color:o.color,colorByPoint:i.colorByPoint,levelIsConstant:!0,linkColor:i.linkColor,linkLineWidth:i.linkLineWidth,linkOpacity:i.linkOpacity,states:i.states}}),r.forEach(function(t){t.forEach(function(e){o.translateNode(e,t)})},this),this.nodes.forEach(function(t){t.linksFrom.forEach(function(t){(t.weight||t.isNull)&&t.to&&(o.translateLink(t),t.allowShadow=!1)})})},render:function(){var t=this.points;this.points=this.points.concat(this.nodes||[]),ColumnSeries.prototype.render.call(this),this.points=t},animate:CartesianSeries.prototype.animate},{applyOptions:function(t,o){return Point.prototype.applyOptions.call(this,t,o),defined(this.options.level)&&(this.options.column=this.column=this.options.level),this},setState:NodesMixin.setNodeState,getClassName:function(){return(this.isNode?"highcharts-node ":"highcharts-link ")+Point.prototype.getClassName.call(this)},isValid:function(){return this.isNode||"number"==typeof this.weight}});