import BaseSeries from"../Core/Series/Series.js";import H from"../Core/Globals.js";import Math3D from"../Extensions/Math3D.js";var perspective=Math3D.perspective;import StackItem from"../Extensions/Stacking.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,pick=U.pick,wrap=U.wrap;import"./ColumnSeries.js";import"../Series/LineSeries.js";var Series=H.Series,columnProto=BaseSeries.seriesTypes.column.prototype,svg=H.svg;function retrieveStacks(t,i){var e,s=t.series,o={},r=1;return s.forEach(function(t){e=pick(t.options.stack,i?0:s.length-1-t.index),o[e]?o[e].series.push(t):(o[e]={series:[t],position:r},r++)}),o.totalStacks=r+1,o}function pointAttribs(t){var i=t.apply(this,[].slice.call(arguments,1));return this.chart.is3d&&this.chart.is3d()&&(i.stroke=this.options.edgeColor||i.fill,i["stroke-width"]=pick(this.options.edgeWidth,1)),i}function setState(t,i,e){var s=this.chart.is3d&&this.chart.is3d();s&&(this.options.inactiveOtherPoints=!0),t.call(this,i,e),s&&(this.options.inactiveOtherPoints=!1)}function hasNewShapeType(t){for(var i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];return this.series.chart.is3d()?this.graphic&&"g"!==this.graphic.element.nodeName:t.apply(this,i)}if(wrap(columnProto,"translate",function(t){t.apply(this,[].slice.call(arguments,1)),this.chart.is3d()&&this.translate3dShapes()}),wrap(Series.prototype,"justifyDataLabel",function(t){return!arguments[2].outside3dPlot&&t.apply(this,[].slice.call(arguments,1))}),columnProto.translate3dPoints=function(){},columnProto.translate3dShapes=function(){var t,i=this,e=i.chart,s=i.options,o=s.depth,r=(s.stacking?s.stack||0:i.index)*(o+(s.groupZPadding||1)),a=i.borderWidth%2?.5:0;e.inverted&&!i.yAxis.reversed&&(a*=-1),!1!==s.grouping&&(r=0),r+=s.groupZPadding||1,i.data.forEach(function(s){if(s.outside3dPlot=null,null!==s.y){var p,n=s.shapeArgs,h=s.tooltipPos;[["x","width"],["y","height"]].forEach(function(t){if((p=n[t[0]]-a)<0&&(n[t[1]]+=n[t[0]]+a,n[t[0]]=-a,p=0),p+n[t[1]]>i[t[0]+"Axis"].len&&0!==n[t[1]]&&(n[t[1]]=i[t[0]+"Axis"].len-n[t[0]]),0!==n[t[1]]&&(n[t[0]]>=i[t[0]+"Axis"].len||n[t[0]]+n[t[1]]<=a)){for(var e in n)n[e]=0;s.outside3dPlot=!0}}),"rect"===s.shapeType&&(s.shapeType="cuboid"),n.z=r,n.depth=o,n.insidePlotArea=!0,t={x:n.x+n.width/2,y:n.y,z:r+o/2},e.inverted&&(t.x=n.height,t.y=s.clientX),s.plot3d=perspective([t],e,!0,!1)[0],h=perspective([{x:h[0],y:h[1],z:r+o/2}],e,!0,!1)[0],s.tooltipPos=[h.x,h.y]}}),i.z=r},wrap(columnProto,"animate",function(t){if(this.chart.is3d()){var i=arguments[1],e=this.yAxis,s=this,o=this.yAxis.reversed;svg&&(i?s.data.forEach(function(t){null!==t.y&&(t.height=t.shapeArgs.height,t.shapey=t.shapeArgs.y,t.shapeArgs.height=1,o||(t.stackY?t.shapeArgs.y=t.plotY+e.translate(t.stackY):t.shapeArgs.y=t.plotY+(t.negative?-t.height:t.height)))}):(s.data.forEach(function(t){null!==t.y&&(t.shapeArgs.height=t.height,t.shapeArgs.y=t.shapey,t.graphic&&t.graphic.animate(t.shapeArgs,s.options.animation))}),this.drawDataLabels()))}else t.apply(this,[].slice.call(arguments,1))}),wrap(columnProto,"plotGroup",function(t,i,e,s,o,r){return"dataLabelsGroup"!==i&&this.chart.is3d()&&(this[i]&&delete this[i],r&&(this.chart.columnGroup||(this.chart.columnGroup=this.chart.renderer.g("columnGroup").add(r)),this[i]=this.chart.columnGroup,this.chart.columnGroup.attr(this.getPlotBox()),this[i].survive=!0,"group"!==i&&"markerGroup"!==i||(arguments[3]="visible"))),t.apply(this,Array.prototype.slice.call(arguments,1))}),wrap(columnProto,"setVisible",function(t,i){var e,s=this;s.chart.is3d()&&s.data.forEach(function(t){t.visible=t.options.visible=i=void 0===i?!pick(s.visible,t.visible):i,e=i?"visible":"hidden",s.options.data[s.data.indexOf(t)]=t.options,t.graphic&&t.graphic.attr({visibility:e})}),t.apply(this,Array.prototype.slice.call(arguments,1))}),columnProto.handle3dGrouping=!0,addEvent(Series,"afterInit",function(){if(this.chart.is3d()&&this.handle3dGrouping){var t=this.options,i=t.grouping,e=t.stacking,s=pick(this.yAxis.options.reversedStacks,!0),o=0;if(void 0===i||i){var r,a=retrieveStacks(this.chart,e),p=t.stack||0;for(r=0;r<a[p].series.length&&a[p].series[r]!==this;r++);o=10*(a.totalStacks-a[p].position)+(s?r:-r),this.xAxis.reversed||(o=10*a.totalStacks-o)}t.depth=t.depth||25,this.z=this.z||0,t.zIndex=o}}),wrap(columnProto,"pointAttribs",pointAttribs),wrap(columnProto,"setState",setState),wrap(columnProto.pointClass.prototype,"hasNewShapeType",hasNewShapeType),BaseSeries.seriesTypes.columnRange){var columnRangeProto=BaseSeries.seriesTypes.columnrange.prototype;wrap(columnRangeProto,"pointAttribs",pointAttribs),wrap(columnRangeProto,"setState",setState),wrap(columnRangeProto.pointClass.prototype,"hasNewShapeType",hasNewShapeType),columnRangeProto.plotGroup=columnProto.plotGroup,columnRangeProto.setVisible=columnProto.setVisible}wrap(Series.prototype,"alignDataLabel",function(t,i,e,s,o){var r=this.chart;if(s.outside3dPlot=i.outside3dPlot,r.is3d()&&this.is("column")){var a=this.options,p=pick(s.inside,!!this.options.stacking),n=r.options.chart.options3d,h=i.pointWidth/2||0,l={x:o.x+h,y:o.y,z:this.z+a.depth/2};r.inverted&&(p&&(o.width=0,l.x+=i.shapeArgs.height/2),n.alpha>=90&&n.alpha<=270&&(l.y+=i.shapeArgs.width)),l=perspective([l],r,!0,!1)[0],o.x=l.x-h,o.y=i.outside3dPlot?-9e9:l.y}t.apply(this,[].slice.call(arguments,1))}),wrap(StackItem.prototype,"getStackBox",function(t,i,e,s,o,r,a,p){var n=t.apply(this,[].slice.call(arguments,1));if(i.is3d()&&e.base){var h=+e.base.split(",")[0],l=i.series[h],c=i.options.chart.options3d;if(l&&l instanceof BaseSeries.seriesTypes.column){var d={x:n.x+(i.inverted?a:r/2),y:n.y,z:l.options.depth/2};i.inverted&&(n.width=0,c.alpha>=90&&c.alpha<=270&&(d.y+=r)),d=perspective([d],i,!0,!1)[0],n.x=d.x-r/2,n.y=d.y}}return n});