"use strict";import Color from"./Color/Color.js";var color=Color.parse;import H from"./Globals.js";var charts=H.charts,noop=H.noop;import Tooltip from"./Tooltip.js";import U from"./Utilities.js";var addEvent=U.addEvent,attr=U.attr,css=U.css,defined=U.defined,extend=U.extend,find=U.find,fireEvent=U.fireEvent,isNumber=U.isNumber,isObject=U.isObject,objectEach=U.objectEach,offset=U.offset,pick=U.pick,splat=U.splat,Pointer=function(){function t(t,o){this.lastValidTouch={},this.pinchDown=[],this.runChartClick=!1,this.chart=t,this.hasDragged=!1,this.options=o,this.unbindContainerMouseLeave=function(){},this.unbindContainerMouseEnter=function(){},this.init(t,o)}return t.prototype.applyInactiveState=function(t){var o,e=[];(t||[]).forEach(function(t){o=t.series,e.push(o),o.linkedParent&&e.push(o.linkedParent),o.linkedSeries&&(e=e.concat(o.linkedSeries)),o.navigatorSeries&&e.push(o.navigatorSeries)}),this.chart.series.forEach(function(t){-1===e.indexOf(t)?t.setState("inactive",!0):t.options.inactiveOtherPoints&&t.setAllPointsToState("inactive")})},t.prototype.destroy=function(){var t=this;void 0!==t.unDocMouseMove&&t.unDocMouseMove(),this.unbindContainerMouseLeave(),H.chartCount||(H.unbindDocumentMouseUp&&(H.unbindDocumentMouseUp=H.unbindDocumentMouseUp()),H.unbindDocumentTouchEnd&&(H.unbindDocumentTouchEnd=H.unbindDocumentTouchEnd())),clearInterval(t.tooltipTimeout),objectEach(t,function(o,e){t[e]=void 0})},t.prototype.drag=function(t){var o,e,i=this.chart,n=i.options.chart,r=t.chartX,s=t.chartY,a=this.zoomHor,h=this.zoomVert,c=i.plotLeft,u=i.plotTop,p=i.plotWidth,l=i.plotHeight,d=this.selectionMarker,v=this.mouseDownX||0,f=this.mouseDownY||0,m=isObject(n.panning)?n.panning&&n.panning.enabled:n.panning,x=n.panKey&&t[n.panKey+"Key"];d&&d.touch||(r<c?r=c:r>c+p&&(r=c+p),s<u?s=u:s>u+l&&(s=u+l),this.hasDragged=Math.sqrt(Math.pow(v-r,2)+Math.pow(f-s,2)),this.hasDragged>10&&(o=i.isInsidePlot(v-c,f-u),i.hasCartesianSeries&&(this.zoomX||this.zoomY)&&o&&!x&&(d||(this.selectionMarker=d=i.renderer.rect(c,u,a?1:p,h?1:l,0).attr({class:"highcharts-selection-marker",zIndex:7}).add(),i.styledMode||d.attr({fill:n.selectionMarkerFill||color("#335cad").setOpacity(.25).get()}))),d&&a&&(e=r-v,d.attr({width:Math.abs(e),x:(e>0?0:e)+v})),d&&h&&(e=s-f,d.attr({height:Math.abs(e),y:(e>0?0:e)+f})),o&&!d&&m&&i.pan(t,n.panning)))},t.prototype.dragStart=function(t){var o=this.chart;o.mouseIsDown=t.type,o.cancelClick=!1,o.mouseDownX=this.mouseDownX=t.chartX,o.mouseDownY=this.mouseDownY=t.chartY},t.prototype.drop=function(t){var o=this,e=this.chart,i=this.hasPinched;if(this.selectionMarker){var n,r={originalEvent:t,xAxis:[],yAxis:[]},s=this.selectionMarker,a=s.attr?s.attr("x"):s.x,h=s.attr?s.attr("y"):s.y,c=s.attr?s.attr("width"):s.width,u=s.attr?s.attr("height"):s.height;(this.hasDragged||i)&&(e.axes.forEach(function(e){if(e.zoomEnabled&&defined(e.min)&&(i||o[{xAxis:"zoomX",yAxis:"zoomY"}[e.coll]])&&isNumber(a)&&isNumber(h)){var s=e.horiz,p="touchend"===t.type?e.minPixelPadding:0,l=e.toValue((s?a:h)+p),d=e.toValue((s?a+c:h+u)-p);r[e.coll].push({axis:e,min:Math.min(l,d),max:Math.max(l,d)}),n=!0}}),n&&fireEvent(e,"selection",r,function(t){e.zoom(extend(t,i?{animation:!1}:null))})),isNumber(e.index)&&(this.selectionMarker=this.selectionMarker.destroy()),i&&this.scaleGroups()}e&&isNumber(e.index)&&(css(e.container,{cursor:e._cursor}),e.cancelClick=this.hasDragged>10,e.mouseIsDown=this.hasDragged=this.hasPinched=!1,this.pinchDown=[])},t.prototype.findNearestKDPoint=function(t,o,e){var i,n=this.chart,r=n.hoverPoint,s=n.tooltip;if(r&&s&&s.isStickyOnContact())return r;return t.forEach(function(t){var n,r,s,a,h,c=!(t.noSharedTooltip&&o)&&t.options.findNearestPointBy.indexOf("y")<0,u=t.searchPoint(e,c);isObject(u,!0)&&(!isObject(i,!0)||(r=u,s=(n=i).distX-r.distX,a=n.dist-r.dist,h=(r.series.group&&r.series.group.zIndex)-(n.series.group&&n.series.group.zIndex),(0!==s&&o?s:0!==a?a:0!==h?h:n.series.index>r.series.index?-1:1)>0))&&(i=u)}),i},t.prototype.getChartCoordinatesFromPoint=function(t,o){var e=t.series,i=e.xAxis,n=e.yAxis,r=pick(t.clientX,t.plotX),s=t.shapeArgs;return i&&n?o?{chartX:i.len+i.pos-r,chartY:n.len+n.pos-t.plotY}:{chartX:r+i.pos,chartY:t.plotY+n.pos}:s&&s.x&&s.y?{chartX:s.x,chartY:s.y}:void 0},t.prototype.getChartPosition=function(){return this.chartPosition||(this.chartPosition=offset(this.chart.container))},t.prototype.getCoordinates=function(t){var o={xAxis:[],yAxis:[]};return this.chart.axes.forEach(function(e){o[e.isXAxis?"xAxis":"yAxis"].push({axis:e,value:e.toValue(t[e.horiz?"chartX":"chartY"])})}),o},t.prototype.getHoverData=function(t,o,e,i,n,r){var s,a,h=[],c=o,u=!(!i||!t),p=c&&!c.stickyTracking,l={chartX:r?r.chartX:void 0,chartY:r?r.chartY:void 0,shared:n},d=function(t){return t.visible&&!(!n&&t.directTouch)&&pick(t.options.enableMouseTracking,!0)};return fireEvent(this,"beforeGetHoverData",l),a=p?[c]:e.filter(function(t){return l.filter?l.filter(t):d(t)&&t.stickyTracking}),c=(s=u||!r?t:this.findNearestKDPoint(a,n,r))&&s.series,s&&(n&&!c.noSharedTooltip?(a=e.filter(function(t){return l.filter?l.filter(t):d(t)&&!t.noSharedTooltip})).forEach(function(t){var o=find(t.points,function(t){return t.x===s.x&&!t.isNull});isObject(o)&&(t.chart.isBoosting&&(o=t.getPoint(o)),h.push(o))}):h.push(s)),fireEvent(this,"afterGetHoverData",l={hoverPoint:s}),{hoverPoint:l.hoverPoint,hoverSeries:c,hoverPoints:h}},t.prototype.getPointFromEvent=function(t){for(var o,e=t.target;e&&!o;)o=e.point,e=e.parentNode;return o},t.prototype.onTrackerMouseOut=function(t){var o=this.chart,e=t.relatedTarget||t.toElement,i=o.hoverSeries;this.isDirectTouch=!1,!i||!e||i.stickyTracking||this.inClass(e,"highcharts-tooltip")||this.inClass(e,"highcharts-series-"+i.index)&&this.inClass(e,"highcharts-tracker")||i.onMouseOut()},t.prototype.inClass=function(t,o){for(var e;t;){if(e=attr(t,"class")){if(-1!==e.indexOf(o))return!0;if(-1!==e.indexOf("highcharts-container"))return!1}t=t.parentNode}},t.prototype.init=function(t,o){this.options=o,this.chart=t,this.runChartClick=o.chart.events&&!!o.chart.events.click,this.pinchDown=[],this.lastValidTouch={},Tooltip&&(t.tooltip=new Tooltip(t,o.tooltip),this.followTouchMove=pick(o.tooltip.followTouchMove,!0)),this.setDOMEvents()},t.prototype.normalize=function(t,o){var e=t.touches,i=e?e.length?e.item(0):pick(e.changedTouches,t.changedTouches)[0]:t;o||(o=this.getChartPosition());var n=i.pageX-o.left,r=i.pageY-o.top,s=this.chart.containerScaling;return s&&(n/=s.scaleX,r/=s.scaleY),extend(t,{chartX:Math.round(n),chartY:Math.round(r)})},t.prototype.onContainerClick=function(t){var o=this.chart,e=o.hoverPoint,i=this.normalize(t),n=o.plotLeft,r=o.plotTop;o.cancelClick||(e&&this.inClass(i.target,"highcharts-tracker")?(fireEvent(e.series,"click",extend(i,{point:e})),o.hoverPoint&&e.firePointEvent("click",i)):(extend(i,this.getCoordinates(i)),o.isInsidePlot(i.chartX-n,i.chartY-r)&&fireEvent(o,"click",i)))},t.prototype.onContainerMouseDown=function(t){var o=1==(1&(t.buttons||t.button));t=this.normalize(t),H.isFirefox&&0!==t.button&&this.onContainerMouseMove(t),(void 0===t.button||o)&&(this.zoomOption(t),o&&t.preventDefault&&t.preventDefault(),this.dragStart(t))},t.prototype.onContainerMouseLeave=function(t){var o=charts[pick(H.hoverChartIndex,-1)],e=this.chart.tooltip;t=this.normalize(t),o&&(t.relatedTarget||t.toElement)&&(o.pointer.reset(),o.pointer.chartPosition=void 0),e&&!e.isHidden&&this.reset()},t.prototype.onContainerMouseEnter=function(t){delete this.chartPosition},t.prototype.onContainerMouseMove=function(t){var o=this.chart,e=this.normalize(t);this.setHoverChartIndex(),e.preventDefault||(e.returnValue=!1),"mousedown"===o.mouseIsDown&&this.drag(e),o.openMenu||!this.inClass(e.target,"highcharts-tracker")&&!o.isInsidePlot(e.chartX-o.plotLeft,e.chartY-o.plotTop)||this.runPointActions(e)},t.prototype.onDocumentTouchEnd=function(t){charts[H.hoverChartIndex]&&charts[H.hoverChartIndex].pointer.drop(t)},t.prototype.onContainerTouchMove=function(t){this.touch(t)},t.prototype.onContainerTouchStart=function(t){this.zoomOption(t),this.touch(t,!0)},t.prototype.onDocumentMouseMove=function(t){var o=this.chart,e=this.chartPosition,i=this.normalize(t,e),n=o.tooltip;!e||n&&n.isStickyOnContact()||o.isInsidePlot(i.chartX-o.plotLeft,i.chartY-o.plotTop)||this.inClass(i.target,"highcharts-tracker")||this.reset()},t.prototype.onDocumentMouseUp=function(t){var o=charts[pick(H.hoverChartIndex,-1)];o&&o.pointer.drop(t)},t.prototype.pinch=function(t){var o=this,e=o.chart,i=o.pinchDown,n=t.touches||[],r=n.length,s=o.lastValidTouch,a=o.hasZoom,h=o.selectionMarker,c={},u=1===r&&(o.inClass(t.target,"highcharts-tracker")&&e.runTrackerClick||o.runChartClick),p={};r>1&&(o.initiated=!0),a&&o.initiated&&!u&&!1!==t.cancelable&&t.preventDefault(),[].map.call(n,function(t){return o.normalize(t)}),"touchstart"===t.type?([].forEach.call(n,function(t,o){i[o]={chartX:t.chartX,chartY:t.chartY}}),s.x=[i[0].chartX,i[1]&&i[1].chartX],s.y=[i[0].chartY,i[1]&&i[1].chartY],e.axes.forEach(function(t){if(t.zoomEnabled){var o=e.bounds[t.horiz?"h":"v"],i=t.minPixelPadding,n=t.toPixels(Math.min(pick(t.options.min,t.dataMin),t.dataMin)),r=t.toPixels(Math.max(pick(t.options.max,t.dataMax),t.dataMax)),s=Math.min(n,r),a=Math.max(n,r);o.min=Math.min(t.pos,s-i),o.max=Math.max(t.pos+t.len,a+i)}}),o.res=!0):o.followTouchMove&&1===r?this.runPointActions(o.normalize(t)):i.length&&(h||(o.selectionMarker=h=extend({destroy:noop,touch:!0},e.plotBox)),o.pinchTranslate(i,n,c,h,p,s),o.hasPinched=a,o.scaleGroups(c,p),o.res&&(o.res=!1,this.reset(!1,0)))},t.prototype.pinchTranslate=function(t,o,e,i,n,r){this.zoomHor&&this.pinchTranslateDirection(!0,t,o,e,i,n,r),this.zoomVert&&this.pinchTranslateDirection(!1,t,o,e,i,n,r)},t.prototype.pinchTranslateDirection=function(t,o,e,i,n,r,s,a){var h,c,u,p,l,d,v=this.chart,f=t?"x":"y",m=t?"X":"Y",x="chart"+m,M=t?"width":"height",g=v["plot"+(t?"Left":"Top")],y=a||1,C=v.inverted,P=v.bounds[t?"h":"v"],D=1===o.length,b=o[0][x],k=e[0][x],E=!D&&o[1][x],T=!D&&e[1][x],H=function(){"number"==typeof T&&Math.abs(b-E)>20&&(y=a||Math.abs(k-T)/Math.abs(b-E)),u=(g-k)/y+b,h=v["plot"+(t?"Width":"Height")]/y};H(),(c=u)<P.min?(c=P.min,p=!0):c+h>P.max&&(c=P.max-h,p=!0),p?(k-=.8*(k-s[f][0]),"number"==typeof T&&(T-=.8*(T-s[f][1])),H()):s[f]=[k,T],C||(r[f]=u-g,r[M]=h),d=C?t?"scaleY":"scaleX":"scale"+m,l=C?1/y:y,n[M]=h,n[f]=c,i[d]=y,i["translate"+m]=l*g+(k-l*b)},t.prototype.reset=function(t,o){var e=this.chart,i=e.hoverSeries,n=e.hoverPoint,r=e.hoverPoints,s=e.tooltip,a=s&&s.shared?r:n;t&&a&&splat(a).forEach(function(o){o.series.isCartesian&&void 0===o.plotX&&(t=!1)}),t?s&&a&&splat(a).length&&(s.refresh(a),s.shared&&r?r.forEach(function(t){t.setState(t.state,!0),t.series.isCartesian&&(t.series.xAxis.crosshair&&t.series.xAxis.drawCrosshair(null,t),t.series.yAxis.crosshair&&t.series.yAxis.drawCrosshair(null,t))}):n&&(n.setState(n.state,!0),e.axes.forEach(function(t){t.crosshair&&n.series[t.coll]===t&&t.drawCrosshair(null,n)}))):(n&&n.onMouseOut(),r&&r.forEach(function(t){t.setState()}),i&&i.onMouseOut(),s&&s.hide(o),this.unDocMouseMove&&(this.unDocMouseMove=this.unDocMouseMove()),e.axes.forEach(function(t){t.hideCrosshair()}),this.hoverX=e.hoverPoints=e.hoverPoint=null)},t.prototype.runPointActions=function(t,o){var e,i,n,r,s=this.chart,a=s.series,h=s.tooltip&&s.tooltip.options.enabled?s.tooltip:void 0,c=!!h&&h.shared,u=o||s.hoverPoint,p=u&&u.series||s.hoverSeries,l=(!t||"touchmove"!==t.type)&&(!!o||p&&p.directTouch&&this.isDirectTouch),d=this.getHoverData(u,p,a,l,c,t);if(u=d.hoverPoint,r=d.hoverPoints,i=(p=d.hoverSeries)&&p.tooltipOptions.followPointer,e=c&&p&&!p.noSharedTooltip,u&&(u!==s.hoverPoint||h&&h.isHidden)){if((s.hoverPoints||[]).forEach(function(t){-1===r.indexOf(t)&&t.setState()}),s.hoverSeries!==p&&p.onMouseOver(),this.applyInactiveState(r),(r||[]).forEach(function(t){t.setState("hover")}),s.hoverPoint&&s.hoverPoint.firePointEvent("mouseOut"),!u.series)return;s.hoverPoints=r,s.hoverPoint=u,u.firePointEvent("mouseOver"),h&&h.refresh(e?r:u,t)}else i&&h&&!h.isHidden&&(n=h.getAnchor([{}],t),h.updatePosition({plotX:n[0],plotY:n[1]}));this.unDocMouseMove||(this.unDocMouseMove=addEvent(s.container.ownerDocument,"mousemove",function(t){var o=charts[H.hoverChartIndex];o&&o.pointer.onDocumentMouseMove(t)})),s.axes.forEach(function(o){var e,i=pick((o.crosshair||{}).snap,!0);i&&((e=s.hoverPoint)&&e.series[o.coll]===o||(e=find(r,function(t){return t.series[o.coll]===o}))),e||!i?o.drawCrosshair(t,e):o.hideCrosshair()})},t.prototype.scaleGroups=function(t,o){var e,i=this.chart;i.series.forEach(function(n){e=t||n.getPlotBox(),n.xAxis&&n.xAxis.zoomEnabled&&n.group&&(n.group.attr(e),n.markerGroup&&(n.markerGroup.attr(e),n.markerGroup.clip(o?i.clipRect:null)),n.dataLabelsGroup&&n.dataLabelsGroup.attr(e))}),i.clipRect.attr(o||i.clipBox)},t.prototype.setDOMEvents=function(){var t=this.chart.container,o=t.ownerDocument;t.onmousedown=this.onContainerMouseDown.bind(this),t.onmousemove=this.onContainerMouseMove.bind(this),t.onclick=this.onContainerClick.bind(this),this.unbindContainerMouseEnter=addEvent(t,"mouseenter",this.onContainerMouseEnter.bind(this)),this.unbindContainerMouseLeave=addEvent(t,"mouseleave",this.onContainerMouseLeave.bind(this)),H.unbindDocumentMouseUp||(H.unbindDocumentMouseUp=addEvent(o,"mouseup",this.onDocumentMouseUp.bind(this))),H.hasTouch&&(addEvent(t,"touchstart",this.onContainerTouchStart.bind(this)),addEvent(t,"touchmove",this.onContainerTouchMove.bind(this)),H.unbindDocumentTouchEnd||(H.unbindDocumentTouchEnd=addEvent(o,"touchend",this.onDocumentTouchEnd.bind(this))))},t.prototype.setHoverChartIndex=function(){var t=this.chart,o=H.charts[pick(H.hoverChartIndex,-1)];o&&o!==t&&o.pointer.onContainerMouseLeave({relatedTarget:!0}),o&&o.mouseIsDown||(H.hoverChartIndex=t.index)},t.prototype.touch=function(t,o){var e,i,n=this.chart;this.setHoverChartIndex(),1===t.touches.length?(t=this.normalize(t),n.isInsidePlot(t.chartX-n.plotLeft,t.chartY-n.plotTop)&&!n.openMenu?(o&&this.runPointActions(t),"touchmove"===t.type&&(e=!!(i=this.pinchDown)[0]&&Math.sqrt(Math.pow(i[0].chartX-t.chartX,2)+Math.pow(i[0].chartY-t.chartY,2))>=4),pick(e,!0)&&this.pinch(t)):o&&this.reset()):2===t.touches.length&&this.pinch(t)},t.prototype.zoomOption=function(t){var o,e,i=this.chart,n=i.options.chart,r=n.zoomType||"",s=i.inverted;/touch/.test(t.type)&&(r=pick(n.pinchType,r)),this.zoomX=o=/x/.test(r),this.zoomY=e=/y/.test(r),this.zoomHor=o&&!s||e&&s,this.zoomVert=e&&!s||o&&s,this.hasZoom=o||e},t}();H.Pointer=Pointer;export default Pointer;