"use strict";import Axis from"./Axis.js";import H from"../Globals.js";import CartesianSeries from"../Series/CartesianSeries.js";import U from"../Utilities.js";var OrdinalAxis,addEvent=U.addEvent,css=U.css,defined=U.defined,pick=U.pick,timeUnits=U.timeUnits;import Chart from"../Chart/Chart.js";import"../Navigator.js";!function(t){var i=function(){function t(t){this.index={},this.axis=t}return t.prototype.beforeSetTickPositions=function(){var t,i,o,n,s,e,r,a,l=this.axis,d=l.ordinal,p=[],h=!1,c=l.getExtremes(),f=c.min,v=c.max,u=l.isXAxis&&!!l.options.breaks,g=l.options.ordinal,x=Number.MAX_VALUE,m=l.chart.options.chart.ignoreHiddenSeries;if(g||u){if(l.series.forEach(function(o,n){if(i=[],(!m||!1!==o.visible)&&(!1!==o.takeOrdinalPosition||u)&&(p=p.concat(o.processedXData),t=p.length,p.sort(function(t,i){return t-i}),x=Math.min(x,pick(o.closestPointRange,x)),t)){for(n=0;n<t-1;)p[n]!==p[n+1]&&i.push(p[n+1]),n++;i[0]!==p[0]&&i.unshift(p[0]),p=i}o.isSeriesBoosting&&(a=!0)}),a&&(p.length=0),(t=p.length)>2){for(o=p[1]-p[0],r=t-1;r--&&!h;)p[r+1]-p[r]!==o&&(h=!0);!l.options.keepOrdinalPadding&&(p[0]-f>o||v-p[p.length-1]>o)&&(h=!0)}else l.options.overscroll&&(2===t?x=p[1]-p[0]:1===t?(x=l.options.overscroll,p=[p[0],p[0]+x]):x=d.overscrollPointsRange);h?(l.options.overscroll&&(d.overscrollPointsRange=x,p=p.concat(d.getOverscrollPositions())),d.positions=p,n=l.ordinal2lin(Math.max(f,p[0]),!0),s=Math.max(l.ordinal2lin(Math.min(v,p[p.length-1]),!0),1),d.slope=e=(v-f)/(s-n),d.offset=f-n*e):(d.overscrollPointsRange=pick(l.closestPointRange,d.overscrollPointsRange),d.positions=l.ordinal.slope=d.offset=void 0)}l.isOrdinal=g&&h,d.groupIntervalFactor=null},t.prototype.getExtendedPositions=function(){var t,i,o=this,n=o.axis,s=n.constructor.prototype,e=n.chart,r=n.series[0].currentDataGrouping,a=o.index,l=r?r.count+r.unitName:"raw",d=n.options.overscroll,p=n.getExtremes();return a||(a=o.index={}),a[l]||((t={series:[],chart:e,getExtremes:function(){return{min:p.dataMin,max:p.dataMax+d}},options:{ordinal:!0},ordinal:{},ordinal2lin:s.ordinal2lin,val2lin:s.val2lin}).ordinal.axis=t,n.series.forEach(function(n){(i={xAxis:t,xData:n.xData.slice(),chart:e,destroyGroupedData:H.noop,getProcessedData:CartesianSeries.prototype.getProcessedData}).xData=i.xData.concat(o.getOverscrollPositions()),i.options={dataGrouping:r?{enabled:!0,forced:!0,approximation:"open",units:[[r.unitName,[r.count]]]}:{enabled:!1}},n.processData.apply(i),t.series.push(i)}),n.ordinal.beforeSetTickPositions.apply({axis:t}),a[l]=t.ordinal.positions),a[l]},t.prototype.getGroupIntervalFactor=function(t,i,o){this.axis;var n,s,e=o.processedXData,r=e.length,a=[],l=this.groupIntervalFactor;if(!l){for(n=0;n<r-1;n++)a[n]=e[n+1]-e[n];a.sort(function(t,i){return t-i}),s=a[Math.floor(r/2)],t=Math.max(t,e[0]),i=Math.min(i,e[r-1]),this.groupIntervalFactor=l=r*s/(i-t)}return l},t.prototype.getOverscrollPositions=function(){var t=this.axis,i=t.options.overscroll,o=this.overscrollPointsRange,n=[],s=t.dataMax;if(defined(o))for(n.push(s);s<=t.dataMax+i;)s+=o,n.push(s);return n},t.prototype.postProcessTickInterval=function(t){var i=this.axis,o=this.slope;return o?i.options.breaks?i.closestPointRange||t:t/(o/i.closestPointRange):t},t}();t.Composition=i,t.compose=function(i,o,n){i.keepProps.push("ordinal");var s=i.prototype;i.prototype.getTimeTicks=function(t,i,o,n,s,e,r){void 0===s&&(s=[]),void 0===e&&(e=0);var a,l,d,p,h,c,f=0,v={},u=[],g=-Number.MAX_VALUE,x=this.options.tickPixelInterval,m=this.chart.time,P=[];if(!this.options.ordinal&&!this.options.breaks||!s||s.length<3||void 0===i)return m.getTimeTicks.apply(m,arguments);for(h=s.length,a=0;a<h;a++){if(c=a&&s[a-1]>o,s[a]<i&&(f=a),a===h-1||s[a+1]-s[a]>5*e||c){if(s[a]>g){for(l=m.getTimeTicks(t,s[f],s[a],n);l.length&&l[0]<=g;)l.shift();l.length&&(g=l[l.length-1]),P.push(u.length),u=u.concat(l)}f=a+1}if(c)break}if(p=l.info,r&&p.unitRange<=timeUnits.hour){for(a=u.length-1,f=1;f<a;f++)m.dateFormat("%d",u[f])!==m.dateFormat("%d",u[f-1])&&(v[u[f]]="day",d=!0);d&&(v[u[0]]="day"),p.higherRanks=v}if(p.segmentStarts=P,u.info=p,r&&defined(x)){for(var k,y,M,A,E,D=u.length,b=D,R=[],S=[];b--;)y=this.translate(u[b]),M&&(S[b]=M-y),R[b]=M=y;for(S.sort(),(A=S[Math.floor(S.length/2)])<.6*x&&(A=null),b=u[D-1]>o?D-1:D,M=void 0;b--;)y=R[b],E=Math.abs(M-y),M&&E<.8*x&&(null===A||E<.8*A)?(v[u[b]]&&!v[u[b+1]]?(k=b+1,M=y):k=b,u.splice(k,1)):M=y}return u},s.lin2val=function(t,i){var o=this.ordinal,n=o.positions;if(n){var s,e,r=o.slope,a=o.offset,l=n.length-1;if(i)t<0?t=n[0]:t>l?t=n[l]:e=t-(l=Math.floor(t));else for(;l--;)if(t>=(s=r*l+a)){e=(t-s)/(r*(l+1)+a-s);break}return void 0!==e&&void 0!==n[l]?n[l]+(e?e*(n[l+1]-n[l]):0):t}return t},s.val2lin=function(t,i){var o,n=this.ordinal,s=n.positions;if(s){var e,r,a=s.length;for(e=a;e--;)if(s[e]===t){r=e;break}for(e=a-1;e--;)if(t>s[e]||0===e){r=e+(t-s[e])/(s[e+1]-s[e]);break}o=i?r:n.slope*(r||0)+n.offset}else o=t;return o},s.ordinal2lin=s.val2lin,addEvent(i,"afterInit",function(){this.ordinal||(this.ordinal=new t.Composition(this))}),addEvent(i,"foundExtremes",function(){this.isXAxis&&defined(this.options.overscroll)&&this.max===this.dataMax&&(!this.chart.mouseIsDown||this.isInternal)&&(!this.eventArgs||this.eventArgs&&"navigator"!==this.eventArgs.trigger)&&(this.max+=this.options.overscroll,!this.isInternal&&defined(this.userMin)&&(this.min+=this.options.overscroll))}),addEvent(i,"afterSetScale",function(){this.horiz&&!this.isDirty&&(this.isDirty=this.isOrdinal&&this.chart.navigator&&!this.chart.navigator.adaptToUpdatedData)}),addEvent(i,"initialAxisTranslation",function(){this.ordinal&&(this.ordinal.beforeSetTickPositions(),this.tickInterval=this.ordinal.postProcessTickInterval(this.tickInterval))}),addEvent(o,"pan",function(t){var i=this.xAxis[0],o=i.options.overscroll,n=t.originalEvent.chartX,s=this.options.chart&&this.options.chart.panning,e=!1;if(s&&"y"!==s.type&&i.options.ordinal&&i.series.length){var r,a,l,d,p=this.mouseDownX,h=i.getExtremes(),c=h.dataMax,f=h.min,v=h.max,u=this.hoverPoints,g=i.closestPointRange||i.ordinal&&i.ordinal.overscrollPointsRange,x=(p-n)/(i.translationSlope*(i.ordinal.slope||g)),m={ordinal:{positions:i.ordinal.getExtendedPositions()}},P=i.lin2val,k=i.val2lin;m.ordinal.positions?Math.abs(x)>1&&(u&&u.forEach(function(t){t.setState()}),x<0?(l=m,d=i.ordinal.positions?i:m):(l=i.ordinal.positions?i:m,d=m),c>(a=d.ordinal.positions)[a.length-1]&&a.push(c),this.fixedRange=v-f,(r=i.navigatorAxis.toFixedRange(null,null,P.apply(l,[k.apply(l,[f,!0])+x,!0]),P.apply(d,[k.apply(d,[v,!0])+x,!0]))).min>=Math.min(h.dataMin,f)&&r.max<=Math.max(c,v)+o&&i.setExtremes(r.min,r.max,!0,!1,{trigger:"pan"}),this.mouseDownX=n,css(this.container,{cursor:"move"})):e=!0}else e=!0;e||s&&/y/.test(s.type)?o&&(i.max=i.dataMax+o):t.preventDefault()}),addEvent(n,"updatedData",function(){var t=this.xAxis;t&&t.options.ordinal&&delete t.ordinal.index})}}(OrdinalAxis||(OrdinalAxis={})),OrdinalAxis.compose(Axis,Chart,CartesianSeries);export default OrdinalAxis;