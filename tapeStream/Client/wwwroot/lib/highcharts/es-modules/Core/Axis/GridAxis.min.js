"use strict";import Axis from"./Axis.js";import H from"../Globals.js";import O from"../Options.js";var dateFormat=O.dateFormat;import Tick from"./Tick.js";import U from"../Utilities.js";var addEvent=U.addEvent,defined=U.defined,erase=U.erase,find=U.find,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,pick=U.pick,timeUnits=U.timeUnits,wrap=U.wrap,argsToArray=function(t){return Array.prototype.slice.call(t,1)},isObject=function(t){return U.isObject(t,!0)},Chart=H.Chart,applyGridOptions=function(t){var i=t.options;i.labels||(i.labels={}),i.labels.align=pick(i.labels.align,"center"),t.categories||(i.showLastLabel=!1),t.labelRotation=0,i.labels.rotation=0};Axis.prototype.getMaxLabelDimensions=function(t,i){var e={width:0,height:0};return i.forEach(function(i){var s,r=t[i],n=0,o=0;isObject(r)&&(n=(s=isObject(r.label)?r.label:{}).getBBox?s.getBBox().height:0,s.textStr&&!isNumber(s.textPxLength)&&(s.textPxLength=s.getBBox().width),o=isNumber(s.textPxLength)?Math.round(s.textPxLength):0,s.textStr&&(o=Math.round(s.getBBox().width)),e.height=Math.max(n,e.height),e.width=Math.max(o,e.width))}),e},H.dateFormats.W=function(t){var i=new this.Date(t),e=(this.get("Day",i)+6)%7,s=new this.Date(i.valueOf());this.set("Date",s,this.get("Date",i)-e+3);var r=new this.Date(this.get("FullYear",s),0,1);return 4!==this.get("Day",r)&&(this.set("Month",i,0),this.set("Date",i,1+(11-this.get("Day",r))%7)),(1+Math.floor((s.valueOf()-r.valueOf())/6048e5)).toString()},H.dateFormats.E=function(t){return this.dateFormat("%a",t,!0).charAt(0)},addEvent(Chart,"afterSetChartSize",function(){this.axes.forEach(function(t){(t.grid&&t.grid.columns||[]).forEach(function(t){t.setAxisSize(),t.setAxisTranslation()})})}),addEvent(Tick,"afterGetLabelPosition",function(t){var i,e,s,r,n,o,a,h=this.label,d=this.axis,l=d.reversed,c=d.chart,f=d.options.grid||{},g=d.options.labels,u=g.align,m=GridAxis.Side[d.side],p=t.tickmarkOffset,x=d.tickPositions,k=this.pos-p,b=isNumber(x[t.index+1])?x[t.index+1]-p:d.max+p,v=d.tickSize("tick"),A=v?v[0]:0,P=v?v[1]/2:0;!0===f.enabled&&("top"===m?n=(r=d.top+d.offset)-A:"bottom"===m?r=(n=c.chartHeight-d.bottom+d.offset)+A:(r=d.top+d.len-d.translate(l?b:k),n=d.top+d.len-d.translate(l?k:b)),"right"===m?a=(o=c.chartWidth-d.right+d.offset)+A:"left"===m?o=(a=d.left+d.offset)-A:(o=Math.round(d.left+d.translate(l?b:k))-P,a=Math.round(d.left+d.translate(l?k:b))-P),this.slotWidth=a-o,t.pos.x="left"===u?o:"right"===u?a:o+(a-o)/2,t.pos.y=n+(r-n)/2,e=c.renderer.fontMetrics(g.style.fontSize,h.element),i=h.getBBox().height,g.useHTML?t.pos.y+=e.b+-i/2:(s=Math.round(i/e.h),t.pos.y+=(e.b-(e.h-e.f))/2+-(s-1)*e.h/2),t.pos.x+=d.horiz&&g.x||0)});var GridAxisAdditions=function(){function t(t){this.axis=t}return t.prototype.isOuterAxis=function(){var t=this.axis,i=t.chart,e=t.grid.columnIndex,s=t.linkedParent&&t.linkedParent.grid.columns||t.grid.columns,r=e?t.linkedParent:t,n=-1,o=0;return i[t.coll].forEach(function(i,e){i.side!==t.side||i.options.isInternal||(o=e,i===r&&(n=e))}),o===n&&(!isNumber(e)||s.length===e)},t.prototype.renderBorder=function(t){var i=this.axis,e=i.chart.renderer,s=i.options,r=e.path(t).addClass("highcharts-axis-line").add(i.axisBorder);return e.styledMode||r.attr({stroke:s.lineColor,"stroke-width":s.lineWidth,zIndex:7}),r},t}(),GridAxis=function(){function t(){}return t.compose=function(i){Axis.keepProps.push("grid"),wrap(i.prototype,"unsquish",t.wrapUnsquish),addEvent(i,"init",t.onInit),addEvent(i,"afterGetOffset",t.onAfterGetOffset),addEvent(i,"afterGetTitlePosition",t.onAfterGetTitlePosition),addEvent(i,"afterInit",t.onAfterInit),addEvent(i,"afterRender",t.onAfterRender),addEvent(i,"afterSetAxisTranslation",t.onAfterSetAxisTranslation),addEvent(i,"afterSetOptions",t.onAfterSetOptions),addEvent(i,"afterSetOptions",t.onAfterSetOptions2),addEvent(i,"afterSetScale",t.onAfterSetScale),addEvent(i,"afterTickSize",t.onAfterTickSize),addEvent(i,"trimTicks",t.onTrimTicks),addEvent(i,"destroy",t.onDestroy)},t.onAfterGetOffset=function(){var t=this.grid;(t&&t.columns||[]).forEach(function(t){t.getOffset()})},t.onAfterGetTitlePosition=function(i){if(!0===(this.options.grid||{}).enabled){var e=this.axisTitle,s=this.height,r=this.horiz,n=this.left,o=this.offset,a=this.opposite,h=this.options.title,d=void 0===h?{}:h,l=this.top,c=this.width,f=this.tickSize(),g=e&&e.getBBox().width,u=d.x||0,m=d.y||0,p=pick(d.margin,r?5:10),x=this.chart.renderer.fontMetrics(d.style&&d.style.fontSize,e).f,k=(r?l+s:n)+(r?1:-1)*(a?-1:1)*(f?f[0]/2:0)+(this.side===t.Side.bottom?x:0);i.titlePosition.x=r?n-g/2-p+u:k+(a?c:0)+o+u,i.titlePosition.y=r?k-(a?s:0)+(a?x:-x)/2+o+m:l-p+m}},t.onAfterInit=function(){var t=this.chart,i=this.options.grid,e=void 0===i?{}:i,s=this.userOptions;if(e.enabled&&(applyGridOptions(this),wrap(this,"labelFormatter",function(t){var i,e=this.axis,s=this.value,r=e.tickPositions,n=(e.isLinked?e.linkedParent:e).series[0],o=s===r[0],a=s===r[r.length-1],h=n&&find(n.options.data,function(t){return t[e.isXAxis?"x":"y"]===s});return h&&n.is("gantt")&&(i=merge(h),H.seriesTypes.gantt.prototype.setGanttPointAliases(i)),this.isFirst=o,this.isLast=a,this.point=i,t.call(this)})),e.columns)for(var r=this.grid.columns=[],n=this.grid.columnIndex=0;++n<e.columns.length;){var o=merge(s,e.columns[e.columns.length-n-1],{linkedTo:0,type:"category",scrollbar:{enabled:!1}});delete o.grid.columns;var a=new Axis(this.chart,o);a.grid.isColumn=!0,a.grid.columnIndex=n,erase(t.axes,a),erase(t[this.coll],a),r.push(a)}},t.onAfterRender=function(){var i,e=this.grid,s=this.options;if(!0===(s.grid||{}).enabled){if(this.maxLabelDimensions=this.getMaxLabelDimensions(this.ticks,this.tickPositions),this.rightWall&&this.rightWall.destroy(),this.grid&&this.grid.isOuterAxis()&&this.axisLine){var r=s.lineWidth;if(r){var n=this.getLinePath(r),o=n[0],a=n[1],h=((this.tickSize("tick")||[1])[0]-1)*(this.side===t.Side.top||this.side===t.Side.left?-1:1);if("M"===o[0]&&"L"===a[0]&&(this.horiz?(o[2]+=h,a[2]+=h):(o[1]+=h,a[1]+=h)),!this.horiz&&this.chart.marginRight){var d=[o,["L",this.left,o[2]]],l=["L",this.chart.chartWidth-this.chart.marginRight,this.toPixels(this.max+this.tickmarkOffset)],c=[["M",a[1],this.toPixels(this.max+this.tickmarkOffset)],l];this.grid.upperBorder||this.min%1==0||(this.grid.upperBorder=this.grid.renderBorder(d)),this.grid.upperBorder&&this.grid.upperBorder.animate({d:d}),this.grid.lowerBorder||this.max%1==0||(this.grid.lowerBorder=this.grid.renderBorder(c)),this.grid.lowerBorder&&this.grid.lowerBorder.animate({d:c})}this.grid.axisLineExtra?this.grid.axisLineExtra.animate({d:n}):this.grid.axisLineExtra=this.grid.renderBorder(n),this.axisLine[this.showAxis?"show":"hide"](!0)}}if((e&&e.columns||[]).forEach(function(t){t.render()}),!this.horiz&&this.chart.hasRendered&&(this.scrollbar||(null===(i=this.linkedParent)||void 0===i?void 0:i.scrollbar))){var f=this.max,g=this.min,u=this.tickmarkOffset,m=this.tickPositions[this.tickPositions.length-1],p=this.tickPositions[0];g-p>u?this.ticks[p].label.hide():this.ticks[p].label.show(),m-f>u?this.ticks[m].label.hide():this.ticks[m].label.show(),m-f<u&&m-f>0&&this.ticks[m].isLast?this.ticks[m].mark.hide():this.ticks[m-1].mark.show()}}},t.onAfterSetAxisTranslation=function(){var t,i=this.tickPositions&&this.tickPositions.info,e=this.options,s=e.grid||{},r=this.userOptions.labels||{};this.horiz?(!0===s.enabled&&this.series.forEach(function(t){t.options.pointRange=0}),i&&e.dateTimeLabelFormats&&e.labels&&!defined(r.align)&&(!1===e.dateTimeLabelFormats[i.unitName].range||i.count>1)&&(e.labels.align="left",defined(r.x)||(e.labels.x=3))):"treegrid"!==this.options.type&&(null===(t=this.grid)||void 0===t?void 0:t.columns)&&(this.minPointOffset=this.tickInterval)},t.onAfterSetOptions=function(t){var i,e=this.options,s=t.userOptions,r=e&&isObject(e.grid)?e.grid:{};!0===r.enabled&&(i=merge(!0,{className:"highcharts-grid-axis "+(s.className||""),dateTimeLabelFormats:{hour:{list:["%H:%M","%H"]},day:{list:["%A, %e. %B","%a, %e. %b","%E"]},week:{list:["Week %W","W%W"]},month:{list:["%B","%b","%o"]}},grid:{borderWidth:1},labels:{padding:2,style:{fontSize:"13px"}},margin:0,title:{text:null,reserveSpace:!1,rotation:0},units:[["millisecond",[1,10,100]],["second",[1,10]],["minute",[1,5,15]],["hour",[1,6]],["day",[1]],["week",[1]],["month",[1]],["year",null]]},s),"xAxis"===this.coll&&(defined(s.linkedTo)&&!defined(s.tickPixelInterval)&&(i.tickPixelInterval=350),defined(s.tickPixelInterval)||!defined(s.linkedTo)||defined(s.tickPositioner)||defined(s.tickInterval)||(i.tickPositioner=function(t,e){var s=this.linkedParent&&this.linkedParent.tickPositions&&this.linkedParent.tickPositions.info;if(s){var r,n,o,a,h,d=i.units;for(a=0;a<d.length;a++)if(d[a][0]===s.unitName){r=a;break}return d[r+1]?(o=d[r+1][0],n=(d[r+1][1]||[1])[0]):"year"===s.unitName&&(o="year",n=10*s.count),h=timeUnits[o],this.tickInterval=h*n,this.getTimeTicks({unitRange:h,count:n,unitName:o},t,e,this.options.startOfWeek)}})),merge(!0,this.options,i),this.horiz&&(e.minPadding=pick(s.minPadding,0),e.maxPadding=pick(s.maxPadding,0)),isNumber(e.grid.borderWidth)&&(e.tickWidth=e.lineWidth=r.borderWidth))},t.onAfterSetOptions2=function(t){var i=t.userOptions,e=i&&i.grid||{},s=e.columns;e.enabled&&s&&merge(!0,this.options,s[s.length-1])},t.onAfterSetScale=function(){(this.grid.columns||[]).forEach(function(t){t.setScale()})},t.onAfterTickSize=function(t){var i=Axis.defaultLeftAxisOptions,e=this.horiz,s=this.maxLabelDimensions,r=this.options.grid,n=void 0===r?{}:r;if(n.enabled&&s){var o=2*Math.abs(i.labels.x),a=e?n.cellHeight||o+s.height:o+s.width;isArray(t.tickSize)?t.tickSize[0]=a:t.tickSize=[a,0]}},t.onDestroy=function(t){var i=this.grid;(i.columns||[]).forEach(function(i){i.destroy(t.keepEvents)}),i.columns=void 0},t.onInit=function(t){var i=t.userOptions||{},e=i.grid||{};e.enabled&&defined(e.borderColor)&&(i.tickColor=i.lineColor=e.borderColor),this.grid||(this.grid=new GridAxisAdditions(this))},t.onTrimTicks=function(){var t=this.options,i=t.grid||{},e=this.categories,s=this.tickPositions,r=s[0],n=s[s.length-1],o=this.linkedParent&&this.linkedParent.min,a=this.linkedParent&&this.linkedParent.max,h=o||this.min,d=a||this.max,l=this.tickInterval,c=r<h&&r+l>h,f=n>d&&n-l<d;!0!==i.enabled||e||!this.horiz&&!this.isLinked||(c&&!t.startOnTick&&(s[0]=h),f&&!t.endOnTick&&(s[s.length-1]=d))},t.wrapUnsquish=function(t){var i=this.options.grid;return!0===(void 0===i?{}:i).enabled&&this.categories?this.tickInterval:t.apply(this,argsToArray(arguments))},t}();!function(t){!function(t){t[t.top=0]="top",t[t.right=1]="right",t[t.bottom=2]="bottom",t[t.left=3]="left"}(t.Side||(t.Side={}))}(GridAxis||(GridAxis={})),GridAxis.compose(Axis);export default GridAxis;