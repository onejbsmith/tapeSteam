"use strict";import A from"../Animation/AnimationUtilities.js";var getDeferredAnimation=A.getDeferredAnimation;import H from"../Globals.js";var noop=H.noop,seriesTypes=H.seriesTypes;import CartesianSeries from"./CartesianSeries.js";import U from"../Utilities.js";var arrayMax=U.arrayMax,clamp=U.clamp,defined=U.defined,extend=U.extend,fireEvent=U.fireEvent,format=U.format,isArray=U.isArray,merge=U.merge,objectEach=U.objectEach,pick=U.pick,relativeLength=U.relativeLength,splat=U.splat,stableSort=U.stableSort;H.distribute=function(t,e,a){var i,o,r,s=!0,n=t,l=[],d=0,h=n.reducedLen||e;function c(t,e){return t.target-e.target}for(i=t.length;i--;)d+=t[i].size;if(d>h){for(stableSort(t,function(t,e){return(e.rank||0)-(t.rank||0)}),i=0,d=0;d<=h;)d+=t[i].size,i++;l=t.splice(i-1,t.length)}for(stableSort(t,c),t=t.map(function(t){return{size:t.size,targets:[t.target],align:pick(t.align,.5)}});s;){for(i=t.length;i--;)o=t[i],r=(Math.min.apply(0,o.targets)+Math.max.apply(0,o.targets))/2,o.pos=clamp(r-o.size*o.align,0,e-o.size);for(i=t.length,s=!1;i--;)i>0&&t[i-1].pos+t[i-1].size>t[i].pos&&(t[i-1].size+=t[i].size,t[i-1].targets=t[i-1].targets.concat(t[i].targets),t[i-1].align=.5,t[i-1].pos+t[i-1].size>e&&(t[i-1].pos=e-t[i-1].size),t.splice(i,1),s=!0)}n.push.apply(n,l),i=0,t.some(function(t){var o=0;if(t.targets.some(function(){if(n[i].pos=t.pos+o,void 0!==a&&Math.abs(n[i].pos-n[i].target)>a)return n.slice(0,i+1).forEach(function(t){delete t.pos}),n.reducedLen=(n.reducedLen||e)-.1*e,n.reducedLen>.1*e&&H.distribute(n,e,a),!0;o+=n[i].size,i++}))return!0}),stableSort(n,c)},CartesianSeries.prototype.drawDataLabels=function(){var t,e=this,a=e.chart,i=e.options,o=i.dataLabels,r=e.points,s=e.hasRendered||0,n=o.animation,l=o.defer?getDeferredAnimation(a,n,e):{defer:0,duration:0},d=a.renderer;function h(t,e){var a,i=[];if(isArray(t)&&!isArray(e))i=t.map(function(t){return merge(t,e)});else if(isArray(e)&&!isArray(t))i=e.map(function(e){return merge(t,e)});else if(isArray(t)||isArray(e))for(a=Math.max(t.length,e.length);a--;)i[a]=merge(t[a],e[a]);else i=merge(t,e);return i}if(o=h(h(a.options.plotOptions&&a.options.plotOptions.series&&a.options.plotOptions.series.dataLabels,a.options.plotOptions&&a.options.plotOptions[e.type]&&a.options.plotOptions[e.type].dataLabels),o),fireEvent(this,"drawDataLabels"),isArray(o)||o.enabled||e._hasPointLabels){if((t=e.plotGroup("dataLabelsGroup","data-labels",s?"inherit":"hidden",o.zIndex||6)).attr({opacity:+s}),!s){var c=e.dataLabelsGroup;c&&(e.visible&&t.show(!0),c[i.animation?"animate":"attr"]({opacity:1},l))}r.forEach(function(r){splat(h(o,r.dlOptions||r.options&&r.options.dataLabels)).forEach(function(o,s){var n,l,h,c,p,b,g=o.enabled&&(!r.isNull||r.dataLabelOnNull)&&function(t,e){var a,i,o,r=e.filter;return!r||(a=r.operator,i=t[r.property],o=r.value,">"===a&&i>o||"<"===a&&i<o||">="===a&&i>=o||"<="===a&&i<=o||"=="===a&&i==o||"==="===a&&i===o)}(r,o),f=r.dataLabels?r.dataLabels[s]:r.dataLabel,u=r.connectors?r.connectors[s]:r.connector,y=pick(o.distance,r.labelDistance),L=!f;g&&(n=r.getLabelConfig(),l=pick(o[r.formatPrefix+"Format"],o.format),h=defined(l)?format(l,n,a):(o[r.formatPrefix+"Formatter"]||o.formatter).call(n,o),c=o.style,p=o.rotation,a.styledMode||(c.color=pick(o.color,c.color,e.color,"#000000"),"contrast"===c.color?(r.contrastColor=d.getContrast(r.color||e.color),c.color=!defined(y)&&o.inside||y<0||i.stacking?r.contrastColor:"#000000"):delete r.contrastColor,i.cursor&&(c.cursor=i.cursor)),b={r:o.borderRadius||0,rotation:p,padding:o.padding,zIndex:1},a.styledMode||(b.fill=o.backgroundColor,b.stroke=o.borderColor,b["stroke-width"]=o.borderWidth),objectEach(b,function(t,e){void 0===t&&delete b[e]})),!f||g&&defined(h)?g&&defined(h)&&(f?b.text=h:(r.dataLabels=r.dataLabels||[],f=r.dataLabels[s]=p?d.text(h,0,-9999,o.useHTML).addClass("highcharts-data-label"):d.label(h,0,-9999,o.shape,null,null,o.useHTML,null,"data-label"),s||(r.dataLabel=f),f.addClass(" highcharts-data-label-color-"+r.colorIndex+" "+(o.className||"")+(o.useHTML?" highcharts-tracker":""))),f.options=o,f.attr(b),a.styledMode||f.css(c).shadow(o.shadow),f.added||f.add(t),o.textPath&&!o.useHTML&&(f.setTextPath(r.getDataLabelPath&&r.getDataLabelPath(f)||r.graphic,o.textPath),r.dataLabelPath&&!o.textPath.enabled&&(r.dataLabelPath=r.dataLabelPath.destroy())),e.alignDataLabel(r,f,o,null,L)):(r.dataLabel=r.dataLabel&&r.dataLabel.destroy(),r.dataLabels&&(1===r.dataLabels.length?delete r.dataLabels:delete r.dataLabels[s]),s||delete r.dataLabel,u&&(r.connector=r.connector.destroy(),r.connectors&&(1===r.connectors.length?delete r.connectors:delete r.connectors[s])))})})}fireEvent(this,"afterDrawDataLabels")},CartesianSeries.prototype.alignDataLabel=function(t,e,a,i,o){var r,s,n,l,d,h=this,c=this.chart,p=this.isCartesian&&c.inverted,b=this.enabledDataSorting,g=pick(t.dlBox&&t.dlBox.centerX,t.plotX,-9999),f=pick(t.plotY,-9999),u=e.getBBox(),y=a.rotation,L=a.align,x=c.isInsidePlot(g,Math.round(f),p),m="justify"===pick(a.overflow,b?"none":"justify"),v=this.visible&&!1!==t.visible&&(t.series.forceDL||b&&!m||x||a.inside&&i&&c.isInsidePlot(g,p?i.x+1:i.y+i.height-1,p)),w=function(a){b&&h.xAxis&&!m&&h.setDataLabelStartPos(t,e,o,x,a)};v&&(r=c.renderer.fontMetrics(c.styledMode?void 0:a.style.fontSize,e).b,i=extend({x:p?this.yAxis.len-f:g,y:Math.round(p?this.xAxis.len-g:f),width:0,height:0},i),extend(a,{width:u.width,height:u.height}),y?(m=!1,l=c.renderer.rotCorr(r,y),w(d={x:i.x+(a.x||0)+i.width/2+l.x,y:i.y+(a.y||0)+{top:0,middle:.5,bottom:1}[a.verticalAlign]*i.height}),e[o?"attr":"animate"](d).attr({align:L}),n=(s=(y+720)%360)>180&&s<360,"left"===L?d.y-=n?u.height:0:"center"===L?(d.x-=u.width/2,d.y-=u.height/2):"right"===L&&(d.x-=u.width,d.y-=n?0:u.height),e.placed=!0,e.alignAttr=d):(w(i),e.align(a,null,i),d=e.alignAttr),m&&i.height>=0?this.justifyDataLabel(e,a,d,u,i,o):pick(a.crop,!0)&&(v=c.isInsidePlot(d.x,d.y)&&c.isInsidePlot(d.x+u.width,d.y+u.height)),a.shape&&!y&&e[o?"attr":"animate"]({anchorX:p?c.plotWidth-t.plotY:t.plotX,anchorY:p?c.plotHeight-t.plotX:t.plotY})),o&&b&&(e.placed=!1),v||b&&!m||(e.hide(!0),e.placed=!1)},CartesianSeries.prototype.setDataLabelStartPos=function(t,e,a,i,o){var r,s,n=this.chart,l=n.inverted,d=this.xAxis,h=d.reversed,c=l?e.height/2:e.width/2,p=t.pointWidth,b=p?p/2:0;r=l?o.x:h?-c-b:d.width-c+b,s=l?h?this.yAxis.height-c+b:-c-b:o.y,e.startXPos=r,e.startYPos=s,i?"hidden"===e.visibility&&(e.show(),e.attr({opacity:0}).animate({opacity:1})):e.attr({opacity:1}).animate({opacity:0},void 0,e.hide),n.hasRendered&&(a&&e.attr({x:e.startXPos,y:e.startYPos}),e.placed=!0)},CartesianSeries.prototype.justifyDataLabel=function(t,e,a,i,o,r){var s,n,l=this.chart,d=e.align,h=e.verticalAlign,c=t.box?0:t.padding||0,p=e.x,b=void 0===p?0:p,g=e.y,f=void 0===g?0:g;return(s=a.x+c)<0&&("right"===d&&b>=0?(e.align="left",e.inside=!0):b-=s,n=!0),(s=a.x+i.width-c)>l.plotWidth&&("left"===d&&b<=0?(e.align="right",e.inside=!0):b+=l.plotWidth-s,n=!0),(s=a.y+c)<0&&("bottom"===h&&f>=0?(e.verticalAlign="top",e.inside=!0):f-=s,n=!0),(s=a.y+i.height-c)>l.plotHeight&&("top"===h&&f<=0?(e.verticalAlign="bottom",e.inside=!0):f+=l.plotHeight-s,n=!0),n&&(e.x=b,e.y=f,t.placed=!r,t.align(e,void 0,o)),n},seriesTypes.pie&&(seriesTypes.pie.prototype.dataLabelPositioners={radialDistributionY:function(t){return t.top+t.distributeBox.pos},radialDistributionX:function(t,e,a,i){return t.getX(a<e.top+2||a>e.bottom-2?i:a,e.half,e)},justify:function(t,e,a){return a[0]+(t.half?-1:1)*(e+t.labelDistance)},alignToPlotEdges:function(t,e,a,i){var o=t.getBBox().width;return e?o+i:a-o-i},alignToConnectors:function(t,e,a,i){var o,r=0;return t.forEach(function(t){(o=t.dataLabel.getBBox().width)>r&&(r=o)}),e?r+i:a-r-i}},seriesTypes.pie.prototype.drawDataLabels=function(){var t,e,a,i,o,r,s,n,l,d,h,c,p=this,b=p.data,g=p.chart,f=p.options.dataLabels||{},u=f.connectorPadding,y=g.plotWidth,L=g.plotHeight,x=g.plotLeft,m=Math.round(g.chartWidth/3),v=p.center,w=v[2]/2,D=v[1],M=[[],[]],A=[0,0,0,0],k=p.dataLabelPositioners;p.visible&&(f.enabled||p._hasPointLabels)&&(b.forEach(function(t){t.dataLabel&&t.visible&&t.dataLabel.shortened&&(t.dataLabel.attr({width:"auto"}).css({width:"auto",textOverflow:"clip"}),t.dataLabel.shortened=!1)}),CartesianSeries.prototype.drawDataLabels.apply(p),b.forEach(function(t){t.dataLabel&&(t.visible?(M[t.half].push(t),t.dataLabel._pos=null,defined(f.style.width)||defined(t.options.dataLabels&&t.options.dataLabels.style&&t.options.dataLabels.style.width)||t.dataLabel.getBBox().width>m&&(t.dataLabel.css({width:Math.round(.7*m)+"px"}),t.dataLabel.shortened=!0)):(t.dataLabel=t.dataLabel.destroy(),t.dataLabels&&1===t.dataLabels.length&&delete t.dataLabels))}),M.forEach(function(e,a){var b,m,M,P,C,B,T=e.length,z=[];if(T)for(p.sortByAngle(e,a-.5),p.maxLabelDistance>0&&(b=Math.max(0,D-w-p.maxLabelDistance),m=Math.min(D+w+p.maxLabelDistance,g.plotHeight),e.forEach(function(t){t.labelDistance>0&&t.dataLabel&&(t.top=Math.max(0,D-w-t.labelDistance),t.bottom=Math.min(D+w+t.labelDistance,g.plotHeight),C=t.dataLabel.getBBox().height||21,t.distributeBox={target:t.labelPosition.natural.y-t.top+C/2,size:C,rank:t.y},z.push(t.distributeBox))}),B=m+C-b,H.distribute(z,B,B/5)),h=0;h<T;h++){if(t=e[h],r=t.labelPosition,i=t.dataLabel,d=!1===t.visible?"hidden":"inherit",M=r.natural.y,l=M,z&&defined(t.distributeBox)&&(void 0===t.distributeBox.pos?d="hidden":(s=t.distributeBox.size,l=k.radialDistributionY(t))),delete t.positionIndex,f.justify)n=k.justify(t,w,v);else switch(f.alignTo){case"connectors":n=k.alignToConnectors(e,a,y,x);break;case"plotEdges":n=k.alignToPlotEdges(i,a,y,x);break;default:n=k.radialDistributionX(p,t,l,M)}i._attr={visibility:d,align:r.alignment},c=t.options.dataLabels||{},i._pos={x:n+pick(c.x,f.x)+({left:u,right:-u}[r.alignment]||0),y:l+pick(c.y,f.y)-10},r.final.x=n,r.final.y=l,pick(f.crop,!0)&&(o=i.getBBox().width,P=null,n-o<u&&1===a?(P=Math.round(o-n+u),A[3]=Math.max(P,A[3])):n+o>y-u&&0===a&&(P=Math.round(n+o-y+u),A[1]=Math.max(P,A[1])),l-s/2<0?A[0]=Math.max(Math.round(s/2-l),A[0]):l+s/2>L&&(A[2]=Math.max(Math.round(l+s/2-L),A[2])),i.sideOverflow=P)}}),(0===arrayMax(A)||this.verifyDataLabelOverflow(A))&&(this.placeDataLabels(),this.points.forEach(function(t){var o;(c=merge(f,t.options.dataLabels),e=pick(c.connectorWidth,1))&&(a=t.connector,(i=t.dataLabel)&&i._pos&&t.visible&&t.labelDistance>0?(d=i._attr.visibility,(o=!a)&&(t.connector=a=g.renderer.path().addClass("highcharts-data-label-connector  highcharts-color-"+t.colorIndex+(t.className?" "+t.className:"")).add(p.dataLabelsGroup),g.styledMode||a.attr({"stroke-width":e,stroke:c.connectorColor||t.color||"#666666"})),a[o?"attr":"animate"]({d:t.getConnectorPath()}),a.attr("visibility",d)):a&&(t.connector=a.destroy()))})))},seriesTypes.pie.prototype.placeDataLabels=function(){this.points.forEach(function(t){var e,a=t.dataLabel;a&&t.visible&&((e=a._pos)?(a.sideOverflow&&(a._attr.width=Math.max(a.getBBox().width-a.sideOverflow,0),a.css({width:a._attr.width+"px",textOverflow:(this.options.dataLabels.style||{}).textOverflow||"ellipsis"}),a.shortened=!0),a.attr(a._attr),a[a.moved?"animate":"attr"](e),a.moved=!0):a&&a.attr({y:-9999})),delete t.distributeBox},this)},seriesTypes.pie.prototype.alignDataLabel=noop,seriesTypes.pie.prototype.verifyDataLabelOverflow=function(t){var e=this.center,a=this.options,i=a.center,o=a.minSize||80,r=o,s=null!==a.size;return s||(null!==i[0]?r=Math.max(e[2]-Math.max(t[1],t[3]),o):(r=Math.max(e[2]-t[1]-t[3],o),e[0]+=(t[3]-t[1])/2),null!==i[1]?r=clamp(r,o,e[2]-Math.max(t[0],t[2])):(r=clamp(r,o,e[2]-t[0]-t[2]),e[1]+=(t[0]-t[2])/2),r<e[2]?(e[2]=r,e[3]=Math.min(relativeLength(a.innerSize||0,r),r),this.translate(e),this.drawDataLabels&&this.drawDataLabels()):s=!0),s}),seriesTypes.column&&(seriesTypes.column.prototype.alignDataLabel=function(t,e,a,i,o){var r,s=this.chart.inverted,n=t.series,l=t.dlBox||t.shapeArgs,d=pick(t.below,t.plotY>pick(this.translatedThreshold,n.yAxis.len)),h=pick(a.inside,!!this.options.stacking);l&&((i=merge(l)).y<0&&(i.height+=i.y,i.y=0),(r=i.y+i.height-n.yAxis.len)>0&&r<i.height&&(i.height-=r),s&&(i={x:n.yAxis.len-i.y-i.height,y:n.xAxis.len-i.x-i.width,width:i.height,height:i.width}),h||(s?(i.x+=d?0:i.width,i.width=0):(i.y+=d?i.height:0,i.height=0))),a.align=pick(a.align,!s||h?"center":d?"right":"left"),a.verticalAlign=pick(a.verticalAlign,s||h?"middle":d?"top":"bottom"),CartesianSeries.prototype.alignDataLabel.call(this,t,e,a,i,o),a.inside&&t.contrastColor&&e.css({color:t.contrastColor})});