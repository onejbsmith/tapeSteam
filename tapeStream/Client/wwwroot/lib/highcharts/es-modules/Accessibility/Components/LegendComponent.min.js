"use strict";import H from"../../Core/Globals.js";import Legend from"../../Core/Legend.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,find=U.find,fireEvent=U.fireEvent;import AccessibilityComponent from"../AccessibilityComponent.js";import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import HTMLUtilities from"../Utils/HTMLUtilities.js";var stripHTMLTags=HTMLUtilities.stripHTMLTagsFromString,removeElement=HTMLUtilities.removeElement;function scrollLegendToItem(e,t){var i=e.allItems[t].pageIx,n=e.currentPage;void 0!==i&&i+1!==n&&e.scroll(1+i-n)}function shouldDoLegendA11y(e){var t=e.legend&&e.legend.allItems,i=e.options.legend.accessibility||{};return!(!t||!t.length||e.colorAxis&&e.colorAxis.length||!1===i.enabled)}H.Chart.prototype.highlightLegendItem=function(e){var t=this.legend.allItems,i=this.highlightedLegendItemIx;return!!t[e]&&(t[i]&&fireEvent(t[i].legendGroup.element,"mouseout"),scrollLegendToItem(this.legend,e),this.setFocusToElement(t[e].legendItem,t[e].a11yProxyElement),fireEvent(t[e].legendGroup.element,"mouseover"),!0)},addEvent(Legend,"afterColorizeItem",function(e){var t=this.chart.options.accessibility,i=e.item;t.enabled&&i&&i.a11yProxyElement&&i.a11yProxyElement.setAttribute("aria-pressed",e.visible?"false":"true")});var LegendComponent=function(){};LegendComponent.prototype=new AccessibilityComponent,extend(LegendComponent.prototype,{init:function(){var e=this;this.proxyElementsList=[],this.recreateProxies(),this.addEvent(Legend,"afterScroll",function(){this.chart===e.chart&&(e.updateProxiesPositions(),e.updateLegendItemProxyVisibility(),this.chart.highlightLegendItem(e.highlightedLegendItemIx))}),this.addEvent(Legend,"afterPositionItem",function(t){this.chart===e.chart&&this.chart.renderer&&e.updateProxyPositionForItem(t.item)})},updateLegendItemProxyVisibility:function(){var e=this.chart.legend,t=e.allItems||[],i=e.currentPage||1,n=e.clipHeight||0;t.forEach(function(t){var o=t.pageIx||0,r=(t._legendItemPos?t._legendItemPos[1]:0)+(t.legendItem?Math.round(t.legendItem.getBBox().height):0)-e.pages[o]>n||o!==i-1;t.a11yProxyElement&&(t.a11yProxyElement.style.visibility=r?"hidden":"visible")})},onChartRender:function(){shouldDoLegendA11y(this.chart)?this.updateProxiesPositions():this.removeProxies()},updateProxiesPositions:function(){for(var e=0,t=this.proxyElementsList;e<t.length;e++){var i=t[e],n=i.element,o=i.posElement;this.updateProxyButtonPosition(n,o)}},updateProxyPositionForItem:function(e){var t=find(this.proxyElementsList,function(t){return t.item===e});t&&this.updateProxyButtonPosition(t.element,t.posElement)},recreateProxies:function(){this.removeProxies(),shouldDoLegendA11y(this.chart)&&(this.addLegendProxyGroup(),this.proxyLegendItems(),this.updateLegendItemProxyVisibility())},removeProxies:function(){removeElement(this.legendProxyGroup),this.proxyElementsList=[]},addLegendProxyGroup:function(){var e=this.chart.options.accessibility,t=this.chart.langFormat("accessibility.legend.legendLabel",{}),i="all"===e.landmarkVerbosity?"region":null;this.legendProxyGroup=this.addProxyGroup({"aria-label":t,role:i})},proxyLegendItems:function(){var e=this;(this.chart.legend&&this.chart.legend.allItems||[]).forEach(function(t){t.legendItem&&t.legendItem.element&&e.proxyLegendItem(t)})},proxyLegendItem:function(e){if(e.legendItem&&e.legendGroup){var t=this.chart.langFormat("accessibility.legend.legendItem",{chart:this.chart,itemName:stripHTMLTags(e.name)}),i={tabindex:-1,"aria-pressed":!e.visible,"aria-label":t},n=e.legendGroup.div?e.legendItem:e.legendGroup;e.a11yProxyElement=this.createProxyButton(e.legendItem,this.legendProxyGroup,i,n),this.proxyElementsList.push({item:e,element:e.a11yProxyElement,posElement:n})}},getKeyboardNavigation:function(){var e=this.keyCodes,t=this,i=this.chart;return new KeyboardNavigationHandler(i,{keyCodeMap:[[[e.left,e.right,e.up,e.down],function(e){return t.onKbdArrowKey(this,e)}],[[e.enter,e.space],function(){return t.onKbdClick(this)}]],validate:function(){return t.shouldHaveLegendNavigation()},init:function(e){return t.onKbdNavigationInit(e)}})},onKbdArrowKey:function(e,t){var i=this.keyCodes,n=e.response,o=this.chart,r=o.options.accessibility,s=o.legend.allItems.length,a=t===i.left||t===i.up?-1:1;return o.highlightLegendItem(this.highlightedLegendItemIx+a)?(this.highlightedLegendItemIx+=a,n.success):s>1&&r.keyboardNavigation.wrapAround?(e.init(a),n.success):n[a>0?"next":"prev"]},onKbdClick:function(e){var t=this.chart.legend.allItems[this.highlightedLegendItemIx];return t&&t.a11yProxyElement&&fireEvent(t.a11yProxyElement,"click"),e.response.success},shouldHaveLegendNavigation:function(){var e=this.chart,t=e.options.legend||{},i=e.legend&&e.legend.allItems,n=e.colorAxis&&e.colorAxis.length,o=t.accessibility||{};return!!(i&&e.legend.display&&!n&&o.enabled&&o.keyboardNavigation&&o.keyboardNavigation.enabled)},onKbdNavigationInit:function(e){var t=this.chart,i=t.legend.allItems.length-1,n=e>0?0:i;t.highlightLegendItem(n),this.highlightedLegendItemIx=n}});export default LegendComponent;