"use strict";import H from"../Core/Globals.js";var doc=H.doc,win=H.win;import U from"../Core/Utilities.js";var addEvent=U.addEvent,fireEvent=U.fireEvent;import HTMLUtilities from"./Utils/HTMLUtilities.js";var getElement=HTMLUtilities.getElement;import EventProvider from"./Utils/EventProvider.js";function KeyboardNavigation(t,e){this.init(t,e)}addEvent(doc,"keydown",function(t){27===(t.which||t.keyCode)&&H.charts&&H.charts.forEach(function(t){t&&t.dismissPopupContent&&t.dismissPopupContent()})}),H.Chart.prototype.dismissPopupContent=function(){var t=this;fireEvent(this,"dismissPopupContent",{},function(){t.tooltip&&t.tooltip.hide(0),t.hideExportMenu()})},KeyboardNavigation.prototype={init:function(t,e){var i=this,n=this.eventProvider=new EventProvider;this.chart=t,this.components=e,this.modules=[],this.currentModuleIx=0,this.update(),n.addEvent(this.tabindexContainer,"keydown",function(t){return i.onKeydown(t)}),n.addEvent(this.tabindexContainer,"focus",function(t){return i.onFocus(t)}),["mouseup","touchend"].forEach(function(t){return n.addEvent(doc,t,function(){return i.onMouseUp()})}),["mousedown","touchstart"].forEach(function(e){return n.addEvent(t.renderTo,e,function(){i.isClickingChart=!0})}),n.addEvent(t.renderTo,"mouseover",function(){i.pointerIsOverChart=!0}),n.addEvent(t.renderTo,"mouseout",function(){i.pointerIsOverChart=!1}),this.modules.length&&this.modules[0].init(1)},update:function(t){var e=this.chart.options.accessibility,i=e&&e.keyboardNavigation,n=this.components;this.updateContainerTabindex(),i&&i.enabled&&t&&t.length?(this.modules=t.reduce(function(t,e){var i=n[e].getKeyboardNavigation();return t.concat(i)},[]),this.updateExitAnchor()):(this.modules=[],this.currentModuleIx=0,this.removeExitAnchor())},onFocus:function(t){var e,i=this.chart,n=t.relatedTarget&&i.container.contains(t.relatedTarget);this.isClickingChart||n||null===(e=this.modules[0])||void 0===e||e.init(1)},onMouseUp:function(){if(delete this.isClickingChart,!this.keyboardReset&&!this.pointerIsOverChart){var t=this.chart,e=this.modules&&this.modules[this.currentModuleIx||0];e&&e.terminate&&e.terminate(),t.focusElement&&t.focusElement.removeFocusBorder(),this.currentModuleIx=0,this.keyboardReset=!0}},onKeydown:function(t){var e,i=t||win.event,n=this.modules&&this.modules.length&&this.modules[this.currentModuleIx];if(this.keyboardReset=!1,n){var r=n.run(i);r===n.response.success?e=!0:r===n.response.prev?e=this.prev():r===n.response.next&&(e=this.next()),e&&(i.preventDefault(),i.stopPropagation())}},prev:function(){return this.move(-1)},next:function(){return this.move(1)},move:function(t){var e=this.modules&&this.modules[this.currentModuleIx];e&&e.terminate&&e.terminate(t),this.chart.focusElement&&this.chart.focusElement.removeFocusBorder(),this.currentModuleIx+=t;var i=this.modules&&this.modules[this.currentModuleIx];if(i){if(i.validate&&!i.validate())return this.move(t);if(i.init)return i.init(t),!0}return this.currentModuleIx=0,t>0?(this.exiting=!0,this.exitAnchor.focus()):this.tabindexContainer.focus(),!1},updateExitAnchor:function(){var t="highcharts-end-of-chart-marker-"+this.chart.index,e=getElement(t);this.removeExitAnchor(),e?(this.makeElementAnExitAnchor(e),this.exitAnchor=e):this.createExitAnchor()},updateContainerTabindex:function(){var t,e=this.chart.options.accessibility,i=e&&e.keyboardNavigation,n=!(i&&!1===i.enabled),r=this.chart,o=r.container;r.renderTo.hasAttribute("tabindex")?(o.removeAttribute("tabindex"),t=r.renderTo):t=o,this.tabindexContainer=t;var s=t.getAttribute("tabindex");n&&!s?t.setAttribute("tabindex","0"):n||r.container.removeAttribute("tabindex")},makeElementAnExitAnchor:function(t){var e=this.tabindexContainer.getAttribute("tabindex")||0;t.setAttribute("class","highcharts-exit-anchor"),t.setAttribute("tabindex",e),t.setAttribute("aria-hidden",!1),this.addExitAnchorEventsToEl(t)},createExitAnchor:function(){var t=this.chart,e=this.exitAnchor=doc.createElement("div");t.renderTo.appendChild(e),this.makeElementAnExitAnchor(e)},removeExitAnchor:function(){this.exitAnchor&&this.exitAnchor.parentNode&&(this.exitAnchor.parentNode.removeChild(this.exitAnchor),delete this.exitAnchor)},addExitAnchorEventsToEl:function(t){var e=this.chart,i=this;this.eventProvider.addEvent(t,"focus",function(t){var n,r=t||win.event;!(r.relatedTarget&&e.container.contains(r.relatedTarget)||i.exiting)?(i.tabindexContainer.focus(),r.preventDefault(),i.modules&&i.modules.length&&(i.currentModuleIx=i.modules.length-1,(n=i.modules[i.currentModuleIx])&&n.validate&&!n.validate()?i.prev():n&&n.init(-1))):i.exiting=!1})},destroy:function(){this.removeExitAnchor(),this.eventProvider.removeAddedEvents(),this.chart.container.removeAttribute("tabindex")}};export default KeyboardNavigation;