"use strict";import Connection from"./Connection.js";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import O from"../Core/Options.js";var defaultOptions=O.defaultOptions;import Point from"../Core/Series/Point.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,defined=U.defined,error=U.error,extend=U.extend,merge=U.merge,objectEach=U.objectEach,pick=U.pick,splat=U.splat;import pathfinderAlgorithms from"./PathfinderAlgorithms.js";import"../Extensions/ArrowSymbols.js";var deg2rad=H.deg2rad,max=Math.max,min=Math.min;function getPointBB(t){var n,i=t.shapeArgs;return i?{xMin:i.x,xMax:i.x+i.width,yMin:i.y,yMax:i.y+i.height}:(n=t.graphic&&t.graphic.getBBox())?{xMin:t.plotX-n.width/2,xMax:t.plotX+n.width/2,yMin:t.plotY-n.height/2,yMax:t.plotY+n.height/2}:null}function calculateObstacleMargin(t){for(var n,i,e=t.length,o=0,r=[],a=function(t,n,i){var e=pick(i,10),o=t.yMax+e>n.yMin-e&&t.yMin-e<n.yMax+e,r=t.xMax+e>n.xMin-e&&t.xMin-e<n.xMax+e,s=o?t.xMin>n.xMax?t.xMin-n.xMax:n.xMin-t.xMax:1/0,c=r?t.yMin>n.yMax?t.yMin-n.yMax:n.yMin-t.yMax:1/0;return r&&o?e?a(t,n,Math.floor(e/2)):1/0:min(s,c)};o<e;++o)for(n=o+1;n<e;++n)(i=a(t[o],t[n]))<80&&r.push(i);return r.push(80),max(Math.floor(r.sort(function(t,n){return t-n})[Math.floor(r.length/10)]/2-1),1)}extend(defaultOptions,{connectors:{type:"straight",lineWidth:1,marker:{enabled:!1,align:"center",verticalAlign:"middle",inside:!1,lineWidth:1},startMarker:{symbol:"diamond"},endMarker:{symbol:"arrow-filled"}}});var Pathfinder=function(){function t(t){this.chart=void 0,this.chartObstacles=void 0,this.chartObstacleMetrics=void 0,this.connections=void 0,this.group=void 0,this.lineObstacles=void 0,this.init(t)}return t.prototype.init=function(t){this.chart=t,this.connections=[],addEvent(t,"redraw",function(){this.pathfinder.update()})},t.prototype.update=function(t){var n=this.chart,i=this,e=i.connections;i.connections=[],n.series.forEach(function(t){t.visible&&!t.options.isInternal&&t.points.forEach(function(t){var e=t.options;e&&e.dependency&&(e.connect=e.dependency);var o,r=t.options&&t.options.connect&&splat(t.options.connect);t.visible&&!1!==t.isInside&&r&&r.forEach(function(e){(o=n.get("string"==typeof e?e:e.to))instanceof Point&&o.series.visible&&o.visible&&!1!==o.isInside&&i.connections.push(new Connection(t,o,"string"==typeof e?{}:e))})})});for(var o,r,a=0,s=e.length,c=i.connections.length;a<s;++a){for(r=!1,o=0;o<c;++o)if(e[a].fromPoint===i.connections[o].fromPoint&&e[a].toPoint===i.connections[o].toPoint){i.connections[o].graphics=e[a].graphics,r=!0;break}r||e[a].destroy()}delete this.chartObstacles,delete this.lineObstacles,i.renderConnections(t)},t.prototype.renderConnections=function(t){t?this.chart.series.forEach(function(t){var n=function(){var n=t.chart.pathfinder;(n&&n.connections||[]).forEach(function(n){n.fromPoint&&n.fromPoint.series===t&&n.render()}),t.pathfinderRemoveRenderEvent&&(t.pathfinderRemoveRenderEvent(),delete t.pathfinderRemoveRenderEvent)};!1===t.options.animation?n():t.pathfinderRemoveRenderEvent=addEvent(t,"afterAnimate",n)}):this.connections.forEach(function(t){t.render()})},t.prototype.getChartObstacles=function(t){for(var n,i=[],e=this.chart.series,o=pick(t.algorithmMargin,0),r=0,a=e.length;r<a;++r)if(e[r].visible&&!e[r].options.isInternal)for(var s,c,h=0,d=e[r].points.length;h<d;++h)(c=e[r].points[h]).visible&&(s=getPointBB(c))&&i.push({xMin:s.xMin-o,xMax:s.xMax+o,yMin:s.yMin-o,yMax:s.yMax+o});return i=i.sort(function(t,n){return t.xMin-n.xMin}),defined(t.algorithmMargin)||(n=t.algorithmMargin=calculateObstacleMargin(i),i.forEach(function(t){t.xMin-=n,t.xMax+=n,t.yMin-=n,t.yMax+=n})),i},t.prototype.getObstacleMetrics=function(t){for(var n,i,e=0,o=0,r=t.length;r--;)e<(n=t[r].xMax-t[r].xMin)&&(e=n),o<(i=t[r].yMax-t[r].yMin)&&(o=i);return{maxHeight:o,maxWidth:e}},t.prototype.getAlgorithmStartDirection=function(t){var n="left"!==t.align&&"right"!==t.align,i="top"!==t.verticalAlign&&"bottom"!==t.verticalAlign;return n?!!i&&void 0:!!i||void 0},t}();function warnLegacy(t){(t.options.pathfinder||t.series.reduce(function(t,n){return n.options&&merge(!0,n.options.connectors=n.options.connectors||{},n.options.pathfinder),t||n.options&&n.options.pathfinder},!1))&&(merge(!0,t.options.connectors=t.options.connectors||{},t.options.pathfinder),error('WARNING: Pathfinder options have been renamed. Use "chart.connectors" or "series.connectors" instead.'))}Pathfinder.prototype.algorithms=pathfinderAlgorithms,H.Pathfinder=Pathfinder,extend(Point.prototype,{getPathfinderAnchorPoint:function(t){var n,i,e=getPointBB(this);switch(t.align){case"right":n="xMax";break;case"left":n="xMin"}switch(t.verticalAlign){case"top":i="yMin";break;case"bottom":i="yMax"}return{x:n?e[n]:(e.xMin+e.xMax)/2,y:i?e[i]:(e.yMin+e.yMax)/2}},getRadiansToVector:function(t,n){var i;return defined(n)||(i=getPointBB(this))&&(n={x:(i.xMin+i.xMax)/2,y:(i.yMin+i.yMax)/2}),Math.atan2(n.y-t.y,t.x-n.x)},getMarkerVector:function(t,n,i){for(var e,o=2*Math.PI,r=t,a=getPointBB(this),s=a.xMax-a.xMin,c=a.yMax-a.yMin,h=Math.atan2(c,s),d=!1,p=s/2,f=c/2,M=a.xMin+p,x=a.yMin+f,l={x:M,y:x},y={},g=1,u=1;r<-Math.PI;)r+=o;for(;r>Math.PI;)r-=o;return e=Math.tan(r),r>-h&&r<=h?(u=-1,d=!0):r>h&&r<=Math.PI-h?u=-1:r>Math.PI-h||r<=-(Math.PI-h)?(g=-1,d=!0):g=-1,d?(l.x+=g*p,l.y+=u*p*e):(l.x+=g*(c/(2*e)),l.y+=u*f),i.x!==M&&(l.x=i.x),i.y!==x&&(l.y=i.y),y.x=l.x+n*Math.cos(r),y.y=l.y-n*Math.sin(r),y}}),Chart.prototype.callbacks.push(function(t){!1!==t.options.connectors.enabled&&(warnLegacy(t),this.pathfinder=new Pathfinder(this),this.pathfinder.update(!0))});export default Pathfinder;