"use strict";import Axis from"../Core/Axis/Axis.js";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import StackingAxis from"../Core/Axis/StackingAxis.js";import U from"../Core/Utilities.js";var correctFloat=U.correctFloat,defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,format=U.format,isNumber=U.isNumber,pick=U.pick;import"../Series/LineSeries.js";var Series=H.Series,StackItem=function(){function t(t,i,e,s,o){var a=t.chart.inverted;this.axis=t,this.isNegative=e,this.options=i=i||{},this.x=s,this.total=null,this.points={},this.hasValidPoints=!1,this.stack=o,this.leftCliff=0,this.rightCliff=0,this.alignOptions={align:i.align||(a?e?"left":"right":"center"),verticalAlign:i.verticalAlign||(a?"middle":e?"bottom":"top"),y:i.y,x:i.x},this.textAlign=i.textAlign||(a?e?"right":"left":"center")}return t.prototype.destroy=function(){destroyObjectProperties(this,this.axis)},t.prototype.render=function(t){var i=this.axis.chart,e=this.options,s=e.format,o={},a=s?format(s,this,i):e.formatter.call(this);this.label?this.label.attr({text:a,visibility:"hidden"}):(this.label=i.renderer.label(a,null,null,e.shape,null,null,e.useHTML,!1,"stack-labels"),o={r:e.borderRadius||0,text:a,rotation:e.rotation,padding:pick(e.padding,5),visibility:"hidden"},i.styledMode||(o.fill=e.backgroundColor,o.stroke=e.borderColor,o["stroke-width"]=e.borderWidth,this.label.css(e.style)),this.label.attr(o),this.label.added||this.label.add(t)),this.label.labelrank=i.plotHeight},t.prototype.setOffset=function(t,i,e,s,o){var a=this.axis,r=a.chart,n=a.translate(a.stacking.usePercentage?100:s||this.total,0,0,0,1),l=a.translate(e||0),c=defined(n)&&Math.abs(n-l),h=pick(o,r.xAxis[0].translate(this.x))+t,p=defined(n)&&this.getStackBox(r,this,h,n,i,c,a),d=this.label,g=this.isNegative,k="justify"===pick(this.options.overflow,"justify"),u=this.textAlign;if(d&&p){var x,f,y=d.getBBox(),m=d.padding;x="left"===u?r.inverted?-m:m:"right"===u?y.width:r.inverted&&"center"===u?y.width/2:r.inverted?g?y.width+m:-m:y.width/2,f=r.inverted?y.height/2:g?-m:y.height,this.alignOptions.x=pick(this.options.x,0),this.alignOptions.y=pick(this.options.y,0),p.x-=x,p.y-=f,d.align(this.alignOptions,null,p),r.isInsidePlot(d.alignAttr.x+x-this.alignOptions.x,d.alignAttr.y+f-this.alignOptions.y)?d.show():(d.alignAttr.y=-9999,k=!1),k&&Series.prototype.justifyDataLabel.call(this.axis,d,this.alignOptions,d.alignAttr,y,p),d.attr({x:d.alignAttr.x,y:d.alignAttr.y}),pick(!k&&this.options.crop,!0)&&(isNumber(d.x)&&isNumber(d.y)&&r.isInsidePlot(d.x-m+d.width,d.y)&&r.isInsidePlot(d.x+m,d.y)||d.hide())}},t.prototype.getStackBox=function(t,i,e,s,o,a,r){var n=i.axis.reversed,l=t.inverted,c=r.height+r.pos-(l?t.plotLeft:t.plotTop),h=i.isNegative&&!n||!i.isNegative&&n;return{x:l?h?s-r.right:s-a+r.pos-t.plotLeft:e+t.xAxis[0].transB-t.plotLeft,y:l?r.height-e-o:h?c-s-a:c-s,width:l?a:o,height:l?o:a}},t}();Chart.prototype.getStacks=function(){var t=this,i=t.inverted;t.yAxis.forEach(function(t){t.stacking&&t.stacking.stacks&&t.hasVisibleSeries&&(t.stacking.oldStacks=t.stacking.stacks)}),t.series.forEach(function(e){var s=e.xAxis&&e.xAxis.options||{};!e.options.stacking||!0!==e.visible&&!1!==t.options.chart.ignoreHiddenSeries||(e.stackKey=[e.type,pick(e.options.stack,""),i?s.top:s.left,i?s.height:s.width].join(","))})},StackingAxis.compose(Axis),Series.prototype.setGroupedPoints=function(){this.options.centerInCategory&&(this.is("column")||this.is("columnrange"))&&!this.options.stacking&&this.chart.series.length>1&&Series.prototype.setStackedPoints.call(this,"group")},Series.prototype.setStackedPoints=function(t){var i=t||this.options.stacking;if(i&&(!0===this.visible||!1===this.chart.options.chart.ignoreHiddenSeries)){var e,s,o,a,r,n,l,c,h,p=this.processedXData,d=this.processedYData,g=[],k=d.length,u=this.options,x=u.threshold,f=pick(u.startFromThreshold&&x,0),y=u.stack,m=t?this.type+","+i:this.stackKey,v="-"+m,S=this.negStacks,b=this.yAxis,A=b.stacking.stacks,j=b.stacking.oldStacks;for(b.stacking.stacksTouched+=1,l=0;l<k;l++)c=p[l],h=d[l],n=(e=this.getStackIndicator(e,c,this.index)).key,A[r=(s=S&&h<(f?0:x))?v:m]||(A[r]={}),A[r][c]||(j[r]&&j[r][c]?(A[r][c]=j[r][c],A[r][c].total=null):A[r][c]=new StackItem(b,b.options.stackLabels,s,c,y)),o=A[r][c],null!==h?(o.points[n]=o.points[this.index]=[pick(o.cumulative,f)],defined(o.cumulative)||(o.base=n),o.touched=b.stacking.stacksTouched,e.index>0&&!1===this.singleStacks&&(o.points[n][0]=o.points[this.index+","+c+",0"][0])):o.points[n]=o.points[this.index]=null,"percent"===i?(a=s?m:v,S&&A[a]&&A[a][c]?(a=A[a][c],o.total=a.total=Math.max(a.total,o.total)+Math.abs(h)||0):o.total=correctFloat(o.total+(Math.abs(h)||0))):"group"===i?null!==h&&(o.total=(o.total||0)+1):o.total=correctFloat(o.total+(h||0)),o.cumulative="group"===i?(o.total||1)-1:pick(o.cumulative,f)+(h||0),null!==h&&(o.points[n].push(o.cumulative),g[l]=o.cumulative,o.hasValidPoints=!0);"percent"===i&&(b.stacking.usePercentage=!0),"group"!==i&&(this.stackedYData=g),b.stacking.oldStacks={}}},Series.prototype.modifyStacks=function(){var t,i=this,e=i.yAxis,s=i.stackKey,o=e.stacking.stacks,a=i.processedXData,r=i.options.stacking;i[r+"Stacker"]&&[s,"-"+s].forEach(function(e){for(var s,n,l,c=a.length;c--;)s=a[c],t=i.getStackIndicator(t,s,i.index,e),(l=(n=o[e]&&o[e][s])&&n.points[t.key])&&i[r+"Stacker"](l,n,c)})},Series.prototype.percentStacker=function(t,i,e){var s=i.total?100/i.total:0;t[0]=correctFloat(t[0]*s),t[1]=correctFloat(t[1]*s),this.stackedYData[e]=t[1]},Series.prototype.getStackIndicator=function(t,i,e,s){return!defined(t)||t.x!==i||s&&t.key!==s?t={x:i,index:0,key:s}:t.index++,t.key=[e,i,t.index].join(","),t},H.StackItem=StackItem;export default H.StackItem;