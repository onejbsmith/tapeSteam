"use strict";import A from"../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import Axis from"../Core/Axis/Axis.js";import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";import H from"../Core/Globals.js";var noop=H.noop;import O from"../Core/Options.js";var defaultOptions=O.defaultOptions;import Point from"../Core/Series/Point.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import Tick from"../Core/Axis/Tick.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,removeEvent=U.removeEvent,extend=U.extend,fireEvent=U.fireEvent,format=U.format,merge=U.merge,objectEach=U.objectEach,pick=U.pick,syncTimeout=U.syncTimeout;import"../Series/LineSeries.js";import"../Series/ColumnSeries.js";var seriesTypes=H.seriesTypes,PieSeries=seriesTypes.pie,ColumnSeries=seriesTypes.column,ddSeriesId=1;extend(defaultOptions.lang,{drillUpText:"◁ Back to {series.name}"}),defaultOptions.drilldown={activeAxisLabelStyle:{cursor:"pointer",color:"#003399",fontWeight:"bold",textDecoration:"underline"},activeDataLabelStyle:{cursor:"pointer",color:"#003399",fontWeight:"bold",textDecoration:"underline"},animation:{duration:500},drillUpButton:{position:{align:"right",x:-10,y:10}}},SVGRenderer.prototype.Element.prototype.fadeIn=function(e){this.attr({opacity:.1,visibility:"inherit"}).animate({opacity:pick(this.newOpacity,1)},e||{duration:250})},Chart.prototype.addSeriesAsDrilldown=function(e,t){this.addSingleSeriesAsDrilldown(e,t),this.applyDrilldown()},Chart.prototype.addSingleSeriesAsDrilldown=function(e,t){var i,o,r,s,n,l,a=e.series,d=a.xAxis,p=a.yAxis,h=[],c=[];l=this.styledMode?{colorIndex:pick(e.colorIndex,a.colorIndex)}:{color:e.color||a.color},this.drilldownLevels||(this.drilldownLevels=[]),s=a.options._levelNumber||0,(n=this.drilldownLevels[this.drilldownLevels.length-1])&&n.levelNumber!==s&&(n=void 0),t=extend(extend({_ddSeriesId:ddSeriesId++},l),t),o=a.points.indexOf(e),a.chart.series.forEach(function(e){e.xAxis!==d||e.isDrilling||(e.options._ddSeriesId=e.options._ddSeriesId||ddSeriesId++,e.options._colorIndex=e.userOptions._colorIndex,e.options._levelNumber=e.options._levelNumber||s,n?(h=n.levelSeries,c=n.levelSeriesOptions):(h.push(e),e.purgedOptions=merge({_ddSeriesId:e.options._ddSeriesId,_levelNumber:e.options._levelNumber,selected:e.options.selected},e.userOptions),c.push(e.purgedOptions)))}),r=extend({levelNumber:s,seriesOptions:a.options,seriesPurgedOptions:a.purgedOptions,levelSeriesOptions:c,levelSeries:h,shapeArgs:e.shapeArgs,bBox:e.graphic?e.graphic.getBBox():{},color:e.isNull?new Color(l.color).setOpacity(0).get():l.color,lowerSeriesOptions:t,pointOptions:a.options.data[o],pointIndex:o,oldExtremes:{xMin:d&&d.userMin,xMax:d&&d.userMax,yMin:p&&p.userMin,yMax:p&&p.userMax},resetZoomButton:this.resetZoomButton},l),this.drilldownLevels.push(r),d&&d.names&&(d.names.length=0),(i=r.lowerSeries=this.addSeries(t,!1)).options._levelNumber=s+1,d&&(d.oldPos=d.pos,d.userMin=d.userMax=null,p.userMin=p.userMax=null),a.type===i.type&&(i.animate=i.animateDrilldown||noop,i.options.animation=!0)},Chart.prototype.applyDrilldown=function(){var e,t=this.drilldownLevels;t&&t.length>0&&(e=t[t.length-1].levelNumber,this.drilldownLevels.forEach(function(t){t.levelNumber===e&&t.levelSeries.forEach(function(t){t.options&&t.options._levelNumber===e&&t.remove(!1)})})),this.resetZoomButton&&(this.resetZoomButton.hide(),delete this.resetZoomButton),this.pointer.reset(),this.redraw(),this.showDrillUpButton(),fireEvent(this,"afterDrilldown")},Chart.prototype.getDrilldownBackText=function(){var e,t=this.drilldownLevels;if(t&&t.length>0)return(e=t[t.length-1]).series=e.seriesOptions,format(this.options.lang.drillUpText,e)},Chart.prototype.showDrillUpButton=function(){var e,t,i=this,o=this.getDrilldownBackText(),r=i.options.drilldown.drillUpButton;this.drillUpButton?this.drillUpButton.attr({text:o}).align():(t=(e=r.theme)&&e.states,this.drillUpButton=this.renderer.button(o,null,null,function(){i.drillUp()},e,t&&t.hover,t&&t.select).addClass("highcharts-drillup-button").attr({align:r.position.align,zIndex:7}).add().align(r.position,!1,r.relativeTo||"plotBox"))},Chart.prototype.drillUp=function(){if(this.drilldownLevels&&0!==this.drilldownLevels.length){for(var e,t,i,o,r,s=this,n=s.drilldownLevels,l=n[n.length-1].levelNumber,a=n.length,d=s.series,p=function(e){var r;d.forEach(function(t){t.options._ddSeriesId===e._ddSeriesId&&(r=t)}),(r=r||s.addSeries(e,!1)).type===i.type&&r.animateDrillupTo&&(r.animate=r.animateDrillupTo),e===t.seriesPurgedOptions&&(o=r)};a--;)if((t=n[a]).levelNumber===l){if(n.pop(),!(i=t.lowerSeries).chart)for(e=d.length;e--;)if(d[e].options.id===t.lowerSeriesOptions.id&&d[e].options._levelNumber===l+1){i=d[e];break}i.xData=[],t.levelSeriesOptions.forEach(p),fireEvent(s,"drillup",{seriesOptions:t.seriesPurgedOptions||t.seriesOptions}),o.type===i.type&&(o.drilldownLevel=t,o.options.animation=s.options.drilldown.animation,i.animateDrillupFrom&&i.chart&&i.animateDrillupFrom(t)),o.options._levelNumber=l,i.remove(!1),o.xAxis&&(r=t.oldExtremes,o.xAxis.setExtremes(r.xMin,r.xMax,!1),o.yAxis.setExtremes(r.yMin,r.yMax,!1)),t.resetZoomButton&&(s.resetZoomButton=t.resetZoomButton,s.resetZoomButton.show())}this.redraw(),0===this.drilldownLevels.length?this.drillUpButton=this.drillUpButton.destroy():this.drillUpButton.attr({text:this.getDrilldownBackText()}).align(),this.ddDupes.length=[],fireEvent(s,"drillupall")}},addEvent(Chart,"afterInit",function(){var e=this;e.drilldown={update:function(t,i){merge(!0,e.options.drilldown,t),pick(i,!0)&&e.redraw()}}}),addEvent(Chart,"beforeShowResetZoom",function(){if(this.drillUpButton)return!1}),addEvent(Chart,"render",function(){(this.xAxis||[]).forEach(function(e){e.ddPoints={},e.series.forEach(function(t){var i,o,r=t.xData||[],s=t.points;for(i=0;i<r.length;i++)"number"!=typeof(o=t.options.data[i])&&(o=t.pointClass.prototype.optionsToObject.call({series:t},o)).drilldown&&(e.ddPoints[r[i]]||(e.ddPoints[r[i]]=[]),e.ddPoints[r[i]].push(!s||s[i]))}),objectEach(e.ticks,Tick.prototype.drillable)})}),ColumnSeries.prototype.animateDrillupTo=function(e){if(!e){var t=this,i=t.drilldownLevel;this.points.forEach(function(e){var t=e.dataLabel;e.graphic&&e.graphic.hide(),t&&(t.hidden="hidden"===t.attr("visibility"),t.hidden||(t.hide(),e.connector&&e.connector.hide()))}),syncTimeout(function(){if(t.points){var e=[];t.data.forEach(function(t){e.push(t)}),t.nodes&&(e=e.concat(t.nodes)),e.forEach(function(e,t){var o=t===(i&&i.pointIndex)?"show":"fadeIn",r="show"===o||void 0,s=e.dataLabel;e.graphic&&e.graphic[o](r),s&&!s.hidden&&(s.fadeIn(),e.connector&&e.connector.fadeIn())})}},Math.max(this.chart.options.drilldown.animation.duration-50,0)),delete this.animate}},ColumnSeries.prototype.animateDrilldown=function(e){var t,i=this,o=this.chart,r=o.drilldownLevels,s=animObject(o.options.drilldown.animation),n=this.xAxis,l=o.styledMode;e||(r.forEach(function(e){i.options._ddSeriesId===e.lowerSeriesOptions._ddSeriesId&&(t=e.shapeArgs,l||(t.fill=e.color))}),t.x+=pick(n.oldPos,n.pos)-n.pos,this.points.forEach(function(e){var o=e.shapeArgs;l||(o.fill=e.color),e.graphic&&e.graphic.attr(t).animate(extend(e.shapeArgs,{fill:e.color||i.color}),s),e.dataLabel&&e.dataLabel.fadeIn(s)}),delete this.animate)},ColumnSeries.prototype.animateDrillupFrom=function(e){var t=animObject(this.chart.options.drilldown.animation),i=this.group,o=i!==this.chart.columnGroup,r=this;r.trackerGroups.forEach(function(e){r[e]&&r[e].on("mouseover")}),o&&delete this.group,this.points.forEach(function(s){var n=s.graphic,l=e.shapeArgs,a=function(){n.destroy(),i&&o&&(i=i.destroy())};n&&l&&(delete s.graphic,r.chart.styledMode||(l.fill=e.color),t.duration?n.animate(l,merge(t,{complete:a})):(n.attr(l),a()))})},PieSeries&&extend(PieSeries.prototype,{animateDrillupTo:ColumnSeries.prototype.animateDrillupTo,animateDrillupFrom:ColumnSeries.prototype.animateDrillupFrom,animateDrilldown:function(e){var t=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],i=this.chart.options.drilldown.animation;if(this.is("item")&&(i.duration=0),this.center){var o=t.shapeArgs,r=o.start,s=(o.end-r)/this.points.length,n=this.chart.styledMode;e||(this.points.forEach(function(e,l){var a=e.shapeArgs;n||(o.fill=t.color,a.fill=e.color),e.graphic&&e.graphic.attr(merge(o,{start:r+l*s,end:r+(l+1)*s}))[i?"animate":"attr"](a,i)}),delete this.animate)}}}),Point.prototype.doDrilldown=function(e,t,i){var o,r=this.series.chart,s=r.options.drilldown,n=(s.series||[]).length;for(r.ddDupes||(r.ddDupes=[]);n--&&!o;)s.series[n].id===this.drilldown&&-1===r.ddDupes.indexOf(this.drilldown)&&(o=s.series[n],r.ddDupes.push(this.drilldown));fireEvent(r,"drilldown",{point:this,seriesOptions:o,category:t,originalEvent:i,points:void 0!==t&&this.series.xAxis.getDDPoints(t).slice(0)},function(t){var i=t.point.series&&t.point.series.chart,o=t.seriesOptions;i&&o&&(e?i.addSingleSeriesAsDrilldown(t.point,o):i.addSeriesAsDrilldown(t.point,o))})},Axis.prototype.drilldownCategory=function(e,t){this.getDDPoints(e).forEach(function(i){i&&i.series&&i.series.visible&&i.doDrilldown&&i.doDrilldown(!0,e,t)}),this.chart.applyDrilldown()},Axis.prototype.getDDPoints=function(e){return this.ddPoints&&this.ddPoints[e]||[]},Tick.prototype.drillable=function(){var e=this.pos,t=this.label,i=this.axis,o="xAxis"===i.coll&&i.getDDPoints,r=o&&i.getDDPoints(e),s=i.chart.styledMode;o&&(t&&r&&r.length?(t.drillable=!0,t.basicStyles||s||(t.basicStyles=merge(t.styles)),t.addClass("highcharts-drilldown-axis-label"),t.removeOnDrillableClick&&removeEvent(t.element,"click"),t.removeOnDrillableClick=addEvent(t.element,"click",function(t){t.preventDefault(),i.drilldownCategory(e,t)}),s||t.css(i.chart.options.drilldown.activeAxisLabelStyle)):t&&t.drillable&&t.removeOnDrillableClick&&(s||(t.styles={},t.css(t.basicStyles)),t.removeOnDrillableClick(),t.removeClass("highcharts-drilldown-axis-label")))},addEvent(Point,"afterInit",function(){var e=this,t=e.series;return e.drilldown&&addEvent(e,"click",function(i){t.xAxis&&!1===t.chart.options.drilldown.allowPointDrilldown?t.xAxis.drilldownCategory(e.x,i):e.doDrilldown(void 0,void 0,i)}),e}),addEvent(H.Series,"afterDrawDataLabels",function(){var e=this.chart.options.drilldown.activeDataLabelStyle,t=this.chart.renderer,i=this.chart.styledMode;this.points.forEach(function(o){var r=o.options.dataLabels,s=pick(o.dlOptions,r&&r.style,{});o.drilldown&&o.dataLabel&&("contrast"!==e.color||i||(s.color=t.getContrast(o.color||this.color)),r&&r.color&&(s.color=r.color),o.dataLabel.addClass("highcharts-drilldown-data-label"),i||o.dataLabel.css(e).css(s))},this)});var applyCursorCSS=function(e,t,i,o){e[i?"addClass":"removeClass"]("highcharts-drilldown-point"),o||e.css({cursor:t})};addEvent(H.Series,"afterDrawTracker",function(){var e=this.chart.styledMode;this.points.forEach(function(t){t.drilldown&&t.graphic&&applyCursorCSS(t.graphic,"pointer",!0,e)})}),addEvent(Point,"afterSetState",function(){var e=this.series.chart.styledMode;this.drilldown&&this.series.halo&&"hover"===this.state?applyCursorCSS(this.series.halo,"pointer",!0,e):this.series.halo&&applyCursorCSS(this.series.halo,"auto",!1,e)});