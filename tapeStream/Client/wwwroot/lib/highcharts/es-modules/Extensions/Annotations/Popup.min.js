import H from"../../Core/Globals.js";import NavigationBindings from"./NavigationBindings.js";import Pointer from"../../Core/Pointer.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,createElement=U.createElement,defined=U.defined,getOptions=U.getOptions,isArray=U.isArray,isObject=U.isObject,isString=U.isString,objectEach=U.objectEach,pick=U.pick,wrap=U.wrap,indexFilter=/\d/g,PREFIX="highcharts-",DIV="div",INPUT="input",LABEL="label",BUTTON="button",SELECT="select",OPTION="option",SPAN="span",UL="ul",LI="li",H3="h3";wrap(Pointer.prototype,"onContainerMouseDown",function(t,e){var n=e.target&&e.target.className;isString(n)&&n.indexOf(PREFIX+"popup-field")>=0||t.apply(this,Array.prototype.slice.call(arguments,1))}),H.Popup=function(t,e){this.init(t,e)},H.Popup.prototype={init:function(t,e){this.container=createElement(DIV,{className:PREFIX+"popup"},null,t),this.lang=this.getLangpack(),this.iconsURL=e,this.addCloseBtn()},addCloseBtn:function(){var t,e=this;(t=createElement(DIV,{className:PREFIX+"popup-close"},null,this.container)).style["background-image"]="url("+this.iconsURL+"close.svg)",["click","touchstart"].forEach(function(n){addEvent(t,n,function(){e.closePopup()})})},addColsContainer:function(t){var e,n;return n=createElement(DIV,{className:PREFIX+"popup-lhs-col"},null,t),e=createElement(DIV,{className:PREFIX+"popup-rhs-col"},null,t),createElement(DIV,{className:PREFIX+"popup-rhs-col-wrapper"},null,e),{lhsCol:n,rhsCol:e}},addInput:function(t,e,n,a){var i=t.split("."),o=i[i.length-1],s=this.lang,l=PREFIX+e+"-"+o;l.match(indexFilter)||createElement(LABEL,{innerHTML:s[o]||o,htmlFor:l},null,n),createElement(INPUT,{name:l,value:a[0],type:a[1],className:PREFIX+"popup-field"},null,n).setAttribute(PREFIX+"data-name",t)},addButton:function(t,e,n,a,i){var o,s=this,l=this.closePopup,r=this.getFields;return o=createElement(BUTTON,{innerHTML:e},null,t),["click","touchstart"].forEach(function(t){addEvent(o,t,function(){return l.call(s),a(r(i,n))})}),o},getFields:function(t,e){var n,a,i=t.querySelectorAll("input"),o="#"+PREFIX+"select-series > option:checked",s="#"+PREFIX+"select-volume > option:checked",l=t.querySelectorAll(o)[0],r=t.querySelectorAll(s)[0];return a={actionType:e,linkedTo:l&&l.getAttribute("value"),fields:{}},[].forEach.call(i,function(t){n=t.getAttribute(PREFIX+"data-name"),t.getAttribute(PREFIX+"data-series-id")?a.seriesId=t.value:n?a.fields[n]=t.value:a.type=t.value}),r&&(a.fields["params.volumeSeriesID"]=r.getAttribute("value")),a},showPopup:function(){var t=this.container,e=PREFIX+"annotation-toolbar",n=t.querySelectorAll("."+PREFIX+"popup-close")[0];t.innerHTML="",t.className.indexOf(e)>=0&&(t.classList.remove(e),t.removeAttribute("style")),t.appendChild(n),t.style.display="block"},closePopup:function(){this.popup.container.style.display="none"},showForm:function(t,e,n,a){this.popup=e.navigationBindings.popup,this.showPopup(),"indicators"===t&&this.indicators.addForm.call(this,e,n,a),"annotation-toolbar"===t&&this.annotations.addToolbar.call(this,e,n,a),"annotation-edit"===t&&this.annotations.addForm.call(this,e,n,a),"flag"===t&&this.annotations.addForm.call(this,e,n,a,!0)},getLangpack:function(){return getOptions().lang.navigation.popup},annotations:{addToolbar:function(t,e,n){var a,i=this,o=this.lang,s=this.popup.container,l=this.showForm,r=PREFIX+"annotation-toolbar";-1===s.className.indexOf(r)&&(s.className+=" "+r),s.style.top=t.plotTop+10+"px",createElement(SPAN,{innerHTML:pick(o[e.langKey]||e.langKey,e.shapes&&e.shapes[0].type)},null,s),(a=this.addButton(s,o.removeButton||"remove","remove",n,s)).className+=" "+PREFIX+"annotation-remove-button",a.style["background-image"]="url("+this.iconsURL+"destroy.svg)",(a=this.addButton(s,o.editButton||"edit","edit",function(){l.call(i,"annotation-edit",t,e,n)},s)).className+=" "+PREFIX+"annotation-edit-button",a.style["background-image"]="url("+this.iconsURL+"edit.svg)"},addForm:function(t,e,n,a){var i,o,s=this.popup.container,l=this.lang;createElement("h2",{innerHTML:l[e.langKey]||e.langKey,className:PREFIX+"popup-main-title"},null,s),o=createElement(DIV,{className:PREFIX+"popup-lhs-col "+PREFIX+"popup-lhs-full"},null,s),i=createElement(DIV,{className:PREFIX+"popup-bottom-row"},null,s),this.annotations.addFormFields.call(this,o,t,"",e,[],!0),this.addButton(i,a?l.addButton||"add":l.saveButton||"save",a?"add":"save",n,s)},addFormFields:function(t,e,n,a,i,o){var s,l,r=this,c=this.annotations.addFormFields,p=this.addInput,d=this.lang;objectEach(a,function(a,o){s=""!==n?n+"."+o:o,isObject(a)&&(!isArray(a)||isArray(a)&&isObject(a[0])?((l=d[o]||o).match(indexFilter)||i.push([!0,l,t]),c.call(r,t,e,s,a,i,!1)):i.push([r,s,"annotation",t,a]))}),o&&(i=i.sort(function(t){return t[1].match(/format/g)?-1:1})).forEach(function(t){!0===t[0]?createElement(SPAN,{className:PREFIX+"annotation-title",innerHTML:t[1]},null,t[2]):p.apply(t[0],t.splice(1))})}},indicators:{addForm:function(t,e,n){var a,i,o=this.indicators,s=this.lang;this.tabs.init.call(this,t),a=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content"),this.addColsContainer(a[0]),o.addIndicatorList.call(this,t,a[0],"add"),i=a[0].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(i,s.addButton||"add","add",n,i),this.addColsContainer(a[1]),o.addIndicatorList.call(this,t,a[1],"edit"),i=a[1].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(i,s.saveButton||"save","edit",n,i),this.addButton(i,s.removeButton||"remove","remove",n,i)},addIndicatorList:function(t,e,n){var a,i,o,s=this,l=e.querySelectorAll("."+PREFIX+"popup-lhs-col")[0],r=e.querySelectorAll("."+PREFIX+"popup-rhs-col")[0],c="edit"===n,p=c?t.series:t.options.plotOptions,d=this.indicators.addFormFields;i=createElement(UL,{className:PREFIX+"indicator-list"},null,l),a=r.querySelectorAll("."+PREFIX+"popup-rhs-col-wrapper")[0],objectEach(p,function(e,n){var l=e.options;if(e.params||l&&l.params){var r=s.indicators.getNameType(e,n),u=r.type;o=createElement(LI,{className:PREFIX+"indicator-list",innerHTML:r.name},null,i),["click","touchstart"].forEach(function(n){addEvent(o,n,function(){d.call(s,t,c?e:p[u],r.type,a),c&&e.options&&createElement(INPUT,{type:"hidden",name:PREFIX+"id-"+u,value:e.options.id},null,a).setAttribute(PREFIX+"data-series-id",e.options.id)})})}}),i.childNodes.length>0&&i.childNodes[0].click()},getNameType:function(t,e){var n=t.options,a=H.seriesTypes,i=a[e]&&a[e].prototype.nameBase||e.toUpperCase(),o=e;return n&&n.type&&(o=t.options.type,i=t.name),{name:i,type:o}},listAllSeries:function(t,e,n,a,i){var o,s,l=PREFIX+e+"-type-"+t,r=this.lang;createElement(LABEL,{innerHTML:r[e]||e,htmlFor:l},null,a),(o=createElement(SELECT,{name:l,className:PREFIX+"popup-field"},null,a)).setAttribute("id",PREFIX+"select-"+e),n.series.forEach(function(t){!(s=t.options).params&&s.id&&s.id!==PREFIX+"navigator-series"&&createElement(OPTION,{innerHTML:s.name||s.id,value:s.id},null,o)}),defined(i)&&(o.value=i)},addFormFields:function(t,e,n,a){var i=e.params||e.options.params,o=this.indicators.getNameType;a.innerHTML="",createElement(H3,{className:PREFIX+"indicator-title",innerHTML:o(e,n).name},null,a),createElement(INPUT,{type:"hidden",name:PREFIX+"type-"+n,value:n},null,a),this.indicators.listAllSeries.call(this,n,"series",t,a,e.linkedParent&&i.volumeSeriesID),i.volumeSeriesID&&this.indicators.listAllSeries.call(this,n,"volume",t,a,e.linkedParent&&e.linkedParent.options.id),this.indicators.addParamInputs.call(this,t,"params",i,n,a)},addParamInputs:function(t,e,n,a,i){var o,s=this,l=this.indicators.addParamInputs,r=this.addInput;objectEach(n,function(n,c){o=e+"."+c,isObject(n)?l.call(s,t,o,n,a,i):"params.volumeSeriesID"!==o&&r.call(s,o,a,i,[n,"text"])})},getAmount:function(){var t=this.series,e=0;return t.forEach(function(t){var n=t.options;(t.params||n&&n.params)&&e++}),e}},tabs:{init:function(t){var e,n=this.tabs,a=this.indicators.getAmount.call(t);e=n.addMenuItem.call(this,"add"),n.addMenuItem.call(this,"edit",a),n.addContentItem.call(this,"add"),n.addContentItem.call(this,"edit"),n.switchTabs.call(this,a),n.selectTab.call(this,e,0)},addMenuItem:function(t,e){var n,a=this.popup.container,i=PREFIX+"tab-item",o=this.lang;return 0===e&&(i+=" "+PREFIX+"tab-disabled"),(n=createElement(SPAN,{innerHTML:o[t+"Button"]||t,className:i},null,a)).setAttribute(PREFIX+"data-tab-type",t),n},addContentItem:function(){var t=this.popup.container;return createElement(DIV,{className:PREFIX+"tab-item-content"},null,t)},switchTabs:function(t){var e=this;this.popup.container.querySelectorAll("."+PREFIX+"tab-item").forEach(function(n,a){"edit"===n.getAttribute(PREFIX+"data-tab-type")&&0===t||["click","touchstart"].forEach(function(t){addEvent(n,t,function(){e.tabs.deselectAll.call(e),e.tabs.selectTab.call(e,this,a)})})})},selectTab:function(t,e){var n=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content");t.className+=" "+PREFIX+"tab-item-active",n[e].className+=" "+PREFIX+"tab-item-show"},deselectAll:function(){var t,e=this.popup.container,n=e.querySelectorAll("."+PREFIX+"tab-item"),a=e.querySelectorAll("."+PREFIX+"tab-item-content");for(t=0;t<n.length;t++)n[t].classList.remove(PREFIX+"tab-item-active"),a[t].classList.remove(PREFIX+"tab-item-show")}}},addEvent(NavigationBindings,"showPopup",function(t){this.popup||(this.popup=new H.Popup(this.chart.container,this.chart.options.navigation.iconsURL||this.chart.options.stockTools&&this.chart.options.stockTools.gui.iconsURL||"https://code.highcharts.com/8.2.2/gfx/stock-icons/")),this.popup.showForm(t.formType,this.chart,t.options,t.onSubmit)}),addEvent(NavigationBindings,"closePopup",function(){this.popup&&this.popup.closePopup()});