"use strict";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";var win=H.win;import"../Core/Options.js";import U from"../Core/Utilities.js";var error=U.error,extend=U.extend,format=U.format,merge=U.merge,wrap=U.wrap;function pointInPolygon(t,r){var o,n,a=!1,i=t.x,e=t.y;for(o=0,n=r.length-1;o<r.length;n=o++)r[o][1]>e!==r[n][1]>e&&i<(r[n][0]-r[o][0])*(e-r[o][1])/(r[n][1]-r[o][1])+r[o][0]&&(a=!a);return a}Chart.prototype.transformFromLatLon=function(t,r){var o,n=(null===(o=this.userOptions.chart)||void 0===o?void 0:o.proj4)||win.proj4;if(!n)return error(21,!1,this),{x:0,y:null};var a=n(r.crs,[t.lon,t.lat]),i=r.cosAngle||r.rotation&&Math.cos(r.rotation),e=r.sinAngle||r.rotation&&Math.sin(r.rotation),s=r.rotation?[a[0]*i+a[1]*e,-a[0]*e+a[1]*i]:a;return{x:((s[0]-(r.xoffset||0))*(r.scale||1)+(r.xpan||0))*(r.jsonres||1)+(r.jsonmarginX||0),y:(((r.yoffset||0)-s[1])*(r.scale||1)+(r.ypan||0))*(r.jsonres||1)-(r.jsonmarginY||0)}},Chart.prototype.transformToLatLon=function(t,r){if(void 0!==win.proj4){var o={x:((t.x-(r.jsonmarginX||0))/(r.jsonres||1)-(r.xpan||0))/(r.scale||1)+(r.xoffset||0),y:((-t.y-(r.jsonmarginY||0))/(r.jsonres||1)+(r.ypan||0))/(r.scale||1)+(r.yoffset||0)},n=r.cosAngle||r.rotation&&Math.cos(r.rotation),a=r.sinAngle||r.rotation&&Math.sin(r.rotation),i=win.proj4(r.crs,"WGS84",r.rotation?{x:o.x*n+o.y*-a,y:o.x*a+o.y*n}:o);return{lat:i.y,lon:i.x}}error(21,!1,this)},Chart.prototype.fromPointToLatLon=function(t){var r,o=this.mapTransforms;if(o){for(r in o)if(Object.hasOwnProperty.call(o,r)&&o[r].hitZone&&pointInPolygon({x:t.x,y:-t.y},o[r].hitZone.coordinates[0]))return this.transformToLatLon(t,o[r]);return this.transformToLatLon(t,o.default)}error(22,!1,this)},Chart.prototype.fromLatLonToPoint=function(t){var r,o,n=this.mapTransforms;if(!n)return error(22,!1,this),{x:0,y:null};for(r in n)if(Object.hasOwnProperty.call(n,r)&&n[r].hitZone&&pointInPolygon({x:(o=this.transformFromLatLon(t,n[r])).x,y:-o.y},n[r].hitZone.coordinates[0]))return o;return this.transformFromLatLon(t,n.default)},H.geojson=function(t,r,o){var n=[],a=[],i=function(t){t.forEach(function(t,r){0===r?a.push(["M",t[0],-t[1]]):a.push(["L",t[0],-t[1]])})};return r=r||"map",t.features.forEach(function(t){var o,e=t.geometry,s=e.type,p=e.coordinates,h=t.properties;a=[],"map"===r||"mapbubble"===r?("Polygon"===s?(p.forEach(i),a.push(["Z"])):"MultiPolygon"===s&&(p.forEach(function(t){t.forEach(i)}),a.push(["Z"])),a.length&&(o={path:a})):"mapline"===r?("LineString"===s?i(p):"MultiLineString"===s&&p.forEach(i),a.length&&(o={path:a})):"mappoint"===r&&"Point"===s&&(o={x:p[0],y:-p[1]}),o&&n.push(extend(o,{name:h.name||h.NAME,properties:h}))}),o&&t.copyrightShort&&(o.chart.mapCredits=format(o.chart.options.credits.mapText,{geojson:t}),o.chart.mapCreditsFull=format(o.chart.options.credits.mapTextFull,{geojson:t})),n},wrap(Chart.prototype,"addCredits",function(t,r){r=merge(!0,this.options.credits,r),this.mapCredits&&(r.href=null),t.call(this,r),this.credits&&this.mapCreditsFull&&this.credits.attr({title:this.mapCreditsFull})});