"use strict";import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";var color=Color.parse;import H from"../Core/Globals.js";var doc=H.doc,noop=H.noop;import LineSeries from"../Series/LineSeries.js";import Series from"../Core/Series/Series.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,pick=U.pick,wrap=U.wrap;import"../Core/Options.js";var destroyLoadingDiv,seriesTypes=Series.seriesTypes,CHUNK_SIZE=5e4,initCanvasBoost=function(){H.seriesTypes.heatmap&&wrap(H.seriesTypes.heatmap.prototype,"drawPoints",function(){var e=this.chart,t=this.getContext(),o=this.chart.inverted,i=this.xAxis,r=this.yAxis;t?(this.points.forEach(function(s){var a,n,c=s.plotY;void 0===c||isNaN(c)||null===s.y||(a=s.shapeArgs,n=e.styledMode?s.series.colorAttribs(s):s.series.pointAttribs(s),t.fillStyle=n.fill,o?t.fillRect(r.len-a.y+i.left,i.len-a.x+r.top,-a.height,-a.width):t.fillRect(a.x+i.left,a.y+r.top,a.width,a.height))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}),extend(LineSeries.prototype,{getContext:function(){var e,t=this.chart,o=t.chartWidth,i=t.chartHeight,r=t.seriesGroup||this.group,s=this,a=function(e,t,o,i,r,s,a){e.call(this,o,t,i,r,s,a)};return t.isChartSeriesBoosting()&&(s=t,r=t.seriesGroup),e=s.ctx,s.canvas?H.Chart:(s.canvas=doc.createElement("canvas"),s.renderTarget=t.renderer.image("",0,0,o,i).addClass("highcharts-boost-canvas").add(r),s.ctx=e=s.canvas.getContext("2d"),t.inverted&&["moveTo","lineTo","rect","arc"].forEach(function(t){wrap(e,t,a)}),s.boostCopy=function(){s.renderTarget.attr({href:s.canvas.toDataURL("image/png")})},s.boostClear=function(){e.clearRect(0,0,s.canvas.width,s.canvas.height),s===this&&s.renderTarget.attr({href:""})},s.boostClipRect=t.renderer.clipRect(),s.renderTarget.clip(s.boostClipRect)),s.canvas.width!==o&&(s.canvas.width=o),s.canvas.height!==i&&(s.canvas.height=i),s.renderTarget.attr({x:0,y:0,width:o,height:i,style:"pointer-events: none",href:""}),s.boostClipRect.attr(t.getBoostClipRect(s)),e},canvasToSVG:function(){this.chart.isChartSeriesBoosting()?this.boostClear&&this.boostClear():(this.boostCopy||this.chart.boostCopy)&&(this.boostCopy||this.chart.boostCopy)()},cvsLineTo:function(e,t,o){e.lineTo(t,o)},renderCanvas:function(){var e,t,o,i,r,s,a,n,c,l,p=this,h=p.options,d=p.chart,v=this.xAxis,g=this.yAxis,u=d.options.boost||{},f=u.timeRendering||!1,y=(u.timeSeriesProcessing,u.timeSetup,0),m=p.processedXData,C=p.processedYData,b=h.data,T=v.getExtremes(),x=T.min,S=T.max,w=g.getExtremes(),k=w.min,D=w.max,E={},M=!!p.sampling,L=h.marker&&h.marker.radius,N=this.cvsDrawPoint,P=h.lineWidth?this.cvsLineTo:void 0,A=L&&L<=1?this.cvsMarkerSquare:this.cvsMarkerCircle,R=this.cvsStrokeBatch||1e3,G=!1!==h.enableMouseTracking,B=h.threshold,X=g.getThreshold(B),j=isNumber(B),Y=X,O=this.fill,I=p.pointArrayMap&&"low,high"===p.pointArrayMap.join(","),K=!!h.stacking,V=p.cropStart||0,W=d.options.loading,q=p.requireSorting,_=h.connectNulls,Z=!m,z=K?p.data:m||b,J=p.fillOpacity?new Color(p.color).setOpacity(pick(h.fillOpacity,.75)).get():p.color,F=function(){O?(e.fillStyle=J,e.fill()):(e.strokeStyle=p.color,e.lineWidth=h.lineWidth,e.stroke())},Q=function(t,o,s,a){0===y&&(e.beginPath(),P&&(e.lineJoin="round")),d.scroller&&"highcharts-navigator-series"===p.options.className?(o+=d.scroller.top,s&&(s+=d.scroller.top)):o+=d.plotTop,t+=d.plotLeft,r?e.moveTo(t,o):N?N(e,t,o,s,i):P?P(e,t,o):A&&A.call(p,e,t,o,L,a),(y+=1)===R&&(F(),y=0),i={clientX:t,plotY:o,yBottom:s}},$="x"===h.findNearestPointBy,ee=this.xData||this.options.xData||this.processedXData||!1,te=function(e,t,i){l=$?e:e+","+t,G&&!E[l]&&(E[l]=!0,d.inverted&&(e=v.len-e,t=g.len-t),o.push({x:!!ee&&ee[V+i],clientX:e,plotX:e,plotY:t,i:V+i}))};this.renderTarget&&this.renderTarget.attr({href:""}),(this.points||this.graph)&&this.destroyGraphics(),p.plotGroup("group","series",p.visible?"visible":"hidden",h.zIndex,d.seriesGroup),p.markerGroup=p.group,addEvent(p,"destroy",function(){p.markerGroup=null}),o=this.points=[],e=this.getContext(),p.buildKDTree=noop,this.boostClear&&this.boostClear(),this.visible&&(b.length>99999&&(d.options.loading=merge(W,{labelStyle:{backgroundColor:color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),U.clearTimeout(destroyLoadingDiv),d.showLoading("Drawing..."),d.options.loading=W),f&&console.time("canvas rendering"),H.eachAsync(z,function(e,o){var i,l,h,u,f,y,m=!1,b=!1,T=!1,w=!1,E=void 0===d.index,L=!0;return E||(Z?(i=e[0],l=e[1],z[o+1]&&(T=z[o+1][0]),z[o-1]&&(w=z[o-1][0])):(i=e,l=C[o],z[o+1]&&(T=z[o+1]),z[o-1]&&(w=z[o-1])),T&&T>=x&&T<=S&&(m=!0),w&&w>=x&&w<=S&&(b=!0),I?(Z&&(l=e.slice(1,3)),y=l[0],l=l[1]):K&&(i=e.x,y=(l=e.stackY)-e.y),q||(L=l>=k&&l<=D),!(f=null===l)&&(i>=x&&i<=S&&L||m||b)&&(h=Math.round(v.toPixels(i,!0)),M?(void 0!==n&&h!==t||(I||(y=l),(void 0===c||l>a)&&(a=l,c=o),(void 0===n||y<s)&&(s=y,n=o)),h!==t&&(void 0!==n&&(u=g.toPixels(a,!0),X=g.toPixels(s,!0),Q(h,j?Math.min(u,Y):u,j?Math.max(X,Y):X,o),te(h,u,c),X!==u&&te(h,X,n)),n=c=void 0,t=h)):(u=Math.round(g.toPixels(l,!0)),Q(h,u,X,o),te(h,u,o))),r=f&&!_,o%CHUNK_SIZE==0&&(p.boostCopy||p.chart.boostCopy)&&(p.boostCopy||p.chart.boostCopy)()),!E},function(){var e=d.loadingDiv,t=d.loadingShown;F(),p.canvasToSVG(),f&&console.timeEnd("canvas rendering"),fireEvent(p,"renderedCanvas"),t&&(extend(e.style,{transition:"opacity 250ms",opacity:0}),d.loadingShown=!1,destroyLoadingDiv=setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e),d.loadingDiv=d.loadingSpan=null},250)),delete p.buildKDTree,p.buildKDTree()},d.renderer.forExport?Number.MAX_VALUE:void 0))}}),seriesTypes.scatter.prototype.cvsMarkerCircle=function(e,t,o,i){e.moveTo(t,o),e.arc(t,o,i,0,2*Math.PI,!1)},seriesTypes.scatter.prototype.cvsMarkerSquare=function(e,t,o,i){e.rect(t-i,o-i,2*i,2*i)},seriesTypes.scatter.prototype.fill=!0,seriesTypes.bubble&&(seriesTypes.bubble.prototype.cvsMarkerCircle=function(e,t,o,i,r){e.moveTo(t,o),e.arc(t,o,this.radii&&this.radii[r],0,2*Math.PI,!1)},seriesTypes.bubble.prototype.cvsStrokeBatch=1),extend(seriesTypes.area.prototype,{cvsDrawPoint:function(e,t,o,i,r){r&&t!==r.clientX&&(e.moveTo(r.clientX,r.yBottom),e.lineTo(r.clientX,r.plotY),e.lineTo(t,o),e.lineTo(t,i))},fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{cvsDrawPoint:function(e,t,o,i){e.rect(t-1,o,1,i-o)},fill:!0,sampling:!0}),Chart.prototype.callbacks.push(function(e){addEvent(e,"predraw",function(){e.renderTarget&&e.renderTarget.attr({href:""}),e.canvas&&e.canvas.getContext("2d").clearRect(0,0,e.canvas.width,e.canvas.height)}),addEvent(e,"render",function(){e.boostCopy&&e.boostCopy()})})};export default initCanvasBoost;