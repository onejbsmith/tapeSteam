"use strict";import A from"../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import Point from"../Core/Series/Point.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,erase=U.erase,getOptions=U.getOptions,merge=U.merge,pick=U.pick,removeEvent=U.removeEvent,wrap=U.wrap;import"../Series/LineSeries.js";var patterns=function(){var t=[],e=getOptions().colors;return["M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11","M 0 10 L 10 0 M -1 1 L 1 -1 M 9 11 L 11 9","M 3 0 L 3 10 M 8 0 L 8 10","M 0 3 L 10 3 M 0 8 L 10 8","M 0 3 L 5 3 L 5 0 M 5 10 L 5 7 L 10 7","M 3 3 L 8 3 L 8 8 L 3 8 Z","M 5 5 m -4 0 a 4 4 0 1 1 8 0 a 4 4 0 1 1 -8 0","M 10 3 L 5 3 L 5 0 M 5 10 L 5 7 L 0 7","M 2 5 L 5 2 L 8 5 L 5 8 Z","M 0 0 L 5 10 L 10 0"].forEach(function(r,i){t.push({path:r,color:e[i],width:10,height:10})}),t}();function hashFromObject(t,e){var r,i=JSON.stringify(t),a=i.length||0,o=0,n=0;if(e){r=Math.max(Math.floor(a/500),1);for(var h=0;h<a;h+=r)o+=i.charCodeAt(h);o&=o}for(;n<a;++n)o=(o<<5)-o+i.charCodeAt(n),o&=o;return o.toString(16).replace("-","1")}Point.prototype.calculatePatternDimensions=function(t){if(!t.width||!t.height){var e=this.graphic&&(this.graphic.getBBox&&this.graphic.getBBox(!0)||this.graphic.element&&this.graphic.element.getBBox())||{},r=this.shapeArgs;if(r&&(e.width=r.width||e.width,e.height=r.height||e.height,e.x=r.x||e.x,e.y=r.y||e.y),t.image){if(!e.width||!e.height)return t._width="defer",void(t._height="defer");t.aspectRatio&&(e.aspectRatio=e.width/e.height,t.aspectRatio>e.aspectRatio?e.aspectWidth=e.height*t.aspectRatio:e.aspectHeight=e.width/t.aspectRatio),t._width=t.width||Math.ceil(e.aspectWidth||e.width),t._height=t.height||Math.ceil(e.aspectHeight||e.height)}t.width||(t._x=t.x||0,t._x+=e.x-Math.round(e.aspectWidth?Math.abs(e.aspectWidth-e.width)/2:0)),t.height||(t._y=t.y||0,t._y+=e.y-Math.round(e.aspectHeight?Math.abs(e.aspectHeight-e.height)/2:0))}},SVGRenderer.prototype.addPattern=function(t,e){var r,i,a,o=pick(e,!0),n=animObject(o),h=t.width||t._width||32,s=t.height||t._height||32,p=t.color||"#343434",d=t.id,c=this;if(d||(this.idCounter=this.idCounter||0,d="highcharts-pattern-"+this.idCounter+"-"+(this.chartIndex||0),++this.idCounter),this.forExport&&(d+="-export"),this.defIds=this.defIds||[],!(this.defIds.indexOf(d)>-1)){this.defIds.push(d);var l,f={id:d,patternUnits:"userSpaceOnUse",patternContentUnits:t.patternContentUnits||"userSpaceOnUse",width:h,height:s,x:t._x||t.x||0,y:t._y||t.y||0};return t.patternTransform&&(f.patternTransform=t.patternTransform),(r=this.createElement("pattern").attr(f).add(this.defs)).id=d,t.path?(i=t.path,t.backgroundColor&&(l=t.backgroundColor,c.rect(0,0,h,s).attr({fill:l}).add(r)),a={d:i.d||i},this.styledMode||(a.stroke=i.stroke||p,a["stroke-width"]=pick(i.strokeWidth,2),a.fill=i.fill||"none"),i.transform&&(a.transform=i.transform),this.createElement("path").attr(a).add(r),r.color=p):t.image&&(o?this.image(t.image,0,0,h,s,function(){this.animate({opacity:pick(t.opacity,1)},n),removeEvent(this.element,"load")}).attr({opacity:0}).add(r):this.image(t.image,0,0,h,s).add(r)),t.image&&o||void 0===t.opacity||[].forEach.call(r.element.childNodes,function(e){e.setAttribute("opacity",t.opacity)}),this.patternElements=this.patternElements||{},this.patternElements[d]=r,r}},wrap(H.Series.prototype,"getColor",function(t){var e=this.options.color;e&&e.pattern&&!e.pattern.color?(delete this.options.color,t.apply(this,Array.prototype.slice.call(arguments,1)),e.pattern.color=this.color,this.color=this.options.color=e):t.apply(this,Array.prototype.slice.call(arguments,1))}),addEvent(H.Series,"render",function(){var t=this.chart.isResizing;(this.isDirtyData||t||!this.chart.hasRendered)&&(this.points||[]).forEach(function(e){var r=e.options&&e.options.color;r&&r.pattern&&(!t||e.shapeArgs&&e.shapeArgs.width&&e.shapeArgs.height?e.calculatePatternDimensions(r.pattern):(r.pattern._width="defer",r.pattern._height="defer"))})}),addEvent(Point,"afterInit",function(){var t=this.options.color;t&&t.pattern&&("string"==typeof t.pattern.path&&(t.pattern.path={d:t.pattern.path}),this.color=this.options.color=merge(this.series.options.color,t))}),addEvent(SVGRenderer,"complexColor",function(t){var e=t.args[0],r=t.args[1],i=t.args[2],a=this.chartIndex||0,o=e.pattern,n="#343434";if(void 0!==e.patternIndex&&patterns&&(o=patterns[e.patternIndex]),!o)return!0;if(o.image||"string"==typeof o.path||o.path&&o.path.d){var h=i.parentNode&&i.parentNode.getAttribute("class");h=h&&h.indexOf("highcharts-legend")>-1,"defer"!==o._width&&"defer"!==o._height||Point.prototype.calculatePatternDimensions.call({graphic:{element:i}},o),!h&&o.id||((o=merge({},o)).id="highcharts-pattern-"+a+"-"+hashFromObject(o)+hashFromObject(o,!0)),this.addPattern(o,!this.forExport&&pick(o.animation,this.globalAnimation,{duration:100})),n="url("+this.url+"#"+o.id+(this.forExport?"-export":"")+")"}else n=o.color||n;return i.setAttribute(r,n),e.toString=function(){return n},!1}),addEvent(Chart,"endResize",function(){(this.renderer&&this.renderer.defIds||[]).filter(function(t){return t&&t.indexOf&&0===t.indexOf("highcharts-pattern-")}).length&&(this.series.forEach(function(t){t.points.forEach(function(t){var e=t.options&&t.options.color;e&&e.pattern&&(e.pattern._width="defer",e.pattern._height="defer")})}),this.redraw(!1))}),addEvent(Chart,"redraw",function(){var t={},e=this.renderer,r=(e.defIds||[]).filter(function(t){return t.indexOf&&0===t.indexOf("highcharts-pattern-")});r.length&&([].forEach.call(this.renderTo.querySelectorAll('[color^="url("], [fill^="url("], [stroke^="url("]'),function(r){var i=r.getAttribute("fill")||r.getAttribute("color")||r.getAttribute("stroke");if(i){var a=i.replace(e.url,"").replace("url(#","").replace(")","");t[a]=!0}}),r.forEach(function(r){t[r]||(erase(e.defIds,r),e.patternElements[r]&&(e.patternElements[r].destroy(),delete e.patternElements[r]))}))});