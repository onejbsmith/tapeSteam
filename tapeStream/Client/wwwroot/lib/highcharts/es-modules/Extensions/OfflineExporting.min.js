import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";var win=H.win,doc=H.doc;import"../Core/Options.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,error=U.error,extend=U.extend,getOptions=U.getOptions,merge=U.merge;import DownloadURL from"../Extensions/DownloadURL.js";var downloadURL=DownloadURL.downloadURL,domurl=win.URL||win.webkitURL||win,nav=win.navigator,isMSBrowser=/Edge\/|Trident\/|MSIE /.test(nav.userAgent),loadEventDeferDelay=isMSBrowser?150:0;function getScript(e,t){var o=doc.getElementsByTagName("head")[0],n=doc.createElement("script");n.type="text/javascript",n.src=e,n.onload=t,n.onerror=function(){error("Error loading script "+e)},o.appendChild(n)}function svgToDataUrl(e){var t=nav.userAgent.indexOf("WebKit")>-1&&nav.userAgent.indexOf("Chrome")<0;try{if(!t&&nav.userAgent.toLowerCase().indexOf("firefox")<0)return domurl.createObjectURL(new win.Blob([e],{type:"image/svg+xml;charset-utf-16"}))}catch(e){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(e)}function imageToDataUrl(e,t,o,n,r,i,a,l,c){var d,s=new win.Image,g=function(){setTimeout(function(){var i,l=doc.createElement("canvas"),g=l.getContext&&l.getContext("2d");try{if(g){l.height=s.height*n,l.width=s.width*n,g.drawImage(s,0,0,l.width,l.height);try{i=l.toDataURL(t),r(i,t,o,n)}catch(r){d(e,t,o,n)}}else a(e,t,o,n)}finally{c&&c(e,t,o,n)}},loadEventDeferDelay)},f=function(){l(e,t,o,n),c&&c(e,t,o,n)};d=function(){s=new win.Image,d=i,s.crossOrigin="Anonymous",s.onload=g,s.onerror=f,s.src=e},s.onload=g,s.onerror=f,s.src=e}function downloadSVGLocal(e,t,o,n){var r,i,a,l=!0,c=t.libURL||getOptions().exporting.libURL,d=doc.createElement("div"),s=t.type||"image/png",g=(t.filename||"chart")+"."+("image/svg+xml"===s?"svg":s.split("/")[1]),f=t.scale||1;function p(){d.innerHTML=e;var t,r,i,a,l,c,s,f=d.getElementsByTagName("text");[].forEach.call(f,function(e){["font-family","font-size"].forEach(function(t){!function(e,t){for(var o=e;o&&o!==d;){if(o.style[t]){e.style[t]=o.style[t];break}o=o.parentNode}}(e,t)}),e.style["font-family"]=e.style["font-family"]&&e.style["font-family"].split(" ").splice(-1),t=e.getElementsByTagName("title"),[].forEach.call(t,function(t){e.removeChild(t)})}),i=d.firstChild,a=0,l=i.width.baseVal.value+2*a,c=i.height.baseVal.value+2*a,s=new win.jsPDF(c>l?"p":"l","pt",[l,c]),[].forEach.call(i.querySelectorAll('*[visibility="hidden"]'),function(e){e.parentNode.removeChild(e)}),win.svg2pdf(i,s,{removeInvalid:!0}),r=s.output("datauristring");try{downloadURL(r,g),n&&n()}catch(e){o(e)}}if(c="/"!==c.slice(-1)?c+"/":c,"image/svg+xml"===s)try{void 0!==nav.msSaveOrOpenBlob?((i=new MSBlobBuilder).append(e),r=i.getBlob("image/svg+xml")):r=svgToDataUrl(e),downloadURL(r,g),n&&n()}catch(e){o(e)}else"application/pdf"===s?win.jsPDF&&win.svg2pdf?p():(l=!0,getScript(c+"jspdf.js",function(){getScript(c+"svg2pdf.js",function(){p()})})):(r=svgToDataUrl(e),a=function(){try{domurl.revokeObjectURL(r)}catch(e){}},imageToDataUrl(r,s,{},f,function(e){try{downloadURL(e,g),n&&n()}catch(e){o(e)}},function(){var t=doc.createElement("canvas"),r=t.getContext("2d"),i=e.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*f,d=e.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*f,p=function(){r.drawSvg(e,0,0,i,d);try{downloadURL(nav.msSaveOrOpenBlob?t.msToBlob():t.toDataURL(s),g),n&&n()}catch(e){o(e)}finally{a()}};t.width=i,t.height=d,win.canvg?p():(l=!0,getScript(c+"rgbcolor.js",function(){getScript(c+"canvg.js",function(){p()})}))},o,o,function(){l&&a()}))}H.CanVGRenderer={},Chart.prototype.getSVGForLocalExport=function(e,t,o,n){var r,i,a,l,c,d,s,g=this,f=0,p=function(e){return g.sanitizeSVG(e,a)},m=function(){f===r.length&&n(p(i.innerHTML))},h=function(e,t,o){++f,o.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",e),m()};g.unbindGetSVG=addEvent(g,"getSVG",function(e){a=e.chartCopy.options,i=e.chartCopy.container.cloneNode(!0)}),g.getSVGForExport(e,t),r=i.getElementsByTagName("image");try{if(!r.length)return void n(p(i.innerHTML));for(c=0,d=r.length;c<d;++c)(s=(l=r[c]).getAttributeNS("http://www.w3.org/1999/xlink","href"))?imageToDataUrl(s,"image/png",{imageElement:l},e.scale,h,o,o,o):(++f,l.parentNode.removeChild(l),m())}catch(e){o(e)}g.unbindGetSVG()},Chart.prototype.exportChartLocal=function(e,t){var o=this,n=merge(o.options.exporting,e),r=function(e){!1===n.fallbackToExportServer?n.error?n.error(n,e):error(28,!0):o.exportChart(n)};isMSBrowser&&o.styledMode&&(SVGRenderer.prototype.inlineWhitelist=[/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/]),isMSBrowser&&("application/pdf"===n.type||o.container.getElementsByTagName("image").length&&"image/svg+xml"!==n.type)||"application/pdf"===n.type&&[].some.call(o.container.getElementsByTagName("image"),function(e){var t=e.getAttribute("href");return""!==t&&0!==t.indexOf("data:")})?r("Image type not supported for this chart/browser."):o.getSVGForLocalExport(n,t,r,function(e){e.indexOf("<foreignObject")>-1&&"image/svg+xml"!==n.type?r("Image type not supportedfor charts with embedded HTML"):downloadSVGLocal(e,extend({filename:o.getFilename()},n),r)})},merge(!0,getOptions().exporting,{libURL:"https://code.highcharts.com/8.2.2/lib/",menuItemDefinitions:{downloadPNG:{textKey:"downloadPNG",onclick:function(){this.exportChartLocal()}},downloadJPEG:{textKey:"downloadJPEG",onclick:function(){this.exportChartLocal({type:"image/jpeg"})}},downloadSVG:{textKey:"downloadSVG",onclick:function(){this.exportChartLocal({type:"image/svg+xml"})}},downloadPDF:{textKey:"downloadPDF",onclick:function(){this.exportChartLocal({type:"application/pdf"})}}}}),H.downloadSVGLocal=downloadSVGLocal;