"use strict";import Axis from"../Core/Axis/Axis.js";import DateTimeAxis from"../Core/Axis/DateTimeAxis.js";import H from"../Core/Globals.js";import O from"../Core/Options.js";var defaultOptions=O.defaultOptions;import Point from"../Core/Series/Point.js";import Tooltip from"../Core/Tooltip.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,defined=U.defined,error=U.error,extend=U.extend,format=U.format,isNumber=U.isNumber,merge=U.merge,pick=U.pick;import"../Core/Axis/Axis.js";import"../Series/LineSeries.js";var Series=H.Series,approximations=H.approximations={sum:function(t){var o,i=t.length;if(!i&&t.hasNulls)o=null;else if(i)for(o=0;i--;)o+=t[i];return o},average:function(t){var o=t.length,i=approximations.sum(t);return isNumber(i)&&o&&(i=correctFloat(i/o)),i},averages:function(){var t=[];return[].forEach.call(arguments,function(o){t.push(approximations.average(o))}),void 0===t[0]?void 0:t},open:function(t){return t.length?t[0]:t.hasNulls?null:void 0},high:function(t){return t.length?arrayMax(t):t.hasNulls?null:void 0},low:function(t){return t.length?arrayMin(t):t.hasNulls?null:void 0},close:function(t){return t.length?t[t.length-1]:t.hasNulls?null:void 0},ohlc:function(t,o,i,e){if(t=approximations.open(t),o=approximations.high(o),i=approximations.low(i),e=approximations.close(e),isNumber(t)||isNumber(o)||isNumber(i)||isNumber(e))return[t,o,i,e]},range:function(t,o){return t=approximations.low(t),o=approximations.high(o),isNumber(t)||isNumber(o)?[t,o]:null===t&&null===o?null:void 0}},groupData=function(t,o,i,e){var a,r,s,n,p,u,l,h,d=this,m=d.data,g=d.options&&d.options.data,c=[],f=[],x=[],D=t.length,G=!!o,y=[],v=d.pointArrayMap,b=v&&v.length,A=["x"].concat(v||["y"]),M=0,P=0;for(n="function"==typeof(h=e)?h:approximations[h]?approximations[h]:approximations[d.getDGApproximation&&d.getDGApproximation()||"average"],b?v.forEach(function(){y.push([])}):y.push([]),p=b||1,u=0;u<=D&&!(t[u]>=i[0]);u++);for(;u<=D;u++){for(;void 0!==i[M+1]&&t[u]>=i[M+1]||u===D;){for(a=i[M],d.dataGroupInfo={start:d.cropStart+P,length:y[0].length},s=n.apply(d,y),d.pointClass&&!defined(d.dataGroupInfo.options)&&(d.dataGroupInfo.options=merge(d.pointClass.prototype.optionsToObject.call({series:d},d.options.data[d.cropStart+P])),A.forEach(function(t){delete d.dataGroupInfo.options[t]})),void 0!==s&&(c.push(a),f.push(s),x.push(d.dataGroupInfo)),P=u,l=0;l<p;l++)y[l].length=0,y[l].hasNulls=!1;if(M+=1,u===D)break}if(u===D)break;if(v){var S,O=d.cropStart+u,N=m&&m[O]||d.pointClass.prototype.applyOptions.apply({series:d},[g[O]]);for(l=0;l<b;l++)S=N[v[l]],isNumber(S)?y[l].push(S):null===S&&(y[l].hasNulls=!0)}else r=G?o[u]:null,isNumber(r)?y[0].push(r):null===r&&(y[0].hasNulls=!0)}return{groupedXData:c,groupedYData:f,groupMap:x}},dataGrouping={approximations:approximations,groupData:groupData},seriesProto=Series.prototype,baseProcessData=seriesProto.processData,baseGeneratePoints=seriesProto.generatePoints,commonOptions={groupPixelWidth:2,dateTimeLabelFormats:{millisecond:["%A, %b %e, %H:%M:%S.%L","%A, %b %e, %H:%M:%S.%L","-%H:%M:%S.%L"],second:["%A, %b %e, %H:%M:%S","%A, %b %e, %H:%M:%S","-%H:%M:%S"],minute:["%A, %b %e, %H:%M","%A, %b %e, %H:%M","-%H:%M"],hour:["%A, %b %e, %H:%M","%A, %b %e, %H:%M","-%H:%M"],day:["%A, %b %e, %Y","%A, %b %e","-%A, %b %e, %Y"],week:["Week from %A, %b %e, %Y","%A, %b %e","-%A, %b %e, %Y"],month:["%B %Y","%B","-%B %Y"],year:["%Y","%Y","-%Y"]}},specificOptions={line:{},spline:{},area:{},areaspline:{},arearange:{},column:{groupPixelWidth:10},columnrange:{groupPixelWidth:10},candlestick:{groupPixelWidth:10},ohlc:{groupPixelWidth:5}},defaultDataGroupingUnits=H.defaultDataGroupingUnits=[["millisecond",[1,2,5,10,20,25,50,100,200,500]],["second",[1,2,5,10,15,30]],["minute",[1,2,5,10,15,30]],["hour",[1,2,3,4,6,8,12]],["day",[1]],["week",[1]],["month",[1,3,6]],["year",null]];seriesProto.getDGApproximation=function(){return this.is("arearange")?"range":this.is("ohlc")?"ohlc":this.is("column")?"sum":"average"},seriesProto.groupData=groupData,seriesProto.processData=function(){var t,o,i,e,a=this.chart,r=this.options.dataGrouping,s=!1!==this.allowDG&&r&&pick(r.enabled,a.options.isStock),n=this.visible||!a.options.chart.ignoreHiddenSeries,p=this.currentDataGrouping,u=!1;if(this.forceCrop=s,this.groupPixelWidth=null,this.hasProcessed=!0,s&&!this.requireSorting&&(this.requireSorting=u=!0),o=!1===baseProcessData.apply(this,arguments)||!s,u&&(this.requireSorting=!1),!o){this.destroyGroupedData();var l,h=r.groupAll?this.xData:this.processedXData,d=r.groupAll?this.yData:this.processedYData,m=a.plotSizeX,g=this.xAxis,c=g.options.ordinal,f=this.groupPixelWidth=g.getGroupPixelWidth&&g.getGroupPixelWidth();if(f){t=!0,this.isDirty=!0,this.points=null;var x=g.getExtremes(),D=x.min,G=x.max,y=f*(G-D)/m*(c&&g.ordinal&&g.ordinal.getGroupIntervalFactor(D,G,this)||1),v=g.getTimeTicks(DateTimeAxis.AdditionsClass.prototype.normalizeTimeTickInterval(y,r.units||defaultDataGroupingUnits),Math.min(D,h[0]),Math.max(G,h[h.length-1]),g.options.startOfWeek,h,this.closestPointRange),b=seriesProto.groupData.apply(this,[h,d,v,r.approximation]),A=b.groupedXData,M=b.groupedYData,P=0;if(r.smoothed&&A.length){for(A[l=A.length-1]=Math.min(A[l],G);l--&&l>0;)A[l]+=y/2;A[0]=Math.max(A[0],D)}for(l=1;l<v.length;l++)v.info.segmentStarts&&-1!==v.info.segmentStarts.indexOf(l)||(P=Math.max(v[l]-v[l-1],P));(i=v.info).gapSize=P,this.closestPointRange=v.info.totalRange,this.groupMap=b.groupMap,defined(A[0])&&A[0]<g.min&&n&&((!defined(g.options.min)&&g.min<=g.dataMin||g.min===g.dataMin)&&(g.min=Math.min(A[0],g.min)),g.dataMin=Math.min(A[0],g.dataMin)),r.groupAll&&(A=(e=this.cropData(A,M,g.min,g.max,1)).xData,M=e.yData),this.processedXData=A,this.processedYData=M}else this.groupMap=null;this.hasGroupedData=t,this.currentDataGrouping=i,this.preventGraphAnimation=(p&&p.totalRange)!==(i&&i.totalRange)}},seriesProto.destroyGroupedData=function(){this.groupedData&&(this.groupedData.forEach(function(t,o){t&&(this.groupedData[o]=t.destroy?t.destroy():null)},this),this.groupedData.length=0)},seriesProto.generatePoints=function(){baseGeneratePoints.apply(this),this.destroyGroupedData(),this.groupedData=this.hasGroupedData?this.points:null},addEvent(Point,"update",function(){if(this.dataGroup)return error(24,!1,this.series.chart),!1}),addEvent(Tooltip,"headerFormatter",function(t){var o,i,e,a,r,s=this.chart,n=s.time,p=t.labelConfig,u=p.series,l=u.options,h=u.tooltipOptions,d=l.dataGrouping,m=h.xDateFormat,g=u.xAxis,c=h[(t.isFooter?"footer":"header")+"Format"];g&&"datetime"===g.options.type&&d&&isNumber(p.key)&&(i=u.currentDataGrouping,e=d.dateTimeLabelFormats||commonOptions.dateTimeLabelFormats,i?(a=e[i.unitName],1===i.count?m=a[0]:(m=a[1],o=a[2])):!m&&e&&(m=this.getXDateFormat(p,h,g)),r=n.dateFormat(m,p.key),o&&(r+=n.dateFormat(o,p.key+i.totalRange-1)),u.chart.styledMode&&(c=this.styledModeFormat(c)),t.text=format(c,{point:extend(p.point,{key:r}),series:u},s),t.preventDefault())}),addEvent(Series,"destroy",seriesProto.destroyGroupedData),addEvent(Series,"afterSetOptions",function(t){var o=t.options,i=this.type,e=this.chart.options.plotOptions,a=O.defaultOptions.plotOptions[i].dataGrouping,r=this.useCommonDataGrouping&&commonOptions;(specificOptions[i]||r)&&(a||(a=merge(commonOptions,specificOptions[i])),o.dataGrouping=merge(r,a,e.series&&e.series.dataGrouping,e[i].dataGrouping,this.userOptions.dataGrouping))}),addEvent(Axis,"afterSetScale",function(){this.series.forEach(function(t){t.hasProcessed=!1})}),Axis.prototype.getGroupPixelWidth=function(){var t,o,i,e=this.series,a=e.length,r=0,s=!1;for(t=a;t--;)(i=e[t].options.dataGrouping)&&(r=Math.max(r,pick(i.groupPixelWidth,commonOptions.groupPixelWidth)));for(t=a;t--;)(i=e[t].options.dataGrouping)&&e[t].hasProcessed&&(o=(e[t].processedXData||e[t].data).length,(e[t].groupPixelWidth||o>this.chart.plotSizeX/r||o&&i.forced)&&(s=!0));return s?r:0},Axis.prototype.setDataGrouping=function(t,o){var i;if(o=pick(o,!0),t||(t={forced:!1,units:null}),this instanceof Axis)for(i=this.series.length;i--;)this.series[i].update({dataGrouping:t},!1);else this.chart.options.series.forEach(function(o){o.dataGrouping=t},!1);this.ordinal&&(this.ordinal.slope=void 0),o&&this.chart.redraw()},H.dataGrouping=dataGrouping;export default dataGrouping;