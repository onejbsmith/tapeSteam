"use strict";import Chart from"../../Core/Chart/Chart.js";import H from"../../Core/Globals.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,wrap=U.wrap;import"../../Series/LineSeries.js";import butils from"./BoostUtils.js";import createAndAttachRenderer from"./BoostAttach.js";var index,Series=H.Series,seriesTypes=H.seriesTypes,noop=function(){},eachAsync=butils.eachAsync,pointDrawHandler=butils.pointDrawHandler,allocateIfNotSeriesBoosting=butils.allocateIfNotSeriesBoosting,renderIfNotSeriesBoosting=butils.renderIfNotSeriesBoosting,shouldForceChartSeriesBoosting=butils.shouldForceChartSeriesBoosting;function init(){extend(Series.prototype,{renderCanvas:function(){var e,r,t,i,s,o,a,n=this,p=n.options||{},l=!1,d=n.chart,h=this.xAxis,u=this.yAxis,c=p.xData||n.processedXData,m=p.yData||n.processedYData,g=p.data,x=h.getExtremes(),f=x.min,y=x.max,b=u.getExtremes(),B=b.min,v=b.max,S={},k=!!n.sampling,T=!1!==p.enableMouseTracking,C=p.threshold,A=u.getThreshold(C),G=n.pointArrayMap&&"low,high"===n.pointArrayMap.join(","),D=!!p.stacking,E=n.cropStart||0,w=n.requireSorting,j=!c,N="x"===p.findNearestPointBy,U=this.xData||this.options.xData||this.processedXData||!1,H=function(e,t,i){e=Math.ceil(e),index=N?e:e+","+t,T&&!S[index]&&(S[index]=!0,d.inverted&&(e=h.len-e,t=u.len-t),r.push({x:!!U&&U[E+i],clientX:e,plotX:e,plotY:t,i:E+i}))};l=createAndAttachRenderer(d,n),d.isBoosting=!0,a=l.settings,this.visible&&((this.points||this.graph)&&this.destroyGraphics(),d.isChartSeriesBoosting()?(this.markerGroup&&this.markerGroup!==d.markerGroup&&this.markerGroup.destroy(),this.markerGroup=d.markerGroup,this.renderTarget&&(this.renderTarget=this.renderTarget.destroy())):(this.markerGroup===d.markerGroup&&(this.markerGroup=void 0),this.markerGroup=n.plotGroup("markerGroup","markers",!0,1,d.seriesGroup)),r=this.points=[],n.buildKDTree=noop,l&&(allocateIfNotSeriesBoosting(l,this),l.pushSeries(n),renderIfNotSeriesBoosting(l,this,d)),d.renderer.forExport||(a.debug.timeKDTree&&console.time("kd tree building"),eachAsync(D?n.data:c||g,function(r,a){var n,p,l,c,g=!1,x=void 0===d.index,b=!0;return x||(j?(n=r[0],p=r[1]):(n=r,p=m[a]),G?(j&&(p=r.slice(1,3)),g=p[0],p=p[1]):D&&(n=r.x,g=(p=r.stackY)-r.y),w||(b=p>=B&&p<=v),!(null===p)&&n>=f&&n<=y&&b&&(l=h.toPixels(n,!0),k?(void 0!==s&&l!==e||(G||(g=p),(void 0===o||p>i)&&(i=p,o=a),(void 0===s||g<t)&&(t=g,s=a)),l!==e&&(void 0!==s&&(c=u.toPixels(i,!0),A=u.toPixels(t,!0),H(l,c,o),A!==c&&H(l,A,s)),s=o=void 0,e=l)):(c=Math.ceil(u.toPixels(p,!0)),H(l,c,a)))),!x},function(){fireEvent(n,"renderedCanvas"),delete n.buildKDTree,n.buildKDTree(),a.debug.timeKDTree&&console.timeEnd("kd tree building")})))}}),["heatmap","treemap"].forEach(function(e){seriesTypes[e]&&wrap(seriesTypes[e].prototype,"drawPoints",pointDrawHandler)}),seriesTypes.bubble&&(delete seriesTypes.bubble.prototype.buildKDTree,wrap(seriesTypes.bubble.prototype,"markerAttribs",function(e){return!this.isSeriesBoosting&&e.apply(this,[].slice.call(arguments,1))})),seriesTypes.scatter.prototype.fill=!0,extend(seriesTypes.area.prototype,{fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{fill:!0,sampling:!0}),Chart.prototype.callbacks.push(function(e){addEvent(e,"predraw",function(){e.boostForceChartBoost=void 0,e.boostForceChartBoost=shouldForceChartSeriesBoosting(e),e.isBoosting=!1,!e.isChartSeriesBoosting()&&e.didBoost&&(e.didBoost=!1),e.boostClear&&e.boostClear(),e.canvas&&e.ogl&&e.isChartSeriesBoosting()&&(e.didBoost=!0,e.ogl.allocateBuffer(e)),e.markerGroup&&e.xAxis&&e.xAxis.length>0&&e.yAxis&&e.yAxis.length>0&&e.markerGroup.translate(e.xAxis[0].pos,e.yAxis[0].pos)}),addEvent(e,"render",function(){e.ogl&&e.isChartSeriesBoosting()&&e.ogl.render(e)})})}export default init;