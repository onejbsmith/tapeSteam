"use strict";import Axis from"../Core/Axis/Axis.js";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import O from"../Core/Options.js";var defaultOptions=O.defaultOptions;import SVGElement from"../Core/Renderer/SVG/SVGElement.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,createElement=U.createElement,css=U.css,defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,discardElement=U.discardElement,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,pInt=U.pInt,splat=U.splat;extend(defaultOptions,{rangeSelector:{verticalAlign:"top",buttonTheme:{width:28,height:18,padding:2,zIndex:7},floating:!1,x:0,y:0,height:void 0,inputPosition:{align:"right",x:0,y:0},buttonPosition:{align:"left",x:0,y:0},labelStyle:{color:"#666666"}}}),defaultOptions.lang=merge(defaultOptions.lang,{rangeSelectorZoom:"Zoom",rangeSelectorFrom:"From",rangeSelectorTo:"To"});var RangeSelector=function(){function t(e){this.buttons=void 0,this.buttonOptions=t.prototype.defaultButtons,this.options=void 0,this.chart=e,this.init(e)}return t.prototype.clickButton=function(t,e){var n,i,o,a,r,s,l,p=this.chart,u=this.buttonOptions[t],d=p.xAxis[0],c=p.scroller&&p.scroller.getUnionExtremes()||d||{},g=c.dataMin,h=c.dataMax,m=d&&Math.round(Math.min(d.max,pick(h,d.max))),f=u.type,x=u._range,v=u.dataGrouping;if(null!==g&&null!==h){if(p.fixedRange=x,v&&(this.forcedDataGrouping=!0,Axis.prototype.setDataGrouping.call(d||{chart:this.chart},v,!1),this.frozenStates=u.preserveDataGrouping),"month"===f||"year"===f)d?(s={range:u,max:m,chart:p,dataMin:g,dataMax:h},n=d.minFromRange.call(s),isNumber(s.newMax)&&(m=s.newMax)):x=u;else if(x)n=Math.max(m-x,g),m=Math.min(n+x,h);else if("ytd"===f){if(!d)return void(this.deferredYTDClick=t);void 0===h&&(g=Number.MAX_VALUE,h=Number.MIN_VALUE,p.series.forEach(function(t){var e=t.xData;g=Math.min(e[0],g),h=Math.max(e[e.length-1],h)}),e=!1),n=o=(l=this.getYTDExtremes(h,g,p.time.useUTC)).min,m=l.max}else"all"===f&&d&&(n=g,m=h);defined(n)&&(n+=u._offsetMin),defined(m)&&(m+=u._offsetMax),this.setSelected(t),d?d.setExtremes(n,m,pick(e,1),null,{trigger:"rangeSelectorButton",rangeSelectorButton:u}):(i=splat(p.options.xAxis)[0],r=i.range,i.range=x,a=i.min,i.min=o,addEvent(p,"load",function(){i.range=r,i.min=a}))}},t.prototype.setSelected=function(t){this.selected=this.options.selected=t},t.prototype.init=function(t){var e=this,n=t.options.rangeSelector,i=n.buttons||e.defaultButtons.slice(),o=n.selected,a=function(){var t=e.minInput,n=e.maxInput;t&&t.blur&&fireEvent(t,"blur"),n&&n.blur&&fireEvent(n,"blur")};e.chart=t,e.options=n,e.buttons=[],e.buttonOptions=i,this.unMouseDown=addEvent(t.container,"mousedown",a),this.unResize=addEvent(t,"resize",a),i.forEach(e.computeButtonRange),void 0!==o&&i[o]&&this.clickButton(o,!1),addEvent(t,"load",function(){t.xAxis&&t.xAxis[0]&&addEvent(t.xAxis[0],"setExtremes",function(n){this.max-this.min!==t.fixedRange&&"rangeSelectorButton"!==n.trigger&&"updatedData"!==n.trigger&&e.forcedDataGrouping&&!e.frozenStates&&this.setDataGrouping(!1,!1)})})},t.prototype.updateButtonStates=function(){var t=this,e=this.chart,n=e.xAxis[0],i=Math.round(n.max-n.min),o=!n.hasVisibleSeries,a=e.scroller&&e.scroller.getUnionExtremes()||n,r=a.dataMin,s=a.dataMax,l=t.getYTDExtremes(s,r,e.time.useUTC),p=l.min,u=l.max,d=t.selected,c=isNumber(d),g=t.options.allButtonsEnabled,h=t.buttons;t.buttonOptions.forEach(function(e,a){var l,m,f=e._range,x=e.type,v=e.count||1,y=h[a],b=0,M=e._offsetMax-e._offsetMin,S=a===d,B=f>s-r,E=f<n.minRange,T=!1,w=!1,A=f===i;("month"===x||"year"===x)&&i+36e5>=864e5*{month:28,year:365}[x]*v-M&&i-36e5<=864e5*{month:31,year:366}[x]*v+M?A=!0:"ytd"===x?(A=u-p+M===i,T=!S):"all"===x&&(A=n.max-n.min>=s-r,w=!S&&c&&A),l=!g&&(B||E||w||o),m=S&&A||A&&!c&&!T||S&&t.frozenStates,l?b=3:m&&(c=!0,b=2),y.state!==b&&(y.setState(b),0===b&&d===a&&t.setSelected(null))})},t.prototype.computeButtonRange=function(t){var e=t.type,n=t.count||1,i={millisecond:1,second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5};i[e]?t._range=i[e]*n:"month"!==e&&"year"!==e||(t._range=24*{month:30,year:365}[e]*36e5*n),t._offsetMin=pick(t.offsetMin,0),t._offsetMax=pick(t.offsetMax,0),t._range+=t._offsetMax-t._offsetMin},t.prototype.setInputValue=function(t,e){var n=this.chart.options.rangeSelector,i=this.chart.time,o=this[t+"Input"];defined(e)&&(o.previousValue=o.HCTime,o.HCTime=e),o.value=i.dateFormat(n.inputEditDateFormat||"%Y-%m-%d",o.HCTime),this[t+"DateBox"].attr({text:i.dateFormat(n.inputDateFormat||"%b %e, %Y",o.HCTime)})},t.prototype.showInput=function(t){var e=this.inputGroup,n=this[t+"DateBox"];css(this[t+"Input"],{left:e.translateX+n.x+"px",top:e.translateY+"px",width:n.width-2+"px",height:n.height-2+"px",border:"2px solid silver"})},t.prototype.hideInput=function(t){css(this[t+"Input"],{border:0,width:"1px",height:"1px"}),this.setInputValue(t)},t.prototype.defaultInputDateParser=function(t,e){var n=new Date;return H.isSafari?Date.parse(t.split(" ").join("T")):e?Date.parse(t+"Z"):Date.parse(t)-60*n.getTimezoneOffset()*1e3},t.prototype.drawInput=function(t){var e,n,i,o=this,a=o.chart,r=a.renderer.style||{},s=a.renderer,l=a.options.rangeSelector,p=defaultOptions.lang,u=o.div,d="min"===t,c=this.inputGroup,g=this.defaultInputDateParser;function h(){var t,n=e.value,i=a.xAxis[0],r=a.scroller&&a.scroller.xAxis?a.scroller.xAxis:i,s=r.dataMin,p=r.dataMax;(t=(l.inputDateParser||g)(n,a.time.useUTC))!==e.previousValue&&(e.previousValue=t,isNumber(t)||(t=n.split("-"),t=Date.UTC(pInt(t[0]),pInt(t[1])-1,pInt(t[2]))),isNumber(t)&&(a.time.useUTC||(t+=60*(new Date).getTimezoneOffset()*1e3),d?t>o.maxInput.HCTime?t=void 0:t<s&&(t=s):t<o.minInput.HCTime?t=void 0:t>p&&(t=p),void 0!==t&&i.setExtremes(d?t:i.min,d?i.max:t,void 0,void 0,{trigger:"rangeSelectorInput"})))}this[t+"Label"]=n=s.label(p[d?"rangeSelectorFrom":"rangeSelectorTo"],this.inputGroup.offset).addClass("highcharts-range-label").attr({padding:2}).add(c),c.offset+=n.width+5,this[t+"DateBox"]=i=s.label("",c.offset).addClass("highcharts-range-input").attr({padding:2,width:l.inputBoxWidth||90,height:l.inputBoxHeight||17,"text-align":"center"}).on("click",function(){o.showInput(t),o[t+"Input"].focus()}),a.styledMode||i.attr({stroke:l.inputBoxBorderColor||"#cccccc","stroke-width":1}),i.add(c),c.offset+=i.width+(d?10:0),this[t+"Input"]=e=createElement("input",{name:t,className:"highcharts-range-selector",type:"text"},{top:a.plotTop+"px"},u),a.styledMode||(n.css(merge(r,l.labelStyle)),i.css(merge({color:"#333333"},r,l.inputStyle)),css(e,extend({position:"absolute",border:0,width:"1px",height:"1px",padding:0,textAlign:"center",fontSize:r.fontSize,fontFamily:r.fontFamily,top:"-9999em"},l.inputStyle))),e.onfocus=function(){o.showInput(t)},e.onblur=function(){e===H.doc.activeElement&&h(),o.hideInput(t),e.blur()},e.onchange=h,e.onkeypress=function(t){13===t.keyCode&&h()}},t.prototype.getPosition=function(){var t=this.chart,e=t.options.rangeSelector,n="top"===e.verticalAlign?t.plotTop-t.axisOffset[0]:0;return{buttonTop:n+e.buttonPosition.y,inputTop:n+e.inputPosition.y-10}},t.prototype.getYTDExtremes=function(t,e,n){var i,o=this.chart.time,a=new o.Date(t),r=o.get("FullYear",a),s=n?o.Date.UTC(r,0,1):+new o.Date(r,0,1);return i=Math.max(e||0,s),a=a.getTime(),{max:Math.min(t||a,a),min:i}},t.prototype.render=function(t,e){var n,i,o,a,r,s=this,l=s.chart,p=l.renderer,u=l.container,d=l.options,c=d.exporting&&!1!==d.exporting.enabled&&d.navigation&&d.navigation.buttonOptions,g=defaultOptions.lang,h=s.div,m=d.rangeSelector,f=pick(d.chart.style&&d.chart.style.zIndex,0)+1,x=m.floating,v=s.buttons,y=s.inputGroup,b=m.buttonTheme,M=m.buttonPosition,S=m.inputPosition,B=m.inputEnabled,E=b&&b.states,T=l.plotLeft,w=s.buttonGroup,A=s.rendered,C=s.options.verticalAlign,I=l.legend,D=I&&I.options,O=M.y,k=S.y,U=l.hasLoaded,G=U?"animate":"attr",R=0,N=0;if(!1!==m.enabled){var z,H,Y,_;if(A||(s.group=i=p.g("range-selector-group").attr({zIndex:7}).add(),s.buttonGroup=w=p.g("range-selector-buttons").add(i),s.zoomText=p.text(g.rangeSelectorZoom,0,15).add(w),l.styledMode||(s.zoomText.css(m.labelStyle),b["stroke-width"]=pick(b["stroke-width"],0)),s.buttonOptions.forEach(function(t,e){v[e]=p.button(t.text,0,0,function(n){var i,o=t.events&&t.events.click;o&&(i=o.call(t,n)),!1!==i&&s.clickButton(e),s.isActive=!0},b,E&&E.hover,E&&E.select,E&&E.disabled).attr({"text-align":"center"}).add(w)}),!1!==B&&(s.div=h=createElement("div",null,{position:"relative",height:0,zIndex:f}),u.parentNode.insertBefore(h,u),s.inputGroup=y=p.g("input-group").add(i),y.offset=0,s.drawInput("min"),s.drawInput("max"))),s.zoomText[G]({x:pick(T+M.x,T)}),n=pick(T+M.x,T)+s.zoomText.getBBox().width+5,s.buttonOptions.forEach(function(t,e){v[e][G]({x:n}),n+=v[e].width+pick(m.buttonSpacing,5)}),T=l.plotLeft-l.spacing[3],s.updateButtonStates(),c&&this.titleCollision(l)&&"top"===C&&"right"===M.align&&M.y+w.getBBox().height-12<(c.y||0)+c.height&&(R=-40),r=M.x-l.spacing[3],"right"===M.align?r+=R-T:"center"===M.align&&(r-=T/2),w.align({y:M.y,width:w.getBBox().width,align:M.align,x:r},!0,l.spacingBox),s.group.placed=U,s.buttonGroup.placed=U,!1!==B)R=c&&this.titleCollision(l)&&"top"===C&&"right"===S.align&&S.y-y.getBBox().height-12<(c.y||0)+c.height+l.spacing[0]?-40:0,"left"===S.align?r=T:"right"===S.align&&(r=-Math.max(l.axisOffset[1],-R)),y.align({y:S.y,width:y.getBBox().width,align:S.align,x:S.x+r-2},!0,l.spacingBox),z=y.alignAttr.translateX+y.alignOptions.x-R+y.getBBox().x+2,H=y.alignOptions.width,Y=w.alignAttr.translateX+w.getBBox().x,_=w.getBBox().width+20,(S.align===M.align||Y+_>z&&z+H>Y&&O<k+y.getBBox().height)&&y.attr({translateX:y.alignAttr.translateX+(l.axisOffset[1]>=-R?0:-R),translateY:y.alignAttr.translateY+w.getBBox().height+10}),s.setInputValue("min",t),s.setInputValue("max",e),s.inputGroup.placed=U;s.group.align({verticalAlign:C},!0,l.spacingBox),o=s.group.getBBox().height+20,a=s.group.alignAttr.translateY,"bottom"===C&&(N=a-(o=o+(D&&"bottom"===D.verticalAlign&&D.enabled&&!D.floating?I.legendHeight+pick(D.margin,10):0)-20)-(x?0:m.y)-(l.titleOffset?l.titleOffset[2]:0)-10),"top"===C?(x&&(N=0),l.titleOffset&&l.titleOffset[0]&&(N=l.titleOffset[0]),N+=l.margin[0]-l.spacing[0]||0):"middle"===C&&(k===O?N=k<0?a+void 0:a:(k||O)&&(k<0||O<0?N-=Math.min(k,O):N=a-o+void 0)),s.group.translate(m.x,m.y+Math.floor(N)),!1!==B&&(s.minInput.style.marginTop=s.group.translateY+"px",s.maxInput.style.marginTop=s.group.translateY+"px"),s.rendered=!0}},t.prototype.getHeight=function(){var t,e=this.options,n=this.group,i=e.inputPosition,o=e.buttonPosition,a=e.y,r=o.y,s=i.y,l=0;return e.height?e.height:(l=n?n.getBBox(!0).height+13+a:0,t=Math.min(s,r),(s<0&&r<0||s>0&&r>0)&&(l+=Math.abs(t)),l)},t.prototype.titleCollision=function(t){return!(t.options.title.text||t.options.subtitle.text)},t.prototype.update=function(t){var e=this.chart;merge(!0,e.options.rangeSelector,t),this.destroy(),this.init(e),e.rangeSelector.render()},t.prototype.destroy=function(){var e=this,n=e.minInput,i=e.maxInput;e.unMouseDown(),e.unResize(),destroyObjectProperties(e.buttons),n&&(n.onfocus=n.onblur=n.onchange=null),i&&(i.onfocus=i.onblur=i.onchange=null),objectEach(e,function(n,i){n&&"chart"!==i&&(n instanceof SVGElement?n.destroy():n instanceof window.HTMLElement&&discardElement(n)),n!==t.prototype[i]&&(e[i]=null)},this)},t}();RangeSelector.prototype.defaultButtons=[{type:"month",count:1,text:"1m"},{type:"month",count:3,text:"3m"},{type:"month",count:6,text:"6m"},{type:"ytd",text:"YTD"},{type:"year",count:1,text:"1y"},{type:"all",text:"All"}],Axis.prototype.minFromRange=function(){var t,e,n,i=this.range,o=i.type,a=this.max,r=this.chart.time,s=function(t,e){var n="year"===o?"FullYear":"Month",i=new r.Date(t),a=r.get(n,i);return r.set(n,i,a+e),a===r.get(n,i)&&r.set("Date",i,0),i.getTime()-t};return isNumber(i)?(t=a-i,n=i):(t=a+s(a,-i.count),this.chart&&(this.chart.fixedRange=a-t)),e=pick(this.dataMin,Number.MIN_VALUE),isNumber(t)||(t=e),t<=e&&(t=e,void 0===n&&(n=s(t,i.count)),this.newMax=Math.min(t+n,this.dataMax)),isNumber(a)||(t=void 0),t},H.RangeSelector||(addEvent(Chart,"afterGetContainer",function(){this.options.rangeSelector.enabled&&(this.rangeSelector=new RangeSelector(this))}),addEvent(Chart,"beforeRender",function(){var t,e=this.axes,n=this.rangeSelector;n&&(isNumber(n.deferredYTDClick)&&(n.clickButton(n.deferredYTDClick),delete n.deferredYTDClick),e.forEach(function(t){t.updateNames(),t.setScale()}),this.getAxisMargins(),n.render(),t=n.options.verticalAlign,n.options.floating||("bottom"===t?this.extraBottomMargin=!0:"middle"!==t&&(this.extraTopMargin=!0)))}),addEvent(Chart,"update",function(t){var e,n=t.options.rangeSelector,i=this.rangeSelector,o=this.extraBottomMargin,a=this.extraTopMargin;n&&n.enabled&&!defined(i)&&(this.options.rangeSelector.enabled=!0,this.rangeSelector=new RangeSelector(this)),this.extraBottomMargin=!1,this.extraTopMargin=!1,i&&(i.render(),e=n&&n.verticalAlign||i.options&&i.options.verticalAlign,i.options.floating||("bottom"===e?this.extraBottomMargin=!0:"middle"!==e&&(this.extraTopMargin=!0)),this.extraBottomMargin===o&&this.extraTopMargin===a||(this.isDirtyBox=!0))}),addEvent(Chart,"render",function(){var t,e=this.rangeSelector;e&&!e.options.floating&&(e.render(),"bottom"===(t=e.options.verticalAlign)?this.extraBottomMargin=!0:"middle"!==t&&(this.extraTopMargin=!0))}),addEvent(Chart,"getMargins",function(){var t,e=this.rangeSelector;e&&(t=e.getHeight(),this.extraTopMargin&&(this.plotTop+=t),this.extraBottomMargin&&(this.marginBottom+=t))}),Chart.prototype.callbacks.push(function(t){var e,n,i,o,a,r,s=t.rangeSelector;function l(){e=t.xAxis[0].getExtremes(),o=t.legend,r=null==s?void 0:s.options.verticalAlign,isNumber(e.min)&&s.render(e.min,e.max),s&&o.display&&"top"===r&&r===o.options.verticalAlign&&(a=merge(t.spacingBox),"vertical"===o.options.layout?a.y=t.plotTop:a.y+=s.getHeight(),o.group.placed=!1,o.align(a))}s&&(i=addEvent(t.xAxis[0],"afterSetExtremes",function(t){s.render(t.min,t.max)}),n=addEvent(t,"redraw",l),l()),addEvent(t,"destroy",function(){s&&(n(),i())})}),H.RangeSelector=RangeSelector);export default H.RangeSelector;