"use strict";import H from"../../Core/Globals.js";import Point from"../../Core/Series/Point.js";import U from"../../Core/Utilities.js";var find=U.find,isArray=U.isArray,merge=U.merge,pick=U.pick,splat=U.splat,objectEach=U.objectEach;import utilities from"./Utilities.js";function getPointTimeValue(n,i){return"function"==typeof i?i(n):pick(n[i],n.options[i])}function getTimeExtremes(n,i){return n.points.reduce(function(n,t){var e=getPointTimeValue(t,i);return n.min=Math.min(n.min,e),n.max=Math.max(n.max,e),n},{min:1/0,max:-1/0})}function getExtremesForInstrumentProps(n,i,t){var e,o=(i||[]).slice(0),r=null===(e=n.options.sonification)||void 0===e?void 0:e.defaultInstrumentOptions,s=function(n){return{instrumentMapping:n.mapping}};return r&&o.push(s(r)),n.series.forEach(function(n){var i,t=null===(i=n.options.sonification)||void 0===i?void 0:i.instruments;t&&(o=o.concat(t.map(s)))}),o.reduce(function(i,t){return Object.keys(t.instrumentMapping||{}).forEach(function(e){var o=t.instrumentMapping[e];"string"!=typeof o||i[o]||(i[o]=utilities.calculateDataExtremes(n,o))}),i},merge(t))}function getPointEarcons(n,i){return i.reduce(function(i,t){var e,o=t.earcon;return t.condition?(e=t.condition(n))instanceof H.sonification.Earcon?i.push(e):e&&i.push(o):t.onPoint&&n.id===t.onPoint&&i.push(o),i},[])}function makeInstrumentCopies(n){return n.map(function(n){var i=n.instrument,t=("string"==typeof i?H.sonification.instruments[i]:i).copy();return merge(n,{instrument:t})})}function applyMasterVolumeToInstruments(n,i){return n.forEach(function(n){var t=n.instrument;"string"!=typeof t&&t.setMasterVolume(i)}),n}function getFinalNoteDuration(n,i,t){var e=n.points[n.points.length-1];return i.reduce(function(n,i){var o,r=i.instrumentMapping.duration;return o="string"==typeof r?0:"function"==typeof r?r(e,t):r,Math.max(n,o)},0)}function buildTimelinePathFromSeries(n,i){var t=i.timeExtremes||getTimeExtremes(n,i.pointPlayTime),e=getExtremesForInstrumentProps(n.chart,i.instruments,i.dataExtremes),o=getFinalNoteDuration(n,i.instruments,e),r=pick(i.masterVolume,1),s=applyMasterVolumeToInstruments(makeInstrumentCopies(i.instruments),r),a=n.points.reduce(function(n,a){var u=getPointEarcons(a,i.earcons||[]),m=function(n){return utilities.virtualAxisTranslate(getPointTimeValue(n,i.pointPlayTime),t,{min:0,max:Math.max(i.duration-o,10)})}(a);return n.concat(new H.sonification.TimelineEvent({eventObject:a,time:m,id:a.id,playOptions:{instruments:s,dataExtremes:e,masterVolume:r}}),u.map(function(n){return new H.sonification.TimelineEvent({eventObject:n,time:m,playOptions:{volume:r}})}))},[]);return new H.sonification.TimelinePath({events:a,onStart:function(){i.onStart&&i.onStart(n)},onEventStart:function(n){var t=n.options&&n.options.eventObject;if(t instanceof Point){if(!t.series.visible&&!t.series.chart.series.some(function(n){return n.visible}))return n.timelinePath.timeline.pause(),n.timelinePath.timeline.resetCursor(),!1;i.onPointStart&&i.onPointStart(n,t)}},onEventEnd:function(n){var t=n.event&&n.event.options&&n.event.options.eventObject;t instanceof Point&&i.onPointEnd&&i.onPointEnd(n.event,t)},onEnd:function(){i.onEnd&&i.onEnd(n)},targetDuration:i.duration})}function seriesSonify(n){var i=getSeriesSonifyOptions(this,n),t=buildTimelinePathFromSeries(this,i),e=this.chart.sonification;e.timeline&&e.timeline.pause(),e.duration=i.duration,e.timeline=new H.sonification.Timeline({paths:[t]}),e.timeline.play()}function buildChartSonifySeriesOptions(n,i,t){var e,o,r,s=t.seriesOptions||{},a=(null===(r=null===(o=null===(e=n.chart.options.sonification)||void 0===e?void 0:e.defaultInstrumentOptions)||void 0===o?void 0:o.mapping)||void 0===r?void 0:r.pointPlayTime)||"x",u=chartOptionsToSonifySeriesOptions(n);return merge(u,{dataExtremes:i,timeExtremes:getTimeExtremes(n,a),instruments:t.instruments||u.instruments,onStart:t.onSeriesStart||u.onStart,onEnd:t.onSeriesEnd||u.onEnd,earcons:t.earcons||u.earcons,masterVolume:pick(t.masterVolume,u.masterVolume)},isArray(s)?find(s,function(i){return i.id===pick(n.id,n.options.id)})||{}:s,{pointPlayTime:a})}function buildPathOrder(n,i,t){var e;return"sequential"===n||"simultaneous"===n?(e=i.series.reduce(function(n,i){var e;return i.visible&&!1!==(null===(e=i.options.sonification)||void 0===e?void 0:e.enabled)&&n.push({series:i,seriesOptions:t(i)}),n},[]),"simultaneous"===n&&(e=[e])):e=n.reduce(function(n,e){var o=splat(e).reduce(function(n,e){var o;if("string"==typeof e){var r=i.get(e);r.visible&&(o={series:r,seriesOptions:t(r)})}else e instanceof H.sonification.Earcon&&(o=new H.sonification.TimelinePath({events:[new H.sonification.TimelineEvent({eventObject:e})]}));return e.silentWait&&(o=new H.sonification.TimelinePath({silentWait:e.silentWait})),o&&n.push(o),n},[]);return o.length&&n.push(o),n},[]),e}function addAfterSeriesWaits(n,i){return i?n.reduce(function(t,e,o){var r=splat(e);return t.push(r),o<n.length-1&&r.some(function(n){return n.series})&&t.push(new H.sonification.TimelinePath({silentWait:i})),t},[]):n}function getWaitTime(n){return n.reduce(function(n,i){var t=splat(i);return n+(1===t.length&&t[0].options&&t[0].options.silentWait||0)},0)}function syncSimultaneousPaths(n){var i=n.reduce(function(n,i){var t=i.events;return t&&t.length&&(n.min=Math.min(t[0].time,n.min),n.max=Math.max(t[t.length-1].time,n.max)),n},{min:1/0,max:-1/0});n.forEach(function(n){var t=n.events,e=t&&t.length,o=[];e&&t[0].time<=i.min||o.push(new H.sonification.TimelineEvent({time:i.min})),e&&t[t.length-1].time>=i.max||o.push(new H.sonification.TimelineEvent({time:i.max})),o.length&&n.addTimelineEvents(o)})}function getSimulPathDurationTotal(n){return n.reduce(function(n,i){return n+splat(i).reduce(function(n,i){var t=i.series&&i.seriesOptions&&i.seriesOptions.timeExtremes;return t?Math.max(n,t.max-t.min):n},0)},0)}function getSeriesDurationMs(n,i,t){return utilities.virtualAxisTranslate(n,{min:0,max:i},{min:0,max:t})}function buildPathsFromOrder(n,i){var t=Math.max(i-getWaitTime(n),0),e=getSimulPathDurationTotal(n);return n.reduce(function(n,i){var o=splat(i).reduce(function(n,i){return i instanceof H.sonification.TimelinePath?n.push(i):i.series&&(i.seriesOptions.duration=i.seriesOptions.duration||getSeriesDurationMs(i.seriesOptions.timeExtremes.max-i.seriesOptions.timeExtremes.min,e,t),n.push(buildTimelinePathFromSeries(i.series,i.seriesOptions))),n},[]);return n.push(o),n},[])}function getSeriesInstrumentOptions(n,i){var t,e;if(null==i?void 0:i.instruments)return i.instruments;var o=(null===(t=n.chart.options.sonification)||void 0===t?void 0:t.defaultInstrumentOptions)||{},r=(null===(e=n.options.sonification)||void 0===e?void 0:e.instruments)||[{}],s=function(n){objectEach(n,function(i,t){null===i&&delete n[t]})};return r.map(function(n){return s(n.mapping||{}),s(n),{instrument:n.instrument||o.instrument,instrumentOptions:merge(o,n,{mapping:void 0,instrument:void 0}),instrumentMapping:merge(o.mapping,n.mapping)}})}function chartOptionsToSonifySeriesOptions(n){var i,t,e=n.options.sonification||{},o=n.chart.options.sonification||{},r=o.events||{},s=e.events||{};return{onEnd:s.onSeriesEnd||r.onSeriesEnd,onStart:s.onSeriesStart||r.onSeriesStart,onPointEnd:s.onPointEnd||r.onPointEnd,onPointStart:s.onPointStart||r.onPointStart,pointPlayTime:null===(t=null===(i=o.defaultInstrumentOptions)||void 0===i?void 0:i.mapping)||void 0===t?void 0:t.pointPlayTime,masterVolume:o.masterVolume,instruments:getSeriesInstrumentOptions(n),earcons:e.earcons||o.earcons}}function getSeriesSonifyOptions(n,i){var t=n.chart.options.sonification,e=n.options.sonification;return merge({duration:(null==e?void 0:e.duration)||(null==t?void 0:t.duration)},chartOptionsToSonifySeriesOptions(n),i)}function getChartSonifyOptions(n,i){var t,e,o,r,s,a=n.options.sonification||{};return merge({duration:a.duration,afterSeriesWait:a.afterSeriesWait,pointPlayTime:null===(e=null===(t=a.defaultInstrumentOptions)||void 0===t?void 0:t.mapping)||void 0===e?void 0:e.pointPlayTime,order:a.order,onSeriesStart:null===(o=a.events)||void 0===o?void 0:o.onSeriesStart,onSeriesEnd:null===(r=a.events)||void 0===r?void 0:r.onSeriesEnd,onEnd:null===(s=a.events)||void 0===s?void 0:s.onEnd},i)}function chartSonify(n){var i=getChartSonifyOptions(this,n);this.sonification.timeline&&this.sonification.timeline.pause(),this.sonification.duration=i.duration;var t=getExtremesForInstrumentProps(this,i.instruments,i.dataExtremes),e=buildPathOrder(i.order,this,function(n){return buildChartSonifySeriesOptions(n,t,i)}),o=buildPathsFromOrder(e=addAfterSeriesWaits(e,i.afterSeriesWait||0),i.duration);o.forEach(function(n){syncSimultaneousPaths(n)}),this.sonification.timeline=new H.sonification.Timeline({paths:o,onEnd:i.onEnd}),this.sonification.timeline.play()}function getCurrentPoints(){var n;return this.sonification.timeline?(n=this.sonification.timeline.getCursor(),Object.keys(n).map(function(i){return n[i].eventObject}).filter(function(n){return n instanceof Point})):[]}function setCursor(n){var i=this.sonification.timeline;i&&splat(n).forEach(function(n){i.setCursor(n.id)})}function pause(n){this.sonification.timeline?this.sonification.timeline.pause(pick(n,!0)):this.sonification.currentlyPlayingPoint&&this.sonification.currentlyPlayingPoint.cancelSonify(n)}function resume(n){this.sonification.timeline&&this.sonification.timeline.play(n)}function rewind(n){this.sonification.timeline&&this.sonification.timeline.rewind(n)}function cancel(n){this.pauseSonify(n),this.resetSonifyCursor()}function resetCursor(){this.sonification.timeline&&this.sonification.timeline.resetCursor()}function resetCursorEnd(){this.sonification.timeline&&this.sonification.timeline.resetCursorEnd()}var chartSonifyFunctions={chartSonify:chartSonify,seriesSonify:seriesSonify,pause:pause,resume:resume,rewind:rewind,cancel:cancel,getCurrentPoints:getCurrentPoints,setCursor:setCursor,resetCursor:resetCursor,resetCursorEnd:resetCursorEnd};export default chartSonifyFunctions;