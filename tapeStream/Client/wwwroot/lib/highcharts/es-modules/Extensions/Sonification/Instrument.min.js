"use strict";import H from"../../Core/Globals.js";import U from"../../Core/Utilities.js";var error=U.error,merge=U.merge,pick=U.pick,uniqueKey=U.uniqueKey,defaultOptions={type:"oscillator",playCallbackInterval:20,masterVolume:1,oscillator:{waveformShape:"sine"}};function Instrument(t){this.init(t)}Instrument.prototype.init=function(t){if(this.initAudioContext()){this.options=merge(defaultOptions,t),this.id=this.options.id=t&&t.id||uniqueKey(),this.masterVolume=this.options.masterVolume||0;var e=H.audioContext,o=this.destinationNode||e.destination;this.gainNode=e.createGain(),this.setGain(0),this.panNode=e.createStereoPanner&&e.createStereoPanner(),this.panNode?(this.setPan(0),this.gainNode.connect(this.panNode),this.panNode.connect(o)):this.gainNode.connect(o),"oscillator"===this.options.type&&this.initOscillator(this.options.oscillator),this.playCallbackTimers=[]}else error(29)},Instrument.prototype.copy=function(t){return new Instrument(merge(this.options,{id:null},t))},Instrument.prototype.initAudioContext=function(){var t=H.win.AudioContext||H.win.webkitAudioContext,e=!!H.audioContext;return!!t&&(H.audioContext=H.audioContext||new t,!e&&H.audioContext&&"running"===H.audioContext.state&&H.audioContext.suspend(),!!(H.audioContext&&H.audioContext.createOscillator&&H.audioContext.createGain))},Instrument.prototype.initOscillator=function(t){var e=H.audioContext;this.oscillator=e.createOscillator(),this.oscillator.type=t.waveformShape,this.oscillator.connect(this.gainNode),this.oscillatorStarted=!1},Instrument.prototype.setPan=function(t){this.panNode&&this.panNode.pan.setValueAtTime(t,H.audioContext.currentTime)},Instrument.prototype.setGain=function(t,e){var o=this.gainNode,i=t*this.masterVolume;o&&(i>1.2&&(console.warn("Highcharts sonification warning: Volume of instrument set too high."),i=1.2),e?(o.gain.setValueAtTime(o.gain.value,H.audioContext.currentTime),o.gain.linearRampToValueAtTime(i,H.audioContext.currentTime+e/1e3)):o.gain.setValueAtTime(i,H.audioContext.currentTime))},Instrument.prototype.cancelGainRamp=function(){this.gainNode&&this.gainNode.gain.cancelScheduledValues(0)},Instrument.prototype.setMasterVolume=function(t){this.masterVolume=t||0},Instrument.prototype.getValidFrequency=function(t,e,o){var i=this.options.allowedFrequencies,n=pick(o,1/0),a=pick(e,-1/0);return i&&i.length?i.reduce(function(e,o){return Math.abs(o-t)<Math.abs(e-t)&&o<n&&o>a?o:e},1/0):t},Instrument.prototype.clearPlayCallbackTimers=function(){this.playCallbackTimers.forEach(function(t){clearInterval(t)}),this.playCallbackTimers=[]},Instrument.prototype.setFrequency=function(t,e){var o=e||{},i=this.getValidFrequency(t,o.min,o.max);"oscillator"===this.options.type&&this.oscillatorPlay(i)},Instrument.prototype.oscillatorPlay=function(t){this.oscillatorStarted||(this.oscillator.start(),this.oscillatorStarted=!0),this.oscillator.frequency.setValueAtTime(t,H.audioContext.currentTime)},Instrument.prototype.preparePlay=function(){this.setGain(.001),"suspended"===H.audioContext.state&&H.audioContext.resume(),this.oscillator&&!this.oscillatorStarted&&(this.oscillator.start(),this.oscillatorStarted=!0)},Instrument.prototype.play=function(t){var e=this,o=t.duration||0,i=function(o,i,n){var a=t.duration,s=0,r=e.options.playCallbackInterval;if("function"==typeof o){var l=setInterval(function(){var t=++s*r/a;t>=1?(e[i](o(1),n),clearInterval(l)):e[i](o(t),n)},r);e.playCallbackTimers.push(l)}else e[i](o,n)};if(e.id){if("suspended"===H.audioContext.state||this.oscillator&&!this.oscillatorStarted)return e.preparePlay(),void setTimeout(function(){e.play(t)},10);e.playCallbackTimers.length&&e.clearPlayCallbackTimers(),e.cancelGainRamp(),e.stopOscillatorTimeout&&(clearTimeout(e.stopOscillatorTimeout),delete e.stopOscillatorTimeout),e.stopTimeout&&(clearTimeout(e.stopTimeout),delete e.stopTimeout,e.stopCallback&&(e._play=e.play,e.play=function(){},e.stopCallback("cancelled"),e.play=e._play));var n=o<H.sonification.fadeOutDuration+20;e.stopCallback=t.onEnd;var a=function(){delete e.stopTimeout,e.stop(n)};o?(e.stopTimeout=setTimeout(a,n?o:o-H.sonification.fadeOutDuration),i(t.frequency,"setFrequency",{minFrequency:t.minFrequency,maxFrequency:t.maxFrequency}),i(pick(t.volume,1),"setGain",4),i(pick(t.pan,0),"setPan")):a()}},Instrument.prototype.mute=function(){this.setGain(1e-4,.8*H.sonification.fadeOutDuration)},Instrument.prototype.stop=function(t,e,o){var i=this,n=function(){i.stopOscillatorTimeout&&delete i.stopOscillatorTimeout;try{i.oscillator.stop()}catch(t){}i.oscillator.disconnect(i.gainNode),i.initOscillator(i.options.oscillator),e&&e(o),i.stopCallback&&i.stopCallback(o)};i.playCallbackTimers.length&&i.clearPlayCallbackTimers(),i.stopTimeout&&clearTimeout(i.stopTimeout),t?(i.setGain(0),n()):(i.mute(),i.stopOscillatorTimeout=setTimeout(n,H.sonification.fadeOutDuration+100))};export default Instrument;