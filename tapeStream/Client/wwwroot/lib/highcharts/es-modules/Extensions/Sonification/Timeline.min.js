"use strict";import H from"../../Core/Globals.js";import U from"../../Core/Utilities.js";var merge=U.merge,splat=U.splat,uniqueKey=U.uniqueKey;import utilities from"./Utilities.js";function TimelineEvent(t){this.init(t||{})}function TimelinePath(t){this.init(t)}function Timeline(t){this.init(t||{})}TimelineEvent.prototype.init=function(t){this.options=t,this.time=t.time||0,this.id=this.options.id=t.id||uniqueKey()},TimelineEvent.prototype.play=function(t){var n=this.options.eventObject,i=this.options.onEnd,e=t&&t.onEnd,s=this.options.playOptions&&this.options.playOptions.onEnd,a=merge(this.options.playOptions,t);n&&n.sonify?(a.onEnd=i||e||s?function(){var t=arguments;[i,e,s].forEach(function(n){n&&n.apply(this,t)})}:void 0,n.sonify(a)):(e&&e(),i&&i())},TimelineEvent.prototype.cancel=function(t){this.options.eventObject.cancelSonify(t)},TimelinePath.prototype.init=function(t){this.options=t,this.id=this.options.id=t.id||uniqueKey(),this.cursor=0,this.eventsPlaying={},this.events=t.silentWait?[new TimelineEvent({time:0}),new TimelineEvent({time:t.silentWait})]:this.options.events,this.targetDuration=t.targetDuration||t.silentWait,this.sortEvents(),this.updateEventIdMap(),this.signalHandler=new utilities.SignalHandler(["playOnEnd","masterOnEnd","onStart","onEventStart","onEventEnd"]),this.signalHandler.registerSignalCallbacks(merge(t,{masterOnEnd:t.onEnd}))},TimelinePath.prototype.sortEvents=function(){this.events=this.events.sort(function(t,n){return t.time-n.time})},TimelinePath.prototype.updateEventIdMap=function(){this.eventIdMap=this.events.reduce(function(t,n,i){return t[n.id]=i,t},{})},TimelinePath.prototype.addTimelineEvents=function(t){this.events=this.events.concat(t),this.sortEvents(),this.updateEventIdMap()},TimelinePath.prototype.getCursor=function(){return this.events[this.cursor]},TimelinePath.prototype.setCursor=function(t){var n=this.eventIdMap[t];return void 0!==n&&(this.cursor=n,!0)},TimelinePath.prototype.play=function(t){this.pause(),this.signalHandler.emitSignal("onStart"),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playEvents(1)},TimelinePath.prototype.rewind=function(t){this.pause(),this.signalHandler.emitSignal("onStart"),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playEvents(-1)},TimelinePath.prototype.resetCursor=function(){this.cursor=0},TimelinePath.prototype.resetCursorEnd=function(){this.cursor=this.events.length-1},TimelinePath.prototype.pause=function(t){var n=this;clearTimeout(n.nextScheduledPlay),Object.keys(n.eventsPlaying).forEach(function(i){n.eventsPlaying[i]&&n.eventsPlaying[i].cancel(t)}),n.eventsPlaying={}},TimelinePath.prototype.playEvents=function(t){var n,i=this,e=i.events[this.cursor],s=i.events[this.cursor+t],a=function(t){i.signalHandler.emitSignal("masterOnEnd",t),i.signalHandler.emitSignal("playOnEnd",t)};e.timelinePath=i,!1!==i.signalHandler.emitSignal("onEventStart",e)?(i.eventsPlaying[e.id]=e,e.play({onEnd:function(t){var n={event:e,cancelled:!!t};delete i.eventsPlaying[e.id],i.signalHandler.emitSignal("onEventEnd",n),s||a(n)}}),s&&((n=Math.abs(s.time-e.time))<1?(i.cursor+=t,i.playEvents(t)):this.nextScheduledPlay=setTimeout(function(){i.cursor+=t,i.playEvents(t)},n))):a({event:e,cancelled:!0})},Timeline.prototype.init=function(t){this.options=t,this.cursor=0,this.paths=t.paths||[],this.pathsPlaying={},this.signalHandler=new utilities.SignalHandler(["playOnEnd","masterOnEnd","onPathStart","onPathEnd"]),this.signalHandler.registerSignalCallbacks(merge(t,{masterOnEnd:t.onEnd}))},Timeline.prototype.play=function(t){this.pause(),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playPaths(1)},Timeline.prototype.rewind=function(t){this.pause(),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playPaths(-1)},Timeline.prototype.playPaths=function(t){var n=this,i=n.signalHandler;if(!n.paths.length){var e={cancelled:!1};return i.emitSignal("playOnEnd",e),void i.emitSignal("masterOnEnd",e)}var s=splat(this.paths[this.cursor]),a=this.paths[this.cursor+t],r=0;s.forEach(function(e){e&&(e.timeline=n,setTimeout(function(){!function(e){i.emitSignal("onPathStart",e),n.pathsPlaying[e.id]=e,e[t>0?"play":"rewind"](function(l){var o=l&&l.cancelled,h={path:e,cancelled:o};delete n.pathsPlaying[e.id],i.emitSignal("onPathEnd",h),++r>=s.length&&(a&&!o?(n.cursor+=t,splat(a).forEach(function(n){n[t>0?"resetCursor":"resetCursorEnd"]()}),n.playPaths(t)):(i.emitSignal("playOnEnd",h),i.emitSignal("masterOnEnd",h)))})}(e)},H.sonification.fadeOutDuration))})},Timeline.prototype.pause=function(t){var n=this;Object.keys(n.pathsPlaying).forEach(function(i){n.pathsPlaying[i]&&n.pathsPlaying[i].pause(t)}),n.pathsPlaying={}},Timeline.prototype.resetCursor=function(){this.paths.forEach(function(t){splat(t).forEach(function(t){t.resetCursor()})}),this.cursor=0},Timeline.prototype.resetCursorEnd=function(){this.paths.forEach(function(t){splat(t).forEach(function(t){t.resetCursorEnd()})}),this.cursor=this.paths.length-1},Timeline.prototype.setCursor=function(t){return this.paths.some(function(n){return splat(n).some(function(n){return n.setCursor(t)})})},Timeline.prototype.getCursor=function(){return this.getCurrentPlayingPaths().reduce(function(t,n){return t[n.id]=n.getCursor(),t},{})},Timeline.prototype.atStart=function(){return!this.cursor&&!splat(this.paths[0]).some(function(t){return t.cursor})},Timeline.prototype.getCurrentPlayingPaths=function(){return this.paths.length?splat(this.paths[this.cursor]):[]};var timelineClasses={TimelineEvent:TimelineEvent,TimelinePath:TimelinePath,Timeline:Timeline};export default timelineClasses;