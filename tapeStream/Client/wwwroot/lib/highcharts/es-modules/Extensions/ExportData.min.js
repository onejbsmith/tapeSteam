"use strict";import Axis from"../Core/Axis/Axis.js";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";var doc=H.doc,seriesTypes=H.seriesTypes,win=H.win;import U from"../Core/Utilities.js";var addEvent=U.addEvent,defined=U.defined,extend=U.extend,find=U.find,fireEvent=U.fireEvent,getOptions=U.getOptions,isNumber=U.isNumber,pick=U.pick,setOptions=U.setOptions;import DownloadURL from"../Extensions/DownloadURL.js";var downloadURL=DownloadURL.downloadURL;function htmlencode(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}function getBlobFromContent(t,e){var a=win.navigator,i=a.userAgent.indexOf("WebKit")>-1&&a.userAgent.indexOf("Chrome")<0,o=win.URL||win.webkitURL||win;try{if(a.msSaveOrOpenBlob&&win.MSBlobBuilder){var n=new win.MSBlobBuilder;return n.append(t),n.getBlob("image/svg+xml")}if(!i)return o.createObjectURL(new win.Blob(["\ufeff"+t],{type:e}))}catch(t){}}setOptions({exporting:{csv:{annotations:{itemDelimiter:"; ",join:!1},columnHeaderFormatter:null,dateFormat:"%Y-%m-%d %H:%M:%S",decimalPoint:null,itemDelimiter:null,lineDelimiter:"\n"},showTable:!1,useMultiLevelHeaders:!0,useRowspanHeaders:!0},lang:{downloadCSV:"Download CSV",downloadXLS:"Download XLS",exportData:{annotationHeader:"Annotations",categoryHeader:"Category",categoryDatetimeHeader:"DateTime"},viewData:"View data table",hideData:"Hide data table"}}),addEvent(Chart,"render",function(){this.options&&this.options.exporting&&this.options.exporting.showTable&&!this.options.chart.forExport&&!this.dataTableDiv&&this.viewData()}),Chart.prototype.setUpKeyToAxis=function(){seriesTypes.arearange&&(seriesTypes.arearange.prototype.keyToAxis={low:"y",high:"y"}),seriesTypes.gantt&&(seriesTypes.gantt.prototype.keyToAxis={start:"x",end:"x"})},Chart.prototype.getDataRows=function(t){var e,a,i,o,n,r,s,l,p=this.hasParallelCoordinates,c=this.time,d=this.options.exporting&&this.options.exporting.csv||{},h=this.xAxis,m={},x=[],u=[],f=[],g=this.options.lang.exportData,y=g.categoryHeader,b=g.categoryDatetimeHeader,v=function(e,a,i){if(d.columnHeaderFormatter){var o=d.columnHeaderFormatter(e,a,i);if(!1!==o)return o}return e?e instanceof Axis?e.options.title&&e.options.title.text||(e.dateTime?b:y):t?{columnTitle:i>1?a:e.name,topLevelColumnTitle:e.name}:e.name+(i>1?" ("+a+")":""):y},w=function(t,e,a){var i={},o={};return e.forEach(function(e){var n=(t.keyToAxis&&t.keyToAxis[e]||e)+"Axis",r=isNumber(a)?t.chart[n][a]:t[n];i[e]=r&&r.categories||[],o[e]=r&&r.dateTime}),{categoryMap:i,dateTimeValueAxisMap:o}},D=[];for(n in o=0,this.setUpKeyToAxis(),this.series.forEach(function(e){var a,n,r=e.options.keys,s=e.xAxis,l=r||function(t,e){if(t.data.filter(function(t){return void 0!==t.y&&t.name}).length&&e&&!e.categories&&!t.keyToAxis)return t.pointArrayMap&&t.pointArrayMap.filter(function(t){return"x"===t}).length?(t.pointArrayMap.unshift("x"),t.pointArrayMap):["x","y"];return t.pointArrayMap||["y"]}(e,s),x=l.length,g=!e.requireSorting&&{},y=h.indexOf(s),b=w(e,l);if(!1!==e.options.includeInDataExport&&!e.options.isInternal&&!1!==e.visible){for(find(D,function(t){return t[0]===y})||D.push([y,o]),n=0;n<x;)i=v(e,l[n],l.length),f.push(i.columnTitle||i),t&&u.push(i.topLevelColumnTitle||i),n++;a={chart:e.chart,autoIncrement:e.autoIncrement,options:e.options,pointArrayMap:e.pointArrayMap},e.options.data.forEach(function(t,i){var r,h,u,f,v;for(p&&(b=w(e,l,i)),v={series:a},e.pointClass.prototype.applyOptions.apply(v,[t]),r=v.x,f=e.data[i]&&e.data[i].name,n=0,(!s||"name"===e.exportKey||!p&&s&&s.hasNames&&f)&&(r=f),g&&(g[r]&&(r+="|"+i),g[r]=!0),m[r]||(m[r]=[],m[r].xValues=[]),m[r].x=v.x,m[r].name=f,m[r].xValues[y]=v.x;n<x;)u=v[h=l[n]],m[r][o+n]=pick(b.categoryMap[h][u],b.dateTimeValueAxisMap[h]?c.dateFormat(d.dateFormat,u):null,u),n++}),o+=n}}),m)Object.hasOwnProperty.call(m,n)&&x.push(m[n]);for(a=t?[u,f]:[f],o=D.length;o--;)s=D[o][0],l=D[o][1],e=h[s],x.sort(function(t,e){return t.xValues[s]-e.xValues[s]}),r=v(e),a[0].splice(l,0,r),t&&a[1]&&a[1].splice(l,0,r),x.forEach(function(t){var a=t.name;e&&!defined(a)&&(e.dateTime?(t.x instanceof Date&&(t.x=t.x.getTime()),a=c.dateFormat(d.dateFormat,t.x)):a=e.categories?pick(e.names[t.x],e.categories[t.x],t.x):t.x),t.splice(l,0,a)});return a=a.concat(x),fireEvent(this,"exportData",{dataRows:a}),a},Chart.prototype.getCSV=function(t){var e="",a=this.getDataRows(),i=this.options.exporting.csv,o=pick(i.decimalPoint,","!==i.itemDelimiter&&t?1.1.toLocaleString()[1]:"."),n=pick(i.itemDelimiter,","===o?";":","),r=i.lineDelimiter;return a.forEach(function(t,i){for(var s="",l=t.length;l--;)"string"==typeof(s=t[l])&&(s='"'+s+'"'),"number"==typeof s&&"."!==o&&(s=s.toString().replace(".",o)),t[l]=s;e+=t.join(n),i<a.length-1&&(e+=r)}),e},Chart.prototype.getTable=function(t){var e='<table id="highcharts-data-table-'+this.index+'">',a=this.options,i=t?1.1.toLocaleString()[1]:".",o=pick(a.exporting.useMultiLevelHeaders,!0),n=this.getDataRows(o),r=0,s=o?n.shift():null,l=n.shift(),p=function(t,e,a,o){var n=pick(o,""),r="text"+(e?" "+e:"");return"number"==typeof n?(n=n.toString(),","===i&&(n=n.replace(".",i)),r="number"):o||(r="empty"),"<"+t+(a?" "+a:"")+' class="'+r+'">'+n+"</"+t+">"};!1!==a.exporting.tableCaption&&(e+='<caption class="highcharts-table-caption">'+pick(a.exporting.tableCaption,a.title.text?htmlencode(a.title.text):"Chart")+"</caption>");for(var c=0,d=n.length;c<d;++c)n[c].length>r&&(r=n[c].length);e+=function(t,e,i){var n,r,s="<thead>",l=0,c=i||e&&e.length,d=0;if(o&&t&&e&&!function(t,e){var a=t.length;if(e.length!==a)return!1;for(;a--;)if(t[a]!==e[a])return!1;return!0}(t,e)){for(s+="<tr>";l<c;++l)(n=t[l])===t[l+1]?++d:d?(s+=p("th","highcharts-table-topheading",'scope="col" colspan="'+(d+1)+'"',n),d=0):(n===e[l]?a.exporting.useRowspanHeaders?(r=2,delete e[l]):(r=1,e[l]=""):r=1,s+=p("th","highcharts-table-topheading",'scope="col"'+(r>1?' valign="top" rowspan="'+r+'"':""),n));s+="</tr>"}if(e){for(s+="<tr>",l=0,c=e.length;l<c;++l)void 0!==e[l]&&(s+=p("th",null,'scope="col"',e[l]));s+="</tr>"}return s+="</thead>"}(s,l,Math.max(r,l.length)),e+="<tbody>",n.forEach(function(t){e+="<tr>";for(var a=0;a<r;a++)e+=p(a?"td":"th",null,a?"":'scope="row"',t[a]);e+="</tr>"});var h={html:e+="</tbody></table>"};return fireEvent(this,"afterGetTable",h),h.html},Chart.prototype.downloadCSV=function(){var t=this.getCSV(!0);downloadURL(getBlobFromContent(t,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(t),this.getFilename()+".csv")},Chart.prototype.downloadXLS=function(){var t,e='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Ark1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>td{border:none;font-family: Calibri, sans-serif;} .number{mso-number-format:"0.00";} .text{ mso-number-format:"@";}</style><meta name=ProgId content=Excel.Sheet><meta charset=UTF-8></head><body>'+this.getTable(!0)+"</body></html>";downloadURL(getBlobFromContent(e,"application/vnd.ms-excel")||"data:application/vnd.ms-excel;base64,"+(t=e,win.btoa(unescape(encodeURIComponent(t)))),this.getFilename()+".xls")},Chart.prototype.viewData=function(){this.dataTableDiv||(this.dataTableDiv=doc.createElement("div"),this.dataTableDiv.className="highcharts-data-table",this.renderTo.parentNode.insertBefore(this.dataTableDiv,this.renderTo.nextSibling),this.dataTableDiv.innerHTML=this.getTable()),""!==this.dataTableDiv.style.display&&"none"!==this.dataTableDiv.style.display||(this.dataTableDiv.style.display="block"),this.isDataTableVisible=!0,fireEvent(this,"afterViewData",this.dataTableDiv)},Chart.prototype.hideData=function(){this.dataTableDiv&&"block"===this.dataTableDiv.style.display&&(this.dataTableDiv.style.display="none"),this.isDataTableVisible=!1},Chart.prototype.toggleDataTable=function(){var t=this.exportDivElements,e=this.options.exporting,a=e&&e.buttons&&e.buttons.contextButton.menuItems,i=this.options.lang;this.isDataTableVisible?this.hideData():this.viewData(),(null==exportingOptions?void 0:exportingOptions.menuItemDefinitions)&&(null==i?void 0:i.viewData)&&i.hideData&&a&&t&&t.length&&(t[a.indexOf("viewData")].innerHTML=this.isDataTableVisible?i.hideData:i.viewData)};var exportingOptions=getOptions().exporting;exportingOptions&&(extend(exportingOptions.menuItemDefinitions,{downloadCSV:{textKey:"downloadCSV",onclick:function(){this.downloadCSV()}},downloadXLS:{textKey:"downloadXLS",onclick:function(){this.downloadXLS()}},viewData:{textKey:"viewData",onclick:function(){this.toggleDataTable()}}}),exportingOptions.buttons&&exportingOptions.buttons.contextButton.menuItems.push("separator","downloadCSV","downloadXLS","viewData")),seriesTypes.map&&(seriesTypes.map.prototype.exportKey="name"),seriesTypes.mapbubble&&(seriesTypes.mapbubble.prototype.exportKey="name"),seriesTypes.treemap&&(seriesTypes.treemap.prototype.exportKey="name");