"use strict";import Ajax from"../Extensions/Ajax.js";var ajax=Ajax.ajax;import BaseSeries from"../Core/Series/Series.js";import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";var doc=H.doc;import Point from"../Core/Series/Point.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,defined=U.defined,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,splat=U.splat,seriesTypes=BaseSeries.seriesTypes,Data=function(){function e(e,t,r){this.chart=void 0,this.chartOptions=void 0,this.firstRowAsNames=void 0,this.rawColumns=void 0,this.options=void 0,this.dateFormats={"YYYY/mm/dd":{regex:/^([0-9]{4})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{1,2})$/,parser:function(e){return e?Date.UTC(+e[1],e[2]-1,+e[3]):NaN}},"dd/mm/YYYY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{4})$/,parser:function(e){return e?Date.UTC(+e[3],e[2]-1,+e[1]):NaN},alternative:"mm/dd/YYYY"},"mm/dd/YYYY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{4})$/,parser:function(e){return e?Date.UTC(+e[3],e[1]-1,+e[2]):NaN}},"dd/mm/YY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{2})$/,parser:function(e){if(!e)return NaN;var t=+e[3];return t>(new Date).getFullYear()-2e3?t+=1900:t+=2e3,Date.UTC(t,e[2]-1,+e[1])},alternative:"mm/dd/YY"},"mm/dd/YY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{2})$/,parser:function(e){return e?Date.UTC(+e[3]+2e3,e[1]-1,+e[2]):NaN}}},this.init(e,t,r)}return e.prototype.init=function(e,t,r){var i,o=e.decimalPoint;t&&(this.chartOptions=t),r&&(this.chart=r),"."!==o&&","!==o&&(o=void 0),this.options=e,this.columns=e.columns||this.rowsToColumns(e.rows)||[],this.firstRowAsNames=pick(e.firstRowAsNames,this.firstRowAsNames,!0),this.decimalRegex=o&&new RegExp("^(-?[0-9]+)"+o+"([0-9]+)$"),this.rawColumns=[],this.columns.length&&(this.dataFound(),i=!0),this.hasURLOption(e)&&(clearTimeout(this.liveDataTimeout),i=!1),i||(i=this.fetchLiveData()),i||(i=Boolean(this.parseCSV().length)),i||(i=Boolean(this.parseTable().length)),i||(i=this.parseGoogleSpreadsheet()),!i&&e.afterComplete&&e.afterComplete()},e.prototype.hasURLOption=function(e){return Boolean(e&&(e.rowsURL||e.csvURL||e.columnsURL))},e.prototype.getColumnDistribution=function(){var e,t=this.chartOptions,r=this.options,i=[],o=function(e){return(seriesTypes[e||"line"].prototype.pointArrayMap||[0]).length},n=function(e){return seriesTypes[e||"line"].prototype.pointArrayMap},s=t&&t.chart&&t.chart.type,a=[],l=[],u=0,h=r&&r.seriesMapping||t&&t.series&&t.series.map(function(){return{x:0}})||[];(t&&t.series||[]).forEach(function(e){a.push(o(e.type||s))}),h.forEach(function(e){i.push(e.x||0)}),0===i.length&&i.push(0),h.forEach(function(r){var i=new SeriesBuilder,h=a[u]||o(s),d=(t&&t.series||[])[u]||{},m=n(d.type||s),p=m||["y"];for((defined(r.x)||d.isCartesian||!m)&&i.addColumnReader(r.x,"x"),objectEach(r,function(e,t){"x"!==t&&i.addColumnReader(e,t)}),e=0;e<h;e++)i.hasReader(p[e])||i.addColumnReader(void 0,p[e]);l.push(i),u++});var d=n(s);void 0===d&&(d=["y"]),this.valueCount={global:o(s),xColumns:i,individual:a,seriesBuilders:l,globalPointArrayMap:d}},e.prototype.dataFound=function(){this.options.switchRowsAndColumns&&(this.columns=this.rowsToColumns(this.columns)),this.getColumnDistribution(),this.parseTypes(),!1!==this.parsed()&&this.complete()},e.prototype.parseCSV=function(e){var t,r,i,o=this,n=e||this.options,s=n.csv,a=void 0!==n.startRow&&n.startRow?n.startRow:0,l=n.endRow||Number.MAX_VALUE,u=void 0!==n.startColumn&&n.startColumn?n.startColumn:0,h=n.endColumn||Number.MAX_VALUE,d=0,m=[],p={",":0,";":0,"\t":0};function f(e,i,o,n){var s=0,a="",l="",d="",p="",f=0,c=0;function g(t){a=e[t],l=e[t-1],d=e[t+1]}function v(e){m.length<c+1&&m.push([e]),m[c][m[c].length-1]!==e&&m[c].push(e)}function x(){if(u>f||f>h)return++f,void(p="");!isNaN(parseFloat(p))&&isFinite(p)?(p=parseFloat(p),v("number")):isNaN(Date.parse(p))?v("string"):(p=p.replace(/\//g,"-"),v("date")),t.length<c+1&&t.push([]),o||(t[c][i]=p),p="",++c,++f}if(e.trim().length&&"#"!==e.trim()[0]){for(;s<e.length;s++){if(g(s),"#"===a)return void x();if('"'===a)for(g(++s);s<e.length&&('"'!==a||'"'===l||'"'===d);)('"'!==a||'"'===a&&'"'!==l)&&(p+=a),g(++s);else n&&n[a]?n[a](a,p)&&x():a===r?x():p+=a}x()}}if(t=this.columns=[],s&&n.beforeParse&&(s=n.beforeParse.call(this,s)),s){i=s.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(n.lineDelimiter||"\n"),(!a||a<0)&&(a=0),(!l||l>=i.length)&&(l=i.length-1),n.itemDelimiter?r=n.itemDelimiter:(r=null,r=function(e){var t=0,r=0,i=!1;return e.some(function(e,i){var o,n,s,a=!1,l="";if(i>13)return!0;for(var u=0;u<e.length;u++){if(o=e[u],n=e[u+1],s=e[u-1],"#"===o)return;if('"'===o)if(a){if('"'!==s&&'"'!==n){for(;" "===n&&u<e.length;)n=e[++u];void 0!==p[n]&&p[n]++,a=!1}}else a=!0;else void 0!==p[o]?(l=l.trim(),isNaN(Date.parse(l))&&!isNaN(l)&&isFinite(l)||p[o]++,l=""):l+=o;","===o&&r++,"."===o&&t++}}),i=p[";"]>p[","]?";":(p[","],p[";"],","),n.decimalPoint||(n.decimalPoint=t>r?".":",",o.decimalRegex=new RegExp("^(-?[0-9]+)"+n.decimalPoint+"([0-9]+)$")),i}(i));var c=0;for(d=a;d<=l;d++)"#"===i[d][0]?c++:f(i[d],d-a-c);n.columnTypes&&0!==n.columnTypes.length||!m.length||!m[0].length||"date"!==m[0][1]||n.dateFormat||(n.dateFormat=function(e,t){var r,i,s,a=[],l=0,u=!1,h=[],d=[];for((!t||t>e.length)&&(t=e.length);l<t;l++)if(void 0!==e[l]&&e[l]&&e[l].length)for(r=e[l].trim().replace(/\//g," ").replace(/\-/g," ").replace(/\./g," ").split(" "),a=["","",""],s=0;s<r.length;s++)s<a.length&&(r[s]=parseInt(r[s],10),r[s]&&(d[s]=!d[s]||d[s]<r[s]?r[s]:d[s],void 0!==h[s]?h[s]!==r[s]&&(h[s]=!1):h[s]=r[s],r[s]>31?r[s]<100?a[s]="YY":a[s]="YYYY":r[s]>12&&r[s]<=31?(a[s]="dd",u=!0):a[s].length||(a[s]="mm")));if(u){for(s=0;s<h.length;s++)!1!==h[s]?d[s]>12&&"YY"!==a[s]&&"YYYY"!==a[s]&&(a[s]="YY"):d[s]>12&&"mm"===a[s]&&(a[s]="dd");return 3===a.length&&"dd"===a[1]&&"dd"===a[2]&&(a[2]="YY"),i=a.join("/"),(n.dateFormats||o.dateFormats)[i]?i:(fireEvent("deduceDateFailed"),"YYYY/mm/dd")}return"YYYY/mm/dd"}(t[0])),this.dataFound()}return t},e.prototype.parseTable=function(){var e=this.options,t=e.table,r=this.columns||[],i=e.startRow||0,o=e.endRow||Number.MAX_VALUE,n=e.startColumn||0,s=e.endColumn||Number.MAX_VALUE;return t&&("string"==typeof t&&(t=doc.getElementById(t)),[].forEach.call(t.getElementsByTagName("tr"),function(e,t){t>=i&&t<=o&&[].forEach.call(e.children,function(e,o){var a=r[o-n],l=1;if(("TD"===e.tagName||"TH"===e.tagName)&&o>=n&&o<=s)for(r[o-n]||(r[o-n]=[]),r[o-n][t-i]=e.innerHTML;t-i>=l&&void 0===a[t-i-l];)a[t-i-l]=null,l++})}),this.dataFound()),r},e.prototype.fetchLiveData=function(){var e=this,t=this.chart,r=this.options,i=3,o=0,n=r.enablePolling,s=1e3*(r.dataRefreshRate||2),a=merge(r);if(!this.hasURLOption(r))return!1;return s<1e3&&(s=1e3),delete r.csvURL,delete r.rowsURL,delete r.columnsURL,function l(u){function h(a,h,d){if(!a||0!==a.indexOf("http"))return a&&r.error&&r.error("Invalid URL"),!1;function m(){n&&t.liveDataURL===a&&(e.liveDataTimeout=setTimeout(l,s))}return u&&(clearTimeout(e.liveDataTimeout),t.liveDataURL=a),ajax({url:a,dataType:d||"json",success:function(e){t&&t.series&&h(e),m()},error:function(e,t){return++o<i&&m(),r.error&&r.error(t,e)}}),!0}h(a.csvURL,function(e){t.update({data:{csv:e}})},"text")||h(a.rowsURL,function(e){t.update({data:{rows:e}})})||h(a.columnsURL,function(e){t.update({data:{columns:e}})})}(!0),this.hasURLOption(r)},e.prototype.parseGoogleSpreadsheet=function(){var e=this,t=this.options,r=t.googleSpreadsheetKey,i=this.chart,o=t.googleSpreadsheetWorksheet||1,n=t.startRow||0,s=t.endRow||Number.MAX_VALUE,a=t.startColumn||0,l=t.endColumn||Number.MAX_VALUE,u=1e3*(t.dataRefreshRate||2);return u<4e3&&(u=4e3),r&&(delete t.googleSpreadsheetKey,function e(i){var n=["https://spreadsheets.google.com/feeds/cells",r,o,"public/values?alt=json"].join("/");ajax({url:n,dataType:"json",success:function(r){i(r),t.enablePolling&&setTimeout(function(){e(i)},1e3*(t.dataRefreshRate||2))},error:function(e,r){return t.error&&t.error(r,e)}})}(function(t){var r,o,u,h,d,m,p=[],f=t.feed.entry,c=(f||[]).length,g=0,v=0;if(!f||0===f.length)return!1;for(m=0;m<c;m++)r=f[m],g=Math.max(g,r.gs$cell.col),v=Math.max(v,r.gs$cell.row);for(m=0;m<g;m++)m>=a&&m<=l&&(p[m-a]=[]);for(m=0;m<c;m++)u=(r=f[m]).gs$cell.row-1,(h=r.gs$cell.col-1)>=a&&h<=l&&u>=n&&u<=s&&(o=null,(d=r.gs$cell||r.content).numericValue?o=d.$t.indexOf("/")>=0||d.$t.indexOf("-")>=0?d.$t:d.$t.indexOf("%")>0?100*parseFloat(d.numericValue):parseFloat(d.numericValue):d.$t&&d.$t.length&&(o=d.$t),p[h-a][u-n]=o);p.forEach(function(e){for(m=0;m<e.length;m++)void 0===e[m]&&(e[m]=null)}),i&&i.series?i.update({data:{columns:p}}):(e.columns=p,e.dataFound())})),!1},e.prototype.trim=function(e,t){return"string"==typeof e&&(e=e.replace(/^\s+|\s+$/g,""),t&&/^[0-9\s]+$/.test(e)&&(e=e.replace(/\s/g,"")),this.decimalRegex&&(e=e.replace(this.decimalRegex,"$1.$2"))),e},e.prototype.parseTypes=function(){for(var e=this.columns,t=e.length;t--;)this.parseColumn(e[t],t)},e.prototype.parseColumn=function(e,t){var r,i,o,n,s,a,l,u=this.rawColumns,h=this.columns,d=e.length,m=this.firstRowAsNames,p=-1!==this.valueCount.xColumns.indexOf(t),f=[],c=this.chartOptions,g=(this.options.columnTypes||[])[t],v=p&&(c&&c.xAxis&&"category"===splat(c.xAxis)[0].type||"string"===g);for(u[t]||(u[t]=[]);d--;)r=f[d]||e[d],o=this.trim(r),n=this.trim(r,!0),i=parseFloat(n),void 0===u[t][d]&&(u[t][d]=o),v||0===d&&m?e[d]=""+o:+n===i?(e[d]=i,i>31536e6&&"float"!==g?e.isDatetime=!0:e.isNumeric=!0,void 0!==e[d+1]&&(l=i>e[d+1])):(o&&o.length&&(s=this.parseDate(r)),p&&isNumber(s)&&"float"!==g?(f[d]=r,e[d]=s,e.isDatetime=!0,void 0!==e[d+1]&&((a=s>e[d+1])!==l&&void 0!==l&&(this.alternativeFormat?(this.dateFormat=this.alternativeFormat,d=e.length,this.alternativeFormat=this.dateFormats[this.dateFormat].alternative):e.unsorted=!0),l=a)):(e[d]=""===o?null:o,0!==d&&(e.isDatetime||e.isNumeric)&&(e.mixed=!0)));if(p&&e.mixed&&(h[t]=u[t]),p&&l&&this.options.sort)for(t=0;t<h.length;t++)h[t].reverse(),m&&h[t].unshift(h[t].pop())},e.prototype.parseDate=function(e){var t,r,i,o,n=this.options.parseDate,s=this.options.dateFormat||this.dateFormat;if(n)t=n(e);else if("string"==typeof e){if(s)(i=this.dateFormats[s])||(i=this.dateFormats["YYYY/mm/dd"]),(o=e.match(i.regex))&&(t=i.parser(o));else for(r in this.dateFormats)if(i=this.dateFormats[r],o=e.match(i.regex)){this.dateFormat=s=r,this.alternativeFormat=i.alternative,t=i.parser(o);break}o||("object"==typeof(o=Date.parse(e))&&null!==o&&o.getTime?t=o.getTime()-6e4*o.getTimezoneOffset():isNumber(o)&&(t=o-6e4*new Date(o).getTimezoneOffset()))}return t},e.prototype.rowsToColumns=function(e){var t,r,i,o,n;if(e)for(n=[],r=e.length,t=0;t<r;t++)for(o=e[t].length,i=0;i<o;i++)n[i]||(n[i]=[]),n[i][t]=e[t][i];return n},e.prototype.getData=function(){if(this.columns)return this.rowsToColumns(this.columns).slice(1)},e.prototype.parsed=function(){if(this.options.parsed)return this.options.parsed.call(this,this.columns)},e.prototype.getFreeIndexes=function(e,t){var r,i,o,n=[],s=[];for(i=0;i<e;i+=1)n.push(!0);for(r=0;r<t.length;r+=1)for(o=t[r].getReferencedColumnIndexes(),i=0;i<o.length;i+=1)n[o[i]]=!1;for(i=0;i<n.length;i+=1)n[i]&&s.push(i);return s},e.prototype.complete=function(){var e,t,r,i,o,n,s,a,l,u,h,d,m=this.columns,p=this.options,f=[];if(m.length,p.complete||p.afterComplete){if(this.firstRowAsNames)for(i=0;i<m.length;i++)m[i].name=m[i].shift();for(t=[],u=this.getFreeIndexes(m.length,this.valueCount.seriesBuilders),s=0;s<this.valueCount.seriesBuilders.length;s++)(l=this.valueCount.seriesBuilders[s]).populateColumns(u)&&f.push(l);for(;u.length>0;){for((l=new SeriesBuilder).addColumnReader(0,"x"),-1!==(d=u.indexOf(0))&&u.splice(d,1),i=0;i<this.valueCount.global;i++)l.addColumnReader(void 0,this.valueCount.globalPointArrayMap[i]);l.populateColumns(u)&&f.push(l)}if(f.length>0&&f[0].readers.length>0&&void 0!==(h=m[f[0].readers[0].columnIndex])&&(h.isDatetime?e="datetime":h.isNumeric||(e="category")),"category"===e)for(s=0;s<f.length;s++)for(l=f[s],n=0;n<l.readers.length;n++)"x"===l.readers[n].configName&&(l.readers[n].configName="name");for(s=0;s<f.length;s++){for(l=f[s],r=[],o=0;o<m[0].length;o++)r[o]=l.read(m,o);t[s]={data:r},l.name&&(t[s].name=l.name),"category"===e&&(t[s].turboThreshold=0)}a={series:t},e&&(a.xAxis={type:e},"category"===e&&(a.xAxis.uniqueNames=!1)),p.complete&&p.complete(a),p.afterComplete&&p.afterComplete(a)}},e.prototype.update=function(e,t){var r=this.chart;e&&(e.afterComplete=function(e){e&&(e.xAxis&&r.xAxis[0]&&e.xAxis.type===r.xAxis[0].options.type&&delete e.xAxis,r.update(e,t,!0))},merge(!0,r.options.data,e),this.init(r.options.data))},e}();H.data=function(e,t,r){return new H.Data(e,t,r)},addEvent(Chart,"init",function(e){var t=this,r=e.args[0]||{},i=e.args[1];r&&r.data&&!t.hasDataDef&&(t.hasDataDef=!0,t.data=new H.Data(extend(r.data,{afterComplete:function(e){var o,n;if(Object.hasOwnProperty.call(r,"series"))if("object"==typeof r.series)for(o=Math.max(r.series.length,e&&e.series?e.series.length:0);o--;)n=r.series[o]||{},r.series[o]=merge(n,e&&e.series?e.series[o]:{});else delete r.series;r=merge(e,r),t.init(r,i)}}),r,t),e.preventDefault())});var SeriesBuilder=function(){function e(){this.readers=[],this.pointIsArray=!0,this.name=void 0}return e.prototype.populateColumns=function(e){var t=!0;return this.readers.forEach(function(t){void 0===t.columnIndex&&(t.columnIndex=e.shift())}),this.readers.forEach(function(e){void 0===e.columnIndex&&(t=!1)}),t},e.prototype.read=function(e,t){var r,i=this.pointIsArray,o=i?[]:{};return this.readers.forEach(function(r){var n=e[r.columnIndex][t];i?o.push(n):r.configName.indexOf(".")>0?Point.prototype.setNestedProperty(o,n,r.configName):o[r.configName]=n}),void 0===this.name&&this.readers.length>=2&&(r=this.getReferencedColumnIndexes()).length>=2&&(r.shift(),r.sort(function(e,t){return e-t}),this.name=e[r.shift()].name),o},e.prototype.addColumnReader=function(e,t){this.readers.push({columnIndex:e,configName:t}),"x"!==t&&"y"!==t&&void 0!==t&&(this.pointIsArray=!1)},e.prototype.getReferencedColumnIndexes=function(){var e,t,r=[];for(e=0;e<this.readers.length;e+=1)void 0!==(t=this.readers[e]).columnIndex&&r.push(t.columnIndex);return r},e.prototype.hasReader=function(e){var t;for(t=0;t<this.readers.length;t+=1)if(this.readers[t].configName===e)return!0},e}();H.Data=Data;export default H.Data;