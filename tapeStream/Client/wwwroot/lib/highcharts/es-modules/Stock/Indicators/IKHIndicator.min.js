import BaseSeries from"../../Core/Series/Series.js";import Color from"../../Core/Color/Color.js";var color=Color.parse;import H from"../../Core/Globals.js";import U from"../../Core/Utilities.js";var defined=U.defined,isArray=U.isArray,merge=U.merge,objectEach=U.objectEach,SMA=BaseSeries.seriesTypes.sma;function maxHigh(o){return o.reduce(function(o,n){return Math.max(o,n[1])},-1/0)}function minLow(o){return o.reduce(function(o,n){return Math.min(o,n[2])},1/0)}function highlowLevel(o){return{high:maxHigh(o),low:minLow(o)}}function getClosestPointRange(o){var n,e,t,i,a;return o.series.forEach(function(o){if(o.xData)for(i=o.xData,e=o.xIncrement?1:i.length-1,a=e;a>0;a--)t=i[a]-i[a-1],(void 0===n||t<n)&&(n=t)}),n}function checkLineIntersection(o,n,e,t){if(o&&n&&e&&t){var i,a,p=n.plotX-o.plotX,r=n.plotY-o.plotY,l=t.plotX-e.plotX,s=t.plotY-e.plotY,h=o.plotX-e.plotX,c=o.plotY-e.plotY;if(a=(l*c-s*h)/(-l*r+p*s),(i=(-r*h+p*c)/(-l*r+p*s))>=0&&i<=1&&a>=0&&a<=1)return{plotX:o.plotX+a*p,plotY:o.plotY+a*r}}return!1}function drawSenkouSpan(o){var n=o.indicator;n.points=o.points,n.nextPoints=o.nextPoints,n.color=o.color,n.options=merge(o.options.senkouSpan.styles,o.gap),n.graph=o.graph,n.fillGraph=!0,SMA.prototype.drawGraph.call(n)}H.approximations["ichimoku-averages"]=function(){var o,n=[];return[].forEach.call(arguments,function(e,t){n.push(H.approximations.average(e)),o=!o&&void 0===n[t]}),o?void 0:n},BaseSeries.seriesType("ikh","sma",{params:{period:26,periodTenkan:9,periodSenkouSpanB:52},marker:{enabled:!1},tooltip:{pointFormat:'<span style="color:{point.color}">‚óè</span> <b> {series.name}</b><br/>TENKAN SEN: {point.tenkanSen:.3f}<br/>KIJUN SEN: {point.kijunSen:.3f}<br/>CHIKOU SPAN: {point.chikouSpan:.3f}<br/>SENKOU SPAN A: {point.senkouSpanA:.3f}<br/>SENKOU SPAN B: {point.senkouSpanB:.3f}<br/>'},tenkanLine:{styles:{lineWidth:1,lineColor:void 0}},kijunLine:{styles:{lineWidth:1,lineColor:void 0}},chikouLine:{styles:{lineWidth:1,lineColor:void 0}},senkouSpanA:{styles:{lineWidth:1,lineColor:void 0}},senkouSpanB:{styles:{lineWidth:1,lineColor:void 0}},senkouSpan:{styles:{fill:"rgba(255, 0, 0, 0.5)"}},dataGrouping:{approximation:"ichimoku-averages"}},{pointArrayMap:["tenkanSen","kijunSen","chikouSpan","senkouSpanA","senkouSpanB"],pointValKey:"tenkanSen",nameComponents:["periodSenkouSpanB","period","periodTenkan"],init:function(){SMA.prototype.init.apply(this,arguments),this.options=merge({tenkanLine:{styles:{lineColor:this.color}},kijunLine:{styles:{lineColor:this.color}},chikouLine:{styles:{lineColor:this.color}},senkouSpanA:{styles:{lineColor:this.color,fill:color(this.color).setOpacity(.5).get()}},senkouSpanB:{styles:{lineColor:this.color,fill:color(this.color).setOpacity(.5).get()}},senkouSpan:{styles:{fill:color(this.color).setOpacity(.2).get()}}},this.options)},toYData:function(o){return[o.tenkanSen,o.kijunSen,o.chikouSpan,o.senkouSpanA,o.senkouSpanB]},translate:function(){var o=this;SMA.prototype.translate.apply(o),o.points.forEach(function(n){o.pointArrayMap.forEach(function(e){defined(n[e])&&(n["plot"+e]=o.yAxis.toPixels(n[e],!0),n.plotY=n["plot"+e],n.tooltipPos=[n.plotX,n["plot"+e]],n.isNull=!1)})})},drawGraph:function(){var o,n,e,t,i,a,p,r,l,s,h,c,u,S=this,g=S.points,f=g.length,k=S.options,d=S.graph,y=S.color,v={options:{gapSize:k.gapSize}},A=S.pointArrayMap.length,m=[[],[],[],[],[],[]],C={tenkanLine:m[0],kijunLine:m[1],chikouLine:m[2],senkouSpanA:m[3],senkouSpanB:m[4],senkouSpan:m[5]},x=[],Y=S.options.senkouSpan,B=Y.color||Y.styles.fill,P=Y.negativeColor,L=[[],[]],M=[[],[]],w=0;for(S.ikhMap=C;f--;){for(n=g[f],e=0;e<A;e++)o=S.pointArrayMap[e],defined(n[o])&&m[e].push({plotX:n.plotX,plotY:n["plot"+o],isNull:!1});if(P&&f!==g.length-1){var b=C.senkouSpanB.length-1,E=checkLineIntersection(C.senkouSpanA[b-1],C.senkouSpanA[b],C.senkouSpanB[b-1],C.senkouSpanB[b]),N={plotX:E.plotX,plotY:E.plotY,isNull:!1,intersectPoint:!0};E&&(C.senkouSpanA.splice(b,0,N),C.senkouSpanB.splice(b,0,N),x.push(b))}}if(objectEach(C,function(o,n){k[n]&&"senkouSpan"!==n&&(S.points=m[w],S.options=merge(k[n].styles,v),S.graph=S["graph"+n],S.fillGraph=!1,S.color=y,SMA.prototype.drawGraph.call(S),S["graph"+n]=S.graph),w++}),S.graphCollection&&S.graphCollection.forEach(function(o){S[o].destroy(),delete S[o]}),S.graphCollection=[],P&&C.senkouSpanA[0]&&C.senkouSpanB[0]){for(x.unshift(0),x.push(C.senkouSpanA.length-1),c=0;c<x.length-1;c++)if(t=x[c],i=x[c+1],a=C.senkouSpanB.slice(t,i+1),p=C.senkouSpanA.slice(t,i+1),Math.floor(a.length/2)>=1){var j=Math.floor(a.length/2);if(a[j].plotY===p[j].plotY){for(r=0,l=0,u=0;u<a.length;u++)r+=a[u].plotY,l+=p[u].plotY;L[h=r>l?0:1]=L[h].concat(a),M[h]=M[h].concat(p)}else h=a[j].plotY>p[j].plotY?0:1,L[h]=L[h].concat(a),M[h]=M[h].concat(p)}else h=a[0].plotY>p[0].plotY?0:1,L[h]=L[h].concat(a),M[h]=M[h].concat(p);["graphsenkouSpanColor","graphsenkouSpanNegativeColor"].forEach(function(o,n){L[n].length&&M[n].length&&(s=0===n?B:P,drawSenkouSpan({indicator:S,points:L[n],nextPoints:M[n],color:s,options:k,gap:v,graph:S[o]}),S[o]=S.graph,S.graphCollection.push(o))})}else drawSenkouSpan({indicator:S,points:C.senkouSpanB,nextPoints:C.senkouSpanA,color:B,options:k,gap:v,graph:S.graphsenkouSpan}),S.graphsenkouSpan=S.graph;delete S.nextPoints,delete S.fillGraph,S.points=g,S.options=k,S.graph=d},getGraphPath:function(o){var n,e=[],t=[];if(o=o||this.points,this.fillGraph&&this.nextPoints){if((n=SMA.prototype.getGraphPath.call(this,this.nextPoints))&&n.length){n[0][0]="L",e=SMA.prototype.getGraphPath.call(this,o);for(var i=(t=n.slice(0,e.length)).length-1;i>=0;i--)e.push(t[i])}}else e=SMA.prototype.getGraphPath.apply(this,arguments);return e},getValues:function(o,n){var e,t,i,a,p,r,l,s,h,c,u,S=n.period,g=n.periodTenkan,f=n.periodSenkouSpanB,k=o.xData,d=o.yData,y=o.xAxis,v=d&&d.length||0,A=getClosestPointRange(y),m=[],C=[];if(!(k.length<=S)&&isArray(d[0])&&4===d[0].length){for(e=k[0]-S*A,r=0;r<S;r++)C.push(e+r*A);for(r=0;r<v;r++)r>=g&&(l=((i=highlowLevel(d.slice(r-g,r))).high+i.low)/2),r>=S&&(c=(l+(s=((a=highlowLevel(d.slice(r-S,r))).high+a.low)/2))/2),r>=f&&(u=((p=highlowLevel(d.slice(r-f,r))).high+p.low)/2),h=d[r][3],t=k[r],void 0===m[r]&&(m[r]=[]),void 0===m[r+S]&&(m[r+S]=[]),m[r+S][0]=l,m[r+S][1]=s,m[r+S][2]=void 0,m[r][2]=h,r<=S&&(m[r+S][3]=void 0,m[r+S][4]=void 0),void 0===m[r+2*S]&&(m[r+2*S]=[]),m[r+2*S][3]=c,m[r+2*S][4]=u,C.push(t);for(r=1;r<=S;r++)C.push(t+r*A);return{values:m,xData:C,yData:m}}}});