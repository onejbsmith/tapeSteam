import A from"../../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import BaseSeries from"../../Core/Series/Series.js";import H from"../../Core/Globals.js";var noop=H.noop;import Point from"../../Core/Series/Point.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,error=U.error,extend=U.extend,isArray=U.isArray;function arrayExtremesOHLC(e){for(var t,o=e.length,s=e[0][3],a=s,i=1;i<o;i++)(t=e[i][3])<s&&(s=t),t>a&&(a=t);return{min:s,max:a}}var abs=Math.abs,columnPrototype=BaseSeries.seriesTypes.column.prototype;BaseSeries.seriesType("vbp","sma",{params:{ranges:12,volumeSeriesID:"volume"},zoneLines:{enabled:!0,styles:{color:"#0A9AC9",dashStyle:"LongDash",lineWidth:1}},volumeDivision:{enabled:!0,styles:{positiveColor:"rgba(144, 237, 125, 0.8)",negativeColor:"rgba(244, 91, 91, 0.8)"}},animationLimit:1e3,enableMouseTracking:!1,pointPadding:0,zIndex:-1,crisp:!0,dataGrouping:{enabled:!1},dataLabels:{allowOverlap:!0,enabled:!0,format:"P: {point.volumePos:.2f} | N: {point.volumeNeg:.2f}",padding:0,style:{fontSize:"7px"},verticalAlign:"top"}},{nameBase:"Volume by Price",bindTo:{series:!1,eventName:"afterSetExtremes"},calculateOn:"render",markerAttribs:noop,drawGraph:noop,getColumnMetrics:columnPrototype.getColumnMetrics,crispCol:columnPrototype.crispCol,init:function(e){var t,o,s;return H.seriesTypes.sma.prototype.init.apply(this,arguments),t=this.options.params,o=this.linkedParent,s=e.get(t.volumeSeriesID),this.addCustomEvents(o,s),this},addCustomEvents:function(e,t){var o=this;function s(){o.chart.redraw(),o.setData([]),o.zoneStarts=[],o.zoneLinesSVG&&(o.zoneLinesSVG.destroy(),delete o.zoneLinesSVG)}return o.dataEventsToUnbind.push(addEvent(e,"remove",function(){s()})),t&&o.dataEventsToUnbind.push(addEvent(t,"remove",function(){s()})),o},animate:function(e){var t,o,s=this,a=s.chart.inverted,i=s.group,r={};!e&&i&&(t=a?"translateY":"translateX",o=a?s.yAxis.top:s.xAxis.left,i["forceAnimate:"+t]=!0,r[t]=o,i.animate(r,extend(animObject(s.options.animation),{step:function(e,t){s.group.attr({scaleX:Math.max(.001,t.pos)})}})))},drawPoints:function(){this.options.volumeDivision.enabled&&(this.posNegVolume(!0,!0),columnPrototype.drawPoints.apply(this,arguments),this.posNegVolume(!1,!1)),columnPrototype.drawPoints.apply(this,arguments)},posNegVolume:function(e,t){var o,s,a,i,r=t?["positive","negative"]:["negative","positive"],n=this.options.volumeDivision,l=this.points.length,p=[],h=[],u=0;for(e?(this.posWidths=p,this.negWidths=h):(p=this.posWidths,h=this.negWidths);u<l;u++)(i=this.points[u])[r[0]+"Graphic"]=i.graphic,i.graphic=i[r[1]+"Graphic"],e&&(o=i.shapeArgs.width,(a=(s=this.priceZones[u]).wholeVolumeData)?(p.push(o/a*s.positiveVolumeData),h.push(o/a*s.negativeVolumeData)):(p.push(0),h.push(0))),i.color=t?n.styles.positiveColor:n.styles.negativeColor,i.shapeArgs.width=t?this.posWidths[u]:this.negWidths[u],i.shapeArgs.x=t?i.shapeArgs.x:this.posWidths[u]},translate:function(){var e,t,o,s,a,i,r,n,l,p,h,u,d=this,m=d.options,c=d.chart,v=d.yAxis,g=v.min,y=d.options.zoneLines,f=d.priceZones,x=0;columnPrototype.translate.apply(d),(e=d.points).length&&(l=m.pointPadding<.5?m.pointPadding:.1,t=d.volumeDataArray,o=arrayMax(t),s=c.plotWidth/2,p=c.plotTop,a=abs(v.toPixels(g)-v.toPixels(g+d.rangeStep)),r=abs(v.toPixels(g)-v.toPixels(g+d.rangeStep)),l&&(i=abs(a*(1-2*l)),x=abs((a-i)/2),a=abs(i)),e.forEach(function(e,t){h=e.barX=e.plotX=0,u=e.plotY=v.toPixels(f[t].start)-p-(v.reversed?a-r:a)-x,n=correctFloat(s*f[t].wholeVolumeData/o),e.pointWidth=n,e.shapeArgs=d.crispCol.apply(d,[h,u,n,a]),e.volumeNeg=f[t].negativeVolumeData,e.volumePos=f[t].positiveVolumeData,e.volumeAll=f[t].wholeVolumeData}),y.enabled&&d.drawZones(c,v,d.zoneStarts,y.styles))},getValues:function(e,t){var o,s,a=e.processedXData,i=e.processedYData,r=this.chart,n=t.ranges,l=[],p=[],h=[];if(e.chart)if(s=r.get(t.volumeSeriesID)){if(!(o=isArray(i[0]))||4===i[0].length)return(this.priceZones=this.specifyZones(o,a,i,n,s)).forEach(function(e,t){l.push([e.x,e.end]),p.push(l[t][0]),h.push(l[t][1])}),{values:l,xData:p,yData:h};error("Type of "+e.name+" series is different than line, OHLC or candlestick.",!0,r)}else error("Series "+t.volumeSeriesID+" not found! Check `volumeSeriesID`.",!0,r);else error("Base series not found! In case it has been removed, add a new one.",!0,r)},specifyZones:function(e,t,o,s,a){var i,r,n=!!e&&arrayExtremesOHLC(o),l=n?n.min:arrayMin(o),p=n?n.max:arrayMax(o),h=this.zoneStarts=[],u=[],d=0,m=1;if(!l||!p)return this.points.length&&(this.setData([]),this.zoneStarts=[],this.zoneLinesSVG.destroy()),[];for(i=this.rangeStep=correctFloat(p-l)/s,h.push(l);d<s-1;d++)h.push(correctFloat(h[d]+i));for(h.push(p),r=h.length;m<r;m++)u.push({index:m-1,x:t[0],start:h[m-1],end:h[m]});return this.volumePerZone(e,u,a,t,o)},volumePerZone:function(e,t,o,s,a){var i,r,n,l,p,h=this,u=o.processedXData,d=o.processedYData,m=t.length-1,c=a.length,v=d.length;return abs(c-v)&&(s[0]!==u[0]&&d.unshift(0),s[c-1]!==u[v-1]&&d.push(0)),h.volumeDataArray=[],t.forEach(function(t){for(t.wholeVolumeData=0,t.positiveVolumeData=0,t.negativeVolumeData=0,p=0;p<c;p++)r=!1,n=!1,l=e?a[p][3]:a[p],i=p?e?a[p-1][3]:a[p-1]:l,l<=t.start&&0===t.index&&(r=!0),l>=t.end&&t.index===m&&(n=!0),(l>t.start||r)&&(l<t.end||n)&&(t.wholeVolumeData+=d[p],i>l?t.negativeVolumeData+=d[p]:t.positiveVolumeData+=d[p]);h.volumeDataArray.push(t.wholeVolumeData)}),t},drawZones:function(e,t,o,s){var a,i=e.renderer,r=this.zoneLinesSVG,n=[],l=e.plotWidth,p=e.plotTop;o.forEach(function(o){a=t.toPixels(o)-p,n=n.concat(e.renderer.crispLine([["M",0,a],["L",l,a]],s.lineWidth))}),r?r.animate({d:n}):r=this.zoneLinesSVG=i.path(n).attr({"stroke-width":s.lineWidth,stroke:s.color,dashstyle:s.dashStyle,zIndex:this.group.zIndex+.1}).add(this.group)}},{destroy:function(){return this.negativeGraphic&&(this.negativeGraphic=this.negativeGraphic.destroy()),Point.prototype.destroy.apply(this,arguments)}});